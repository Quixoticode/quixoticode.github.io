<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>QSounds v1.3 – RSA Encrypting Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Sharp|Material+Icons+Round" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://quixoticode.github.io/data/qsounds/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="https://quixoticode.github.io/data/qsounds/favicon.svg" />
    <link rel="shortcut icon" href="https://quixoticode.github.io/data/qsounds/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://quixoticode.github.io/data/qsounds/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="QSounds" />
    <link rel="manifest" href="https://quixoticode.github.io/data/qsounds/site.webmanifest" />

    <style>
        :root {
            --font-family-sans: 'Roboto', 'Inter', 'Segoe UI', sans-serif;
            --color-primary: #6200EE;
            --color-primary-variant: #3700B3;
            --color-secondary: #03DAC6;
            --color-secondary-variant: #018786;
            --color-background: #FFFFFF;
            --color-surface: #FFFFFF;
            --color-on-primary: #FFFFFF;
            --color-on-secondary: #000000;
            --color-on-background: #000000;
            --color-on-surface: #000000;
            --color-on-surface-variant: #757575;
            --color-outline: #dbdbdb;
            --color-error: #B00020;
            --color-success: #2E7D32;
            --sidebar-width: 290px;
            --sidebar-bg: #F8F9FA;
            --sidebar-text-color: var(--color-on-surface);
            --sidebar-icon-color: var(--color-on-surface-variant);
            --sidebar-link-hover-bg: #E9ECEF;
            --sidebar-link-active-bg: var(--color-secondary);
            --sidebar-link-active-text: var(--color-on-secondary);
            --sidebar-border-color: #E0E0E0;
            --elevation-1: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --elevation-2: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --elevation-3: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius-small: 8px;
            --border-radius-medium: 16px;
            --border-radius-large: 28px;
            --border-radius-full: 9999px;
        }

        [data-theme="dark"] {
            --color-primary: #BB86FC;
            --color-primary-variant: #6A0DAD;
            --color-secondary: #03DAC6;
            --color-secondary-variant: #03DAC6;
            --color-background: #121212;
            --color-surface: #1E1E1E;
            --color-on-primary: #000000;
            --color-on-secondary: #000000;
            --color-on-background: #FFFFFF;
            --color-on-surface: #FFFFFF;
            --color-on-surface-variant: #BDBDBD;
            --color-outline: #424242;
            --color-error: #CF6679;
            --color-success: #81C784;
            --sidebar-bg: #212121;
            --sidebar-text-color: var(--color-on-surface);
            --sidebar-icon-color: var(--color-on-surface-variant);
            --sidebar-link-hover-bg: #333333;
            --sidebar-link-active-bg: var(--color-secondary);
            --sidebar-link-active-text: var(--color-on-secondary);
            --sidebar-border-color: #303030;
        }

        body { margin: 0; padding: 0; font-family: var(--font-family-sans); background-color: var(--color-background); color: var(--color-on-background); transition: background-color 0.3s, color 0.3s, margin-left 0.3s ease-in-out; overflow-x: hidden; }
        .sidebar-toggle-button { position: fixed; top: 1rem; left: 1rem; z-index: 1050; background-color: var(--color-surface); color: var(--color-primary); border: 1px solid var(--color-outline); cursor: pointer; padding: 0.6rem; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-full); box-shadow: var(--elevation-2); transition: all 0.2s ease; opacity: 1; }
        .sidebar-toggle-button.hidden-when-sidebar-open { opacity: 0; pointer-events: none; }
        .sidebar-toggle-button:hover { background-color: var(--sidebar-link-hover-bg); box-shadow: var(--elevation-3); }
        .sidebar-toggle-button .material-icons, .sidebar-toggle-button .material-icons-outlined { font-size: 26px; }
        .q-sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width); background-color: var(--sidebar-bg); color: var(--sidebar-text-color); padding-top: 1rem; box-shadow: var(--elevation-3); transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; display: flex; flex-direction: column; border-right: 1px solid var(--sidebar-border-color); }
        .q-sidebar.open { transform: translateX(0); }
        .q-sidebar-header { padding: 0.5rem 1rem 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; min-height: 64px; box-sizing: border-box; }
        .logo-title-group { display: flex; align-items: center; gap: 0.75rem;}
        .q-sidebar-header .logo-icon { width: 36px; height: 36px; }
        .q-sidebar-header h2 { margin: 0; font-size: 1.35em; font-weight: 500; color: var(--sidebar-text-color); }
        .sidebar-internal-toggle { background: none; border: none; color: var(--sidebar-icon-color); cursor: pointer; padding: 0.5rem; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-full); }
        .sidebar-internal-toggle:hover { background-color: var(--sidebar-link-hover-bg); color: var(--color-primary); }
        .q-sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 0 0.75rem; }
        .q-sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .q-sidebar-nav li .nav-link { display: flex; align-items: center; padding: 0.8rem 1rem; color: var(--sidebar-text-color); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; border-radius: var(--border-radius-large); margin: 0.3rem 0; font-weight: 500; cursor: pointer; }
        .q-sidebar-nav li .nav-link:hover { background-color: var(--sidebar-link-hover-bg); }
        .q-sidebar-nav li .nav-link.active { background-color: var(--sidebar-link-active-bg); color: var(--sidebar-link-active-text); font-weight: 700; }
        .q-sidebar-nav li .nav-link.active .material-icons { color: var(--sidebar-link-active-text); }
        .q-sidebar-nav li .nav-link .material-icons { margin-right: 1.25rem; color: var(--sidebar-icon-color); font-size: 22px; transition: color 0.2s ease; }
        .q-sidebar-section-title { padding: 1.5rem 1rem 0.5rem 1rem; font-size: 0.8rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.075em; }
        .q-sidebar-footer { padding: 1rem; border-top: 1px solid var(--sidebar-border-color); }
        .content-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .content-overlay.active { opacity: 1; visibility: visible; }
        .qsounds-main-content { margin-left: 0; transition: margin-left 0.3s ease-in-out; padding: 1.5rem; }
        body.sidebar-open .qsounds-main-content { margin-left: var(--sidebar-width); }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1040; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-surface); color: var(--color-on-surface); padding: 1.75rem; border-radius: var(--border-radius-large); box-shadow: var(--elevation-3); min-width: 320px; max-width: 95%; width: 560px; transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-content h2 { color: var(--color-primary); margin-top: 0; margin-bottom: 1rem; font-size: 1.5em; font-weight: 500;}
        .form-field { margin-bottom: 1.25rem; }
        .form-field label { display: block; font-size: 0.9rem; font-weight: 500; color: var(--color-on-surface-variant); margin-bottom: 0.5rem; }
        .textarea-wrapper { position: relative; }
        .clear-textarea-btn { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--color-on-surface-variant); cursor: pointer; border-radius: 99px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s, background-color 0.2s; }
        .textarea-wrapper:hover .clear-textarea-btn, .textarea-wrapper:focus-within .clear-textarea-btn { opacity: 1; }
        .clear-textarea-btn:hover { background-color: var(--sidebar-link-hover-bg); color: var(--color-error); }
        .qs-input, .qs-textarea { background-color: var(--color-surface); color: var(--color-on-surface); border: 1px solid var(--color-outline); border-radius: var(--border-radius-small); padding: 0.9rem 1rem; width: 100%; font-size: 1rem; line-height: 1.5; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .qs-input:focus, .qs-textarea:focus { border-color: var(--color-primary); outline: none; box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 30%, transparent); }
        .qs-button { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; background-color: var(--color-primary); color: var(--color-on-primary); padding: 0.75rem 1.5rem; border-radius: var(--border-radius-full); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.9rem; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--elevation-1); }
        .qs-button:hover:not(:disabled) { background-color: var(--color-primary-variant); box-shadow: var(--elevation-2); }
        .qs-button:disabled { background-color: var(--color-outline); color: var(--color-on-surface-variant); cursor: not-allowed; box-shadow: none; }
        .qs-button .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--color-on-primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { background-color: var(--color-surface); border-radius: var(--border-radius-medium); padding: 1.5rem; box-shadow: var(--elevation-1); transition: box-shadow 0.3s ease-in-out; border: 1px solid transparent; }
        .card.highlight { border-color: var(--color-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 40%, transparent); }
        .card-title { font-size: 1.4em; font-weight: 500; color: var(--color-primary); margin-bottom: 1.25rem; display: flex; align-items: center; }
        .card-title .material-icons { margin-right: 0.75rem; font-size: 1.8rem; }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { background-color: var(--color-surface); color: var(--color-on-surface); padding: 1rem 1.5rem; border-radius: var(--border-radius-medium); box-shadow: var(--elevation-3); display: flex; align-items: center; gap: 1rem; transform: translateX(120%); opacity: 0; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left: 5px solid var(--color-success); }
        .toast.error { border-left: 5px solid var(--color-error); }
        .toast.info { border-left: 5px solid var(--color-primary); }
        .toast .material-icons { color: var(--color-primary); }
        .toast.success .material-icons { color: var(--color-success); }
        .toast.error .material-icons { color: var(--color-error); }
        #qrCodeModal .modal-content { text-align: center; }
        #qrCodeContainer { margin: 1.5rem auto; padding: 1rem; background: white; display: inline-block; }
        #camera-feed, #camera-canvas { max-width: 100%; border-radius: var(--border-radius-medium); }
        @media (max-width: 992px) { 
            body.sidebar-open .qsounds-main-content { margin-left: 0; }
            .qsounds-main-content { padding: 1rem; }
            .q-sidebar { box-shadow: var(--elevation-3); border-right: none; }
        }
    </style>
</head>
<body class="drag-and-drop-container">

    <button class="sidebar-toggle-button" id="sidebarToggle" aria-label="Navigation öffnen/schließen" aria-expanded="false">
        <span class="material-icons-outlined">menu</span>
    </button>
    <nav class="q-sidebar" id="qSoundsSidebar">
        <div class="q-sidebar-header">
            <div class="logo-title-group">
                <img src="https://quixoticode.github.io/data/qsounds/favicon.svg" class="logo-icon" alt="QSounds Logo">
                <h2>QSounds</h2>
            </div>
            <button class="sidebar-internal-toggle" id="sidebarInternalToggle" aria-label="Navigation schließen">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        <div class="q-sidebar-nav">
            <div class="q-sidebar-section-title">Aktionen</div>
            <ul>
                <li><a class="nav-link" href="#" onclick="importKeyPairFile(); closeSidebarAfterAction(); return false;"><span class="material-icons">file_upload</span> Schlüssel importieren</a></li>
                <li><a class="nav-link" href="#" onclick="showQRScanner(); closeSidebarAfterAction(); return false;"><span class="material-icons">qr_code_scanner</span> QR-Code scannen</a></li>
            </ul>
            <div class="q-sidebar-section-title">Einstellungen</div>
            <ul>
                <li><a class="nav-link" href="#" onclick="toggleTheme(); closeSidebarAfterAction(false); return false;"><span class="material-icons">brightness_6</span> Modus wechseln</a></li>
                <li><a class="nav-link" href="#" onclick="showThemePopup(); closeSidebarAfterAction(); return false;"><span class="material-icons">palette</span> Theme Editor</a></li>
            </ul>
        </div>
        <div class="q-sidebar-footer">
             <div class="q-sidebar-section-title" style="padding-top: 0.5rem; padding-bottom: 0.2rem;">Info</div>
             <ul>
                <li><a class="nav-link" href="#" onclick="showCurrentChangelog(); closeSidebarAfterAction(); return false;"><span class="material-icons">article</span> Changelog</a></li>
                <li><a class="nav-link" href="https://github.com/Quixoticode/qsounds" target="_blank" rel="noopener noreferrer"><span class="material-icons">code</span> Quellcode</a></li>
                <li><div class="nav-link !cursor-default !hover:bg-transparent"><span class="material-icons">info</span><span class="app-version font-mono">...</span></div></li>
             </ul>
        </div>
    </nav>
    <div class="content-overlay" id="contentOverlay"></div>

    <main class="qsounds-main-content">
        <header class="app-header text-center mb-8">
            <h1 class="text-4xl font-bold" style="color: var(--color-primary);">QSounds <span class="text-2xl font-normal opacity-80">v<span id="displayed-version">1.3</span></span></h1>
            <p class="text-lg mt-2" style="color: var(--color-on-surface-variant);">Moderne RSA-Verschlüsselung, einfach und sicher.</p>
        </header>

        <div class="space-y-8">
            <section id="keyManagementSection" class="card">
                <h2 class="card-title"><span class="material-icons">vpn_key</span>RSA Schlüsselverwaltung</h2>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="generateKeysButton" class="qs-button">
                        <span class="material-icons">autorenew</span>
                        <span>Generieren (Ctrl+G)</span>
                        <span class="spinner hidden"></span>
                    </button>
                    <button id="saveCurrentKeysButton" class="qs-button" disabled>
                        <span class="material-icons">save</span>
                        <span>Speichern (Ctrl+S)</span>
                    </button>
                    <button id="showQrCodeButton" class="qs-button" disabled>
                        <span class="material-icons">qr_code_2</span>
                        <span>Teilen via QR</span>
                    </button>
                    <button id="exportCurrentKeysButton" class="qs-button" disabled>
                        <span class="material-icons">file_download</span>
                        <span>Exportieren</span>
                    </button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="form-field">
                        <label for="publicKeyOutput">Öffentlicher Schlüssel:</label>
                        <div class="textarea-wrapper">
                            <textarea id="publicKeyOutput" readonly class="qs-textarea font-mono text-xs" rows="8"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('publicKeyOutput', true)" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                        <button onclick="copyToClipboard('publicKeyOutput', 'Öffentlicher Schlüssel')" class="qs-button-text mt-2 text-sm">Kopieren</button>
                    </div>
                    <div class="form-field">
                        <label for="privateKeyOutput">Privater Schlüssel:</label>
                         <div class="textarea-wrapper">
                            <textarea id="privateKeyOutput" readonly class="qs-textarea font-mono text-xs" rows="8"></textarea>
                             <button class="clear-textarea-btn" onclick="clearTextarea('privateKeyOutput', true)" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                        <button onclick="copyToClipboard('privateKeyOutput', 'Privater Schlüssel')" class="qs-button-text mt-2 text-sm">Kopieren</button>
                    </div>
                </div>
            </section>

            <section id="encryptionSection" class="card">
                <h2 class="card-title"><span class="material-icons">lock</span>Verschlüsseln</h2>
                <div class="space-y-6">
                    <div class="form-field">
                        <label for="publicKeyForEncryptInput">Öffentlicher Schlüssel für die Verschlüsselung:</label>
                        <div class="textarea-wrapper">
                           <textarea id="publicKeyForEncryptInput" placeholder="Öffentlichen Schlüssel hier einfügen..." class="qs-textarea key-display-area font-mono text-xs" rows="5"></textarea>
                           <button class="clear-textarea-btn" onclick="clearTextarea('publicKeyForEncryptInput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="textToEncryptInput">Zu verschlüsselnder Text:</label>
                         <div class="textarea-wrapper">
                           <textarea id="textToEncryptInput" placeholder="Geben Sie hier Ihren Klartext ein..." class="qs-textarea" rows="4"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('textToEncryptInput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                    </div>
                    <button id="encryptButton" class="qs-button" disabled>
                        <span class="material-icons">enhanced_encryption</span>
                        <span>Verschlüsseln (Ctrl+E)</span>
                        <span class="spinner hidden"></span>
                    </button>
                    <div class="form-field mt-4">
                        <label for="encryptedOutput">Verschlüsselte Ausgabe (Base64):</label>
                        <div class="textarea-wrapper">
                            <textarea id="encryptedOutput" readonly class="qs-textarea key-display-area font-mono text-xs" rows="5"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('encryptedOutput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                         <button onclick="copyToClipboard('encryptedOutput', 'Verschlüsselter Text')" class="qs-button-text mt-2 text-sm">Kopieren</button>
                    </div>
                </div>
            </section>

            <section id="decryptionSection" class="card">
                <h2 class="card-title"><span class="material-icons">lock_open</span>Entschlüsseln</h2>
                <div class="space-y-6">
                     <div class="form-field">
                        <label for="privateKeyForDecryptInput">Privater Schlüssel für die Entschlüsselung:</label>
                        <div class="textarea-wrapper">
                            <textarea id="privateKeyForDecryptInput" placeholder="Privaten Schlüssel hier einfügen..." class="qs-textarea key-display-area font-mono text-xs" rows="5"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('privateKeyForDecryptInput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="textToDecryptInput">Zu entschlüsselnder Chiffretext (Base64):</label>
                         <div class="textarea-wrapper">
                            <textarea id="textToDecryptInput" placeholder="Base64-kodierten Chiffretext hier einfügen..." class="qs-textarea key-display-area font-mono text-xs" rows="5"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('textToDecryptInput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                    </div>
                    <button id="decryptButton" class="qs-button" disabled>
                        <span class="material-icons">enhanced_encryption</span>
                        <span>Entschlüsseln (Ctrl+D)</span>
                        <span class="spinner hidden"></span>
                    </button>
                    <div class="form-field mt-4">
                        <label for="decryptedOutput">Entschlüsselte Ausgabe:</label>
                        <div class="textarea-wrapper">
                           <textarea id="decryptedOutput" readonly class="qs-textarea" rows="4"></textarea>
                            <button class="clear-textarea-btn" onclick="clearTextarea('decryptedOutput')" title="Leeren"><span class="material-icons text-base">close</span></button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="text-center py-10 mt-8">
            <p class="text-sm" style="color: var(--color-on-surface-variant);">Erstellt mit <span class="material-icons text-sm text-red-500 inline-block align-middle">favorite</span> von <a href="https://github.com/Quixoticode" target="_blank" rel="noopener noreferrer" class="font-medium hover:underline" style="color: var(--color-primary);">Quixoticode</a></p>
        </footer>
    </main>
    
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="changelogModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="flex items-center"><span class="material-icons-outlined mr-3">campaign</span>Neues in Version <span id="current-version-modal">1.3</span></h2>
            <div id="changelog-content" class="text-sm space-y-3 my-6 max-h-80 overflow-y-auto pr-2"></div>
            <div class="flex justify-end">
                <button onclick="closeModal('changelogModal', true)" class="qs-button">Verstanden</button>
            </div>
        </div>
    </div>
    <div id="themePopup" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="flex items-center"><span class="material-icons-outlined mr-3">palette</span>Theme Editor</h2>
            <div class="space-y-5 my-6">
                 <div><label for="primaryColor">Primärfarbe (Buttons, Titel)</label><input type="color" id="primaryColor" class="w-full h-12 border-none rounded-lg"></div>
                 <div><label for="secondaryColor">Sekundärfarbe (Aktive Links)</label><input type="color" id="secondaryColor" class="w-full h-12 border-none rounded-lg"></div>
            </div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('themePopup')" class="qs-button-text">Abbrechen</button><button onclick="saveTheme()" class="qs-button">Speichern</button></div>
        </div>
    </div>
    <div id="customPromptModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="promptTitle">Titel</h2>
            <p id="promptMessage" class="my-4 text-sm" style="color: var(--color-on-surface-variant);"></p>
            <input type="text" id="promptInput" class="qs-input w-full">
            <div class="flex justify-end gap-3 mt-6">
                <button id="promptCancel" class="qs-button-text">Abbrechen</button>
                <button id="promptConfirm" class="qs-button">OK</button>
            </div>
        </div>
    </div>
    <div id="qrCodeModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="qrCodeModalTitle" class="flex items-center justify-center"></h2>
            <div id="qrCodeContainer"></div>
            <p class="text-xs mt-2" style="color: var(--color-on-surface-variant);">Scanne diesen Code, um das Schlüsselpaar zu importieren.</p>
            <div class="flex justify-center mt-6"><button onclick="closeModal('qrCodeModal')" class="qs-button">Schließen</button></div>
        </div>
    </div>
    <div id="qrScannerModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="flex items-center justify-center"><span class="material-icons mr-2">qr_code_scanner</span>QR-Code Scanner</h2>
            <div id="camera-container" class="my-4 bg-gray-800 rounded-lg overflow-hidden">
                <video id="camera-feed" playsinline class="w-full"></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
            </div>
            <p id="scanner-status" class="text-center text-sm" style="color: var(--color-on-surface-variant);">Richte die Kamera auf einen QSounds QR-Code.</p>
            <div class="flex justify-center mt-6"><button onclick="closeModal('qrScannerModal')" class="qs-button">Abbrechen</button></div>
        </div>
    </div>


    <script>
        // --- DOM Element Cache ---
        const getEl = (id) => document.getElementById(id);
        const DOMElements = {
            sidebar: getEl('qSoundsSidebar'),
            sidebarToggle: getEl('sidebarToggle'),
            sidebarInternalToggle: getEl('sidebarInternalToggle'),
            contentOverlay: getEl('contentOverlay'),
            publicKeyOutput: getEl('publicKeyOutput'),
            privateKeyOutput: getEl('privateKeyOutput'),
            generateKeysButton: getEl('generateKeysButton'),
            saveCurrentKeysButton: getEl('saveCurrentKeysButton'),
            exportCurrentKeysButton: getEl('exportCurrentKeysButton'),
            showQrCodeButton: getEl('showQrCodeButton'),
            textToEncryptInput: getEl('textToEncryptInput'),
            publicKeyForEncryptInput: getEl('publicKeyForEncryptInput'),
            encryptButton: getEl('encryptButton'),
            encryptedOutput: getEl('encryptedOutput'),
            textToDecryptInput: getEl('textToDecryptInput'),
            privateKeyForDecryptInput: getEl('privateKeyForDecryptInput'),
            decryptButton: getEl('decryptButton'),
            decryptedOutput: getEl('decryptedOutput'),
            changelogModal: getEl('changelogModal'),
            changelogContentEl: getEl('changelog-content'),
            currentVersionModalSpan: getEl('current-version-modal'),
            displayedVersionSpan: getEl('displayed-version'),
            themePopup: getEl('themePopup'),
            primaryColorInput: getEl('primaryColor'),
            secondaryColorInput: getEl('secondaryColor'),
            toastContainer: getEl('toast-container'),
            qrCodeModal: getEl('qrCodeModal'),
            qrCodeContainer: getEl('qrCodeContainer'),
            qrCodeModalTitle: getEl('qrCodeModalTitle'),
            qrScannerModal: getEl('qrScannerModal'),
            cameraFeed: getEl('camera-feed'),
            cameraCanvas: getEl('camera-canvas'),
            scannerStatus: getEl('scanner-status'),
        };

        // --- App State & Constants ---
        const APP_VERSION = '1.3';
        const STORAGE_PREFIX = 'QSounds_v1_3_';
        const KEYS = {
            LAST_SEEN_VERSION: `${STORAGE_PREFIX}lastSeenVersion`,
            STORED_KEYS: `${STORAGE_PREFIX}storedKeys`,
            THEME_COLORS: `${STORAGE_PREFIX}themeColors`,
            THEME_PREFERENCE: `${STORAGE_PREFIX}themePreference`,
            SIDEBAR_STATE: `${STORAGE_PREFIX}sidebarState`
        };
        let rsa = new JSEncrypt({ default_key_size: 2048 });
        let qrCodeInstance = null;
        let cameraStream = null;

        // --- Changelog ---
        const changelogHTML = `
            <h3 class="font-bold text-lg" style="color: var(--color-primary);"><span class="material-icons-outlined align-bottom mr-1">sparkles</span>Komplett überarbeitete UX/UI</h3>
            <ul class="list-disc list-inside space-y-2 text-sm pl-2" style="color: var(--color-on-surface-variant);">
                <li><b>Modernes Design:</b> Die gesamte Oberfläche wurde aufgeräumt und modernisiert für eine bessere Übersicht.</li>
                <li><b>Smarte Benachrichtigungen:</b> Statt alter Pop-ups gibt es jetzt elegante "Toast"-Nachrichten.</li>
                <li><b>Visuelles Feedback:</b> Buttons zeigen Lade-Spinner und werden deaktiviert, wenn Aktionen nicht möglich sind.</li>
                <li><b>Neue Dialogfenster:</b> Alle Abfragen (z.B. für Namen) nutzen jetzt schönere, ins Design integrierte Modals.</li>
                <li><b>Drag & Drop:</b> Importiere Schlüsseldateien (.qsnd), indem du sie einfach ins Fenster ziehst.</li>
            </ul>

            <h3 class="font-bold text-lg mt-4" style="color: var(--color-primary);"><span class="material-icons-outlined align-bottom mr-1">qr_code_2</span>QR-Code Sharing & Scanning</h3>
            <ul class="list-disc list-inside space-y-2 text-sm pl-2" style="color: var(--color-on-surface-variant);">
                <li><b>Schlüssel via QR-Code teilen:</b> Erzeuge einen QR-Code für dein komplettes Schlüsselpaar und teile es so blitzschnell.</li>
                <li><b>Kamera-Scan:</b> Nutze die Kamera deines Geräts, um Schlüsselpaare von einem QR-Code zu importieren.</li>
            </ul>

            <h3 class="font-bold text-lg mt-4" style="color: var(--color-primary);"><span class="material-icons-outlined align-bottom mr-1">keyboard_alt</span>Tastenkombinationen für den Desktop</h3>
            <ul class="list-disc list-inside space-y-2 text-sm pl-2" style="color: var(--color-on-surface-variant);">
                <li><b>Ctrl/Cmd + G:</b> Neues Schlüsselpaar generieren.</li>
                <li><b>Ctrl/Cmd + S:</b> Aktuelles Schlüsselpaar speichern.</li>
                <li><b>Ctrl/Cmd + E:</b> Text verschlüsseln.</li>
                <li><b>Ctrl/Cmd + D:</b> Text entschlüsseln.</li>
                <li><b>Escape:</b> Schließt alle offenen Fenster.</li>
            </ul>
        `;

        // --- Core App Logic ---
        function generateRSAKeyPair() {
            toggleButtonLoading(DOMElements.generateKeysButton, true);
            showToast('info', 'Generiere 2048-bit Schlüsselpaar... das kann einen Moment dauern.');
            
            setTimeout(() => {
                try {
                    rsa = new JSEncrypt({ default_key_size: 2048 });
                    const privateKey = rsa.getPrivateKey();
                    const publicKey = rsa.getPublicKey();

                    DOMElements.publicKeyOutput.value = publicKey;
                    DOMElements.privateKeyOutput.value = privateKey;
                    
                    // Pre-fill corresponding fields
                    DOMElements.publicKeyForEncryptInput.value = publicKey;
                    DOMElements.privateKeyForDecryptInput.value = privateKey;

                    showToast('success', 'Neues Schlüsselpaar erfolgreich generiert!');
                    updateButtonStates();
                    highlightCard('keyManagementSection');
                } catch (error) {
                    showToast('error', 'Fehler beim Generieren der Schlüssel.');
                    console.error("RSA Generation Error:", error);
                } finally {
                    toggleButtonLoading(DOMElements.generateKeysButton, false);
                }
            }, 50); // Timeout allows UI to update before blocking task
        }

        function encryptRSA() {
            toggleButtonLoading(DOMElements.encryptButton, true);
            setTimeout(() => {
                try {
                    const plainText = DOMElements.textToEncryptInput.value;
                    const publicKey = DOMElements.publicKeyForEncryptInput.value;
                    
                    const encryptor = new JSEncrypt();
                    encryptor.setPublicKey(publicKey);
                    const ciphertext = encryptor.encrypt(plainText);

                    if (ciphertext) {
                        DOMElements.encryptedOutput.value = ciphertext;
                        showToast('success', 'Text erfolgreich verschlüsselt.');
                        highlightCard('encryptionSection');
                        DOMElements.encryptedOutput.select();
                    } else {
                        DOMElements.encryptedOutput.value = '';
                        showToast('error', 'Verschlüsselung fehlgeschlagen. Ist der öffentliche Schlüssel gültig?');
                    }
                } catch (error) {
                    DOMElements.encryptedOutput.value = '';
                    showToast('error', `Verschlüsselungsfehler: ${error.message}`);
                } finally {
                    toggleButtonLoading(DOMElements.encryptButton, false);
                    updateButtonStates();
                }
            }, 50);
        }

        function decryptRSA() {
            toggleButtonLoading(DOMElements.decryptButton, true);
            setTimeout(() => {
                try {
                    const ciphertext = DOMElements.textToDecryptInput.value;
                    const privateKey = DOMElements.privateKeyForDecryptInput.value;
                    
                    const decryptor = new JSEncrypt();
                    decryptor.setPrivateKey(privateKey);
                    const plaintext = decryptor.decrypt(ciphertext);

                    if (plaintext) {
                        DOMElements.decryptedOutput.value = plaintext;
                        showToast('success', 'Text erfolgreich entschlüsselt.');
                        highlightCard('decryptionSection');
                    } else {
                        DOMElements.decryptedOutput.value = '';
                        showToast('error', 'Entschlüsselung fehlgeschlagen. Ist der private Schlüssel korrekt?');
                    }
                } catch (error) {
                    DOMElements.decryptedOutput.value = '';
                    showToast('error', `Entschlüsselungsfehler: ${error.message}.`);
                } finally {
                    toggleButtonLoading(DOMElements.decryptButton, false);
                    updateButtonStates();
                }
            }, 50);
        }

        // --- UI & UX Functions ---
        function showToast(type = 'info', message, duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const iconMap = { 'success': 'check_circle', 'error': 'error', 'info': 'info' };
            toast.innerHTML = `<span class="material-icons">${iconMap[type]}</span><span>${message}</span>`;
            
            DOMElements.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function toggleButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('span:not(.spinner)');
            const spinnerSpan = button.querySelector('.spinner');
            if (isLoading) {
                button.disabled = true;
                textSpan.classList.add('hidden');
                spinnerSpan.classList.remove('hidden');
            } else {
                button.disabled = false;
                textSpan.classList.remove('hidden');
                spinnerSpan.classList.add('hidden');
            }
        }

        function updateButtonStates() {
            const hasKeys = DOMElements.publicKeyOutput.value && DOMElements.privateKeyOutput.value;
            DOMElements.saveCurrentKeysButton.disabled = !hasKeys;
            DOMElements.exportCurrentKeysButton.disabled = !hasKeys;
            DOMElements.showQrCodeButton.disabled = !hasKeys;

            const canEncrypt = DOMElements.textToEncryptInput.value && DOMElements.publicKeyForEncryptInput.value;
            DOMElements.encryptButton.disabled = !canEncrypt;

            const canDecrypt = DOMElements.textToDecryptInput.value && DOMElements.privateKeyForDecryptInput.value;
            DOMElements.decryptButton.disabled = !canDecrypt;
        }

        function copyToClipboard(elementId, type) {
            const textarea = getEl(elementId);
            if (!textarea.value) { showToast('error', `${type} ist leer.`); return; }
            textarea.select();
            document.execCommand('copy');
            window.getSelection()?.removeAllRanges();
            showToast('success', `${type} in Zwischenablage kopiert!`);
        }
        
        function clearTextarea(elementId, updateFields = false) {
            const textarea = getEl(elementId);
            textarea.value = '';
            if (updateFields) {
                if (elementId === 'publicKeyOutput') DOMElements.publicKeyForEncryptInput.value = '';
                if (elementId === 'privateKeyOutput') DOMElements.privateKeyForDecryptInput.value = '';
            }
            updateButtonStates();
        }

        function highlightCard(cardId) {
            const card = getEl(cardId);
            card.classList.add('highlight');
            setTimeout(() => card.classList.remove('highlight'), 1500);
        }

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const isOpen = DOMElements.sidebar.classList.toggle('open');
            DOMElements.contentOverlay.classList.toggle('active', isOpen);
            document.body.classList.toggle('sidebar-open', isOpen);
            DOMElements.sidebarToggle.setAttribute('aria-expanded', isOpen);
            DOMElements.sidebarToggle.classList.toggle('hidden-when-sidebar-open', isOpen);
            localStorage.setItem(KEYS.SIDEBAR_STATE, isOpen ? 'open' : 'closed');
        }

        function closeSidebarAfterAction(shouldScrollToTop = true) {
            if (DOMElements.sidebar.classList.contains('open') && window.innerWidth <= 992) {
                toggleSidebar();
            }
        }

        // --- Modal Logic ---
        function openModal(modalId) {
            const modal = getEl(modalId);
            if (modal) {
                modal.classList.add('visible');
            }
        }

        function closeModal(modalId, markAsSeen = false) {
            const modal = getEl(modalId);
            if (modal) {
                modal.classList.remove('visible');
                if (modalId === 'changelogModal' && markAsSeen) {
                    localStorage.setItem(KEYS.LAST_SEEN_VERSION, APP_VERSION);
                }
                if (modalId === 'qrScannerModal') {
                    stopCamera();
                }
            }
        }
        
        async function customPrompt({ title, message, initialValue = '' }) {
            return new Promise((resolve) => {
                getEl('promptTitle').textContent = title;
                getEl('promptMessage').textContent = message;
                const input = getEl('promptInput');
                input.value = initialValue;
                openModal('customPromptModal');
                
                const confirmHandler = () => {
                    cleanup();
                    resolve(input.value);
                };
                
                const cancelHandler = () => {
                    cleanup();
                    resolve(null);
                };
                
                const keydownHandler = (e) => {
                    if (e.key === 'Enter') confirmHandler();
                    if (e.key === 'Escape') cancelHandler();
                };

                const confirmBtn = getEl('promptConfirm');
                const cancelBtn = getEl('promptCancel');
                
                confirmBtn.onclick = confirmHandler;
                cancelBtn.onclick = cancelHandler;
                input.onkeydown = keydownHandler;
                
                input.focus();
                input.select();
                
                function cleanup() {
                    closeModal('customPromptModal');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    input.onkeydown = null;
                }
            });
        }
        
        // --- QR Code Logic ---
        function showQRCodeForCurrentKeys() {
            const pubKey = DOMElements.publicKeyOutput.value;
            const privKey = DOMElements.privateKeyOutput.value;
            if (!pubKey || !privKey) {
                showToast('error', 'Kein Schlüsselpaar zum Teilen vorhanden.');
                return;
            }
            
            const keyPairObject = { type: 'QSoundsKeyPair', pub: pubKey, priv: privKey };
            const jsonString = JSON.stringify(keyPairObject);

            DOMElements.qrCodeContainer.innerHTML = '';
            qrCodeInstance = new QRCode(DOMElements.qrCodeContainer, {
                text: jsonString,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L // Low correction level for max data
            });

            DOMElements.qrCodeModalTitle.innerHTML = `<span class="material-icons mr-2">qr_code_2</span>Schlüsselpaar teilen`;
            openModal('qrCodeModal');
        }

        function showQRScanner() {
            openModal('qrScannerModal');
            startCamera();
        }

        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        cameraStream = stream;
                        DOMElements.cameraFeed.srcObject = stream;
                        DOMElements.cameraFeed.play();
                        requestAnimationFrame(scanQRCode);
                        DOMElements.scannerStatus.textContent = "Kamera aktiv. Suche nach QR-Code...";
                    })
                    .catch(err => {
                        console.error("Camera Error:", err);
                        DOMElements.scannerStatus.textContent = "Kamera-Zugriff fehlgeschlagen.";
                        showToast('error', 'Konnte nicht auf die Kamera zugreifen.');
                    });
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                DOMElements.cameraFeed.srcObject = null;
            }
        }

        function scanQRCode() {
            if (cameraStream && DOMElements.cameraFeed.readyState === DOMElements.cameraFeed.HAVE_ENOUGH_DATA) {
                const canvas = DOMElements.cameraCanvas;
                const video = DOMElements.cameraFeed;
                const ctx = canvas.getContext('2d');
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    DOMElements.scannerStatus.textContent = "Code gefunden! Verarbeite...";
                    try {
                        const data = JSON.parse(code.data);
                        if (data.type === 'QSoundsKeyPair' && data.pub && data.priv) {
                            handleImportedKeyPairData({
                                name: `QR Import ${new Date().toLocaleTimeString('de-DE')}`,
                                publicKey: data.pub,
                                privateKey: data.priv
                            });
                            closeModal('qrScannerModal');
                            showToast('success', 'Schlüsselpaar erfolgreich via QR-Code importiert!');
                        } else {
                            DOMElements.scannerStatus.textContent = "Kein gültiger QSounds-Code.";
                            setTimeout(() => DOMElements.scannerStatus.textContent = "Suche nach QR-Code...", 2000);
                        }
                    } catch (e) {
                        DOMElements.scannerStatus.textContent = "Code konnte nicht gelesen werden.";
                         setTimeout(() => DOMElements.scannerStatus.textContent = "Suche nach QR-Code...", 2000);
                    }
                }
            }
            if (cameraStream) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // --- Data Import/Export ---
        async function saveCurrentKeyPair() {
            const pubKey = DOMElements.publicKeyOutput.value;
            const privKey = DOMElements.privateKeyOutput.value;

            const name = await customPrompt({
                title: 'Schlüsselpaar speichern',
                message: 'Geben Sie eine eindeutige Bezeichnung für dieses Schlüsselpaar ein:',
                initialValue: `Mein Schlüssel ${new Date().toLocaleDateString('de-DE')}`
            });

            if (!name) { showToast('info', 'Speichern abgebrochen.'); return; }

            // This is a placeholder for a more advanced storage system (e.g., indexedDB)
            // For now, it just demonstrates the flow. A real implementation would save to a persistent store.
             handleImportedKeyPairData({ name, publicKey: pubKey, privateKey: privKey });
             showToast('success', `Schlüsselpaar "${name}" wurde simuliert gespeichert.`);
        }
        
        function handleImportedKeyPairData(keyData) {
            // This function would typically save to a persistent store (e.g., IndexedDB)
            // and update a list in the UI. For this example, we just load it.
            DOMElements.publicKeyOutput.value = keyData.publicKey;
            DOMElements.privateKeyOutput.value = keyData.privateKey;
            DOMElements.publicKeyForEncryptInput.value = keyData.publicKey;
            DOMElements.privateKeyForDecryptInput.value = keyData.privateKey;
            updateButtonStates();
            showToast('success', `Schlüsselpaar "${keyData.name}" geladen/importiert.`);
            highlightCard('keyManagementSection');
        }

        function exportDataToFile(dataObject, baseFilename, extension) {
            const blob = new Blob([JSON.stringify(dataObject, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${baseFilename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.${extension}`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function exportCurrentKeyPairData() {
            const pubKey = DOMElements.publicKeyOutput.value;
            const privKey = DOMElements.privateKeyOutput.value;
            const data = {
                type: "QSoundsKeyPair",
                timestamp: new Date().toISOString(),
                version: APP_VERSION,
                pub: pubKey,
                priv: privKey,
            };
            exportDataToFile(data, "qsounds_keypair_export", "qsnd");
            showToast('success', 'Schlüsselpaar als .qsnd Datei exportiert.');
        }

        function importKeyPairFile() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".qsnd,.json";
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const fileText = await file.text();
                    const data = JSON.parse(fileText);
                    if (data.type === 'QSoundsKeyPair' && data.pub && data.priv) {
                         handleImportedKeyPairData({
                            name: file.name.replace(/\.[^/.]+$/, ""), // use filename as name
                            publicKey: data.pub,
                            privateKey: data.priv
                         });
                    } else {
                        showToast('error', "Ungültige QSounds Schlüsseldatei.");
                    }
                } catch (err) {
                    showToast('error', "Fehler beim Lesen der Importdatei.");
                    console.error("Import Error:", err);
                }
            };
            input.click();
        }
        
        // --- Theme Management ---
        function applyThemeColors(primary, secondary) {
            document.documentElement.style.setProperty('--color-primary', primary);
            document.documentElement.style.setProperty('--color-secondary', secondary);
            DOMElements.primaryColorInput.value = primary;
            DOMElements.secondaryColorInput.value = secondary;
        }

        function saveTheme() {
            const primary = DOMElements.primaryColorInput.value;
            const secondary = DOMElements.secondaryColorInput.value;
            applyThemeColors(primary, secondary);
            localStorage.setItem(KEYS.THEME_COLORS, JSON.stringify({ primary, secondary }));
            closeModal('themePopup');
            showToast('success', 'Neues Theme gespeichert!');
        }
        
        function showThemePopup() { openModal('themePopup'); }

        function loadSavedTheme() {
            const theme = localStorage.getItem(KEYS.THEME_COLORS);
            const defaultPrimary = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
            const defaultSecondary = getComputedStyle(document.documentElement).getPropertyValue('--color-secondary').trim();
            if (theme) {
                try {
                    const { primary, secondary } = JSON.parse(theme);
                    applyThemeColors(primary, secondary);
                } catch (e) {
                    applyThemeColors(defaultPrimary, defaultSecondary);
                }
            } else {
                applyThemeColors(defaultPrimary, defaultSecondary);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute("data-theme");
            const newTheme = currentTheme === "light" ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem(KEYS.THEME_PREFERENCE, newTheme);
            loadSavedTheme(); // Reload to apply potentially different dark/light variants
        }

        function loadThemePreference() {
            const preferredTheme = localStorage.getItem(KEYS.THEME_PREFERENCE) || "light";
            document.documentElement.setAttribute("data-theme", preferredTheme);
            loadSavedTheme();
        }
        
        // --- Initialization and Event Listeners ---
        function initializeApp() {
            DOMElements.displayedVersionSpan.textContent = APP_VERSION;
            DOMElements.currentVersionModalSpan.textContent = APP_VERSION;
            DOMElements.changelogContentEl.innerHTML = changelogHTML;

            loadThemePreference();
            updateButtonStates();
            
            // Show changelog on first visit of new version
            const lastSeenVersion = localStorage.getItem(KEYS.LAST_SEEN_VERSION);
            if (lastSeenVersion !== APP_VERSION) {
                openModal('changelogModal');
            }

            // Restore sidebar state
            const sidebarState = localStorage.getItem(KEYS.SIDEBAR_STATE);
            if (sidebarState === 'open' && window.innerWidth > 992) {
                DOMElements.sidebar.classList.add('open');
                DOMElements.sidebarToggle.classList.add('hidden-when-sidebar-open');
                document.body.classList.add('sidebar-open');
            }
            
            // Set up event listeners
            DOMElements.sidebarToggle.addEventListener('click', toggleSidebar);
            DOMElements.sidebarInternalToggle.addEventListener('click', toggleSidebar);
            DOMElements.contentOverlay.addEventListener('click', toggleSidebar);
            DOMElements.generateKeysButton.addEventListener('click', generateRSAKeyPair);
            DOMElements.saveCurrentKeysButton.addEventListener('click', saveCurrentKeyPair);
            DOMElements.exportCurrentKeysButton.addEventListener('click', exportCurrentKeyPairData);
            DOMElements.showQrCodeButton.addEventListener('click', showQRCodeForCurrentKeys);
            DOMElements.encryptButton.addEventListener('click', encryptRSA);
            DOMElements.decryptButton.addEventListener('click', decryptRSA);

            // Add input listeners for real-time button state updates
            ['input', 'change'].forEach(evt => {
                [DOMElements.publicKeyOutput, DOMElements.privateKeyOutput, DOMElements.textToEncryptInput, DOMElements.publicKeyForEncryptInput, DOMElements.textToDecryptInput, DOMElements.privateKeyForDecryptInput].forEach(el => {
                    el.addEventListener(evt, updateButtonStates);
                });
            });

            // Keyboard shortcuts
            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    // Close any open modal
                    document.querySelectorAll('.modal-backdrop.visible').forEach(modal => closeModal(modal.id));
                }
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'g': e.preventDefault(); DOMElements.generateKeysButton.click(); break;
                        case 's': e.preventDefault(); if(!DOMElements.saveCurrentKeysButton.disabled) DOMElements.saveCurrentKeysButton.click(); break;
                        case 'e': e.preventDefault(); if(!DOMElements.encryptButton.disabled) DOMElements.encryptButton.click(); break;
                        case 'd': e.preventDefault(); if(!DOMElements.decryptButton.disabled) DOMElements.decryptButton.click(); break;
                    }
                }
            });

            // Drag and Drop
            const dropContainer = document.body;
            dropContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropContainer.style.backgroundColor = 'var(--color-primary-variant)'; });
            dropContainer.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropContainer.style.backgroundColor = ''; });
            dropContainer.addEventListener('drop', (e) => {
                e.preventDefault(); e.stopPropagation();
                dropContainer.style.backgroundColor = '';
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const fakeEvent = { target: { files: e.dataTransfer.files } };
                    getEl('__tempFileInput').onchange(fakeEvent); // Reuse logic
                }
            });

            // Create a hidden file input to reuse the import logic for drag-and-drop
            const hiddenInput = document.createElement('input');
            hiddenInput.id = '__tempFileInput';
            hiddenInput.type = 'file';
            hiddenInput.accept = ".qsnd,.json";
            hiddenInput.style.display = 'none';
            hiddenInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const fileText = await file.text();
                    const data = JSON.parse(fileText);
                    if (data.type === 'QSoundsKeyPair' && data.pub && data.priv) {
                         handleImportedKeyPairData({
                            name: file.name.replace(/\.[^/.]+$/, ""),
                            publicKey: data.pub,
                            privateKey: data.priv
                         });
                    } else {
                        showToast('error', "Ungültige QSounds Schlüsseldatei.");
                    }
                } catch (err) { showToast('error', "Fehler beim Lesen der Importdatei."); }
                hiddenInput.value = ''; // Reset for next use
            };
            document.body.appendChild(hiddenInput);

            showToast('info', `Willkommen zu QSounds v${APP_VERSION}!`, 2000);
        }

        function showCurrentChangelog() {
            openModal('changelogModal');
        }

        // --- App Start ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
    <script type="module" src="https://quixoticode.github.io/common/version-loader.js"></script>
</body>
</html>
