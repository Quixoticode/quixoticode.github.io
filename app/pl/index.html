<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet's Life</title> <!-- Titel ge√§ndert -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://quixoticode.github.io/data/pl/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="https://quixoticode.github.io/data/pl/favicon.svg" />
    <link rel="shortcut icon" href="https://quixoticode.github.io/data/pl/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://quixoticode.github.io/data/pl/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Pet's Life" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="https://quixoticode.github.io/data/pl/site.webmanifest" />

    <style>
        :root {
            --bg-color: #e0f2fe; /* Heller Himmelblau */
            --card-bg-color: white;
            --text-color-primary: #0c4a6e; /* Dunkleres Blau */
            --text-color-secondary: #374151;
            --text-color-accent: #0ea5e9; /* Akzentfarbe Himmelblau */
            --button-bg-color: #0ea5e9;
            --button-text-color: white;
            --button-hover-bg-color: #0284c7;
            --room-wall-color: #f0f9ff;
            --room-floor-color: #dbeafe;
            --room-window-frame-color: #a16207;
            --room-window-glass-color: #cffafe;
            --room-window-glass-night-color: #3e5265;
            --livingroom-wall-color: #fef9c3;
            --livingroom-floor-color: #fde68a;
            --livingroom-plant-pot-color: #78350f;
            --livingroom-plant-leaf-color: #16a34a;
            --status-bar-track-color: #e5e7eb;
            --status-bar-energy-fill: #22c55e;
            --status-bar-hunger-fill: #f97316;
            --status-bar-mood-fill: #3b82f6;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: white;
            --worm-color: #a16207;
            --worm-segment-border: #713f12;
            --game-area-border: #94a3b8;
            --personality-text-color: #059669;
            --flight-game-obstacle-color: #78716c;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-md-color: rgba(0, 0, 0, 0.07);
            --bed-standard-blanket-color: #a16207;
            --bed-comfy-blanket-color: #065f46;
            --bed-wood-color: #8B4513;
            --accessory-hat-color: #ef4444; /* Red for a simple hat */
            --quest-item-bg: #f9fafb;
            --quest-item-border: #e5e7eb;
            --quest-progress-bg: #d1fae5;
            --quest-progress-fill: #10b981;
            --sky-day-color: #87CEEB;
            --sky-night-color: #00102c;
            --star-color: white;
            --water-color: #77C5D5;
            --error-text-color: #ef4444; /* Red for error messages */
        }

        .dark-mode:root {
            --bg-color: #0f172a;
            --card-bg-color: #1e293b;
            --text-color-primary: #e0f2fe;
            --text-color-secondary: #94a3b8;
            --text-color-accent: #38bdf8;
            --button-bg-color: #38bdf8;
            --button-text-color: #0f172a;
            --button-hover-bg-color: #0ea5e9;
            --room-wall-color: #334155;
            --room-floor-color: #1e293b;
            --room-window-frame-color: #c78458;
            --room-window-glass-color: #525f76;
            --room-window-glass-night-color: #2c3e50;
            --livingroom-wall-color: #424230;
            --livingroom-floor-color: #575338;
            --livingroom-plant-pot-color: #a16207;
            --livingroom-plant-leaf-color: #22c55e;
            --status-bar-track-color: #334155;
            --modal-content-bg: #334155;
            --worm-color: #facc15;
            --worm-segment-border: #eab308;
            --game-area-border: #475569;
            --personality-text-color: #2dd4bf;
            --flight-game-obstacle-color: #a1a1aa;
            --shadow-color: rgba(255, 255, 255, 0.05);
            --shadow-md-color: rgba(255, 255, 255, 0.03);
            --bed-standard-blanket-color: #c78458;
            --bed-comfy-blanket-color: #10b981;
            --bed-wood-color: #A0522D;
            --accessory-hat-color: #f87171; /* Lighter red for dark mode */
            --quest-item-bg: #374151;
            --quest-item-border: #4b5563;
            --quest-progress-bg: #065f46;
            --quest-progress-fill: #059669;
            --sky-day-color: #38bdf8;
            --sky-night-color: #1e293b;
            --water-color: #4A90E2;
            --error-text-color: #f87171; 
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color-secondary);
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .top-bar {
            width: 100%;
            max-width: 420px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg-color);
            box-shadow: 0 2px 10px var(--shadow-color);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 1000;
            transition: background-color 0.3s ease;
        }
        .top-bar-left, .top-bar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .pet-coins-display {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color-accent);
            background-color: var(--bg-color);
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            box-shadow: inset 0 1px 2px var(--shadow-md-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .icon-button { 
            background-color: transparent;
            color: var(--text-color-secondary);
            border: 1px solid var(--game-area-border);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .icon-button:hover {
            background-color: var(--room-wall-color);
        }

        .game-area {
            margin-top: 80px; 
            width: 100%;
            max-width: 400px;
            background-color: var(--card-bg-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            transition: background-color 0.3s ease;
        }
        .firebase-error-message { /* New style for prominent error */
            color: var(--error-text-color);
            font-weight: bold;
            text-align: center;
            padding: 2rem;
            border: 2px dashed var(--error-text-color);
            border-radius: 8px;
            width: 100%;
        }
        .hidden-on-error { /* Class to hide elements during Firebase error */
            /* display: none !important; */ /* JS will handle this for smoother transition */
        }

        .room-container {
            width: 100%;
            max-width: 320px;
            height: 240px;
            position: relative;
            margin-bottom: 0.5rem;
            overflow: hidden; 
        }
        .sky-background { 
            position: absolute;
            top: 35px; right: 35px; width: 50px; height: 60px;
            z-index: 0;
            transition: background-color 1s ease;
        }
        .stars-container {
            position: absolute;
            top: 35px; right: 35px; width: 50px; height: 60px;
            overflow: hidden;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background-color: var(--star-color);
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 3s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
         .fishbowl-container { 
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            z-index: 4; 
        }
        .fishbowl-svg {
            width: 100%;
            height: 100%;
        }
        .fishbowl-water {
            fill: var(--water-color);
            opacity: 0.7;
        }
        .fishbowl-glass {
            fill: none;
            stroke: var(--text-color-secondary);
            stroke-width: 2px;
            opacity: 0.5;
        }


        .pet-room {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px var(--shadow-md-color), 0 3px 6px var(--shadow-color);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            overflow: hidden;
            border: 3px solid var(--card-bg-color);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .pet-room.active { opacity: 1; visibility: visible; z-index: 1; }
        #bedroom { background: linear-gradient(to bottom, var(--room-wall-color) 70%, var(--room-floor-color) 70%); }
        #bedroom::before { 
            content: ''; position: absolute; top: 30px; right: 30px; width: 60px; height: 70px;
            background-color: var(--room-window-glass-color); border: 4px solid var(--room-window-frame-color);
            border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 1;
            transition: background-color 0.5s ease;
        }
        #bedroom::after { 
            content: ''; position: absolute; top: 30px; right: 30px; width: 60px; height: 70px;
            border-left: 2px solid var(--room-window-frame-color); border-right: 2px solid var(--room-window-frame-color);
            transform: translateX(-50%) scaleX(0.15); left: calc(30px + 30px); z-index: 2;
        }
        #livingroom { background: linear-gradient(to bottom, var(--livingroom-wall-color) 70%, var(--livingroom-floor-color) 70%); }
        .livingroom-plant { position: absolute; bottom: 10px; left: 30px; width: 50px; height: 70px; z-index: 5; }
        .livingroom-plant svg { width: 100%; height: 100%; }
        .bed-display { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 150px; height: 80px; z-index: 5; }
        .bed-display svg { width: 100%; height: 100%; filter: drop-shadow(0px 2px 2px var(--shadow-md-color)); }

        .pet-character-container { 
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px; 
            height: 120px; 
            z-index: 10;
            transition: bottom 0.3s ease, transform 0.3s ease;
        }
        .pet-character-container.swimming { 
            bottom: 35px; 
            animation: swimCycle 8s infinite ease-in-out;
        }
        @keyframes swimCycle {
            0%, 100% { transform: translateX(-55%) translateY(0px) rotateY(0deg); }
            25% { transform: translateX(-45%) translateY(-5px) rotateY(0deg); }
            50% { transform: translateX(-55%) translateY(0px) rotateY(180deg); }
            75% { transform: translateX(-45%) translateY(5px) rotateY(180deg); }
        }


        .pet-character-container.sleeping { bottom: 45px; transform: translateX(-50%) rotate(-5deg); }
        .pet-character-svg, .pet-accessory-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-in-out;
            filter: drop-shadow(0px 3px 3px var(--shadow-color));
        }
        .pet-accessory-svg { z-index: 11; }
        .sleeping .owl-eye-pupil, .sleeping .bird-eye-pupil, .sleeping .cat-eye-pupil, .sleeping .dog-eye-pupil, .sleeping .dragon-eye-pupil, .sleeping .robot-eye-light { 
            transform: scaleY(0.1); transform-origin: center; 
        }
        .sleeping .pet-svg-eye-white { fill: #e0e0e0; } 


        .pet-info { text-align: center; }
        .pet-title { font-size: 1.75rem; font-weight: 700; color: var(--text-color-primary); margin-bottom: 0.25rem; }
        .pet-type-text { font-size: 0.8rem; color: var(--text-color-secondary); margin-bottom: 0.1rem; font-style: italic; }
        .pet-age-text, .pet-personality-text { font-size: 0.875rem; color: var(--text-color-secondary); margin-bottom: 0.125rem; }
        .pet-personality-text { color: var(--personality-text-color); font-style: normal; font-weight: 500; }
        .pet-status-text { font-size: 1rem; color: var(--text-color-status); min-height: 1.5rem; margin-top: 0.5rem; }
        .active-effects { font-size: 0.875rem; color: var(--text-color-accent); font-weight: 500; min-height: 1.25rem; }

        .stats-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        .stat-item { width: 100%; }
        .status-label-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.25rem; }
        .status-label { font-size: 0.875rem; font-weight: 500; color: var(--text-color-secondary); }
        .status-value-text { font-size: 0.875rem; font-weight: 600; color: var(--text-color-primary); }
        .status-bar { width: 100%; height: 12px; background-color: var(--status-bar-track-color); border-radius: 9999px; overflow: hidden; }
        .status-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem; font-size: 0.7rem; color: white; font-weight: 600; white-space: nowrap; }
        #energyBar.status-bar-fill { background-color: var(--status-bar-energy-fill); }
        #hungerBar.status-bar-fill { background-color: var(--status-bar-hunger-fill); }
        #moodBar.status-bar-fill { background-color: var(--status-bar-mood-fill); }

        .room-navigation { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
        .nav-button { background-color: var(--card-bg-color); color: var(--text-color-accent); border: 1px solid var(--text-color-accent); padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .nav-button:hover, .nav-button.active-room-nav { background-color: var(--text-color-accent); color: var(--card-bg-color); }
        .dark-mode:root .nav-button.active-room-nav { color: var(--button-text-color); }

        .main-actions-grid { width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 0.5rem; }
        .action-button { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; background-color: var(--button-bg-color); color: var(--button-text-color); font-weight: 600; font-size: 0.9375rem; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 2px 4px var(--shadow-md-color); transition: background-color 0.2s ease, transform 0.1s ease; }
        .action-button:hover { background-color: var(--button-hover-bg-color); }
        .action-button:active { transform: translateY(1px); }
        .action-button.secondary { background-color: var(--card-bg-color); color: var(--text-color-accent); border: 1px solid var(--text-color-accent); }
        .action-button.secondary:hover { background-color: var(--room-wall-color); }
        .dark-mode:root .action-button.secondary:hover { background-color: var(--room-wall-color); }
        .action-button.full-width { grid-column: span 2; }
        .action-button:disabled { background-color: #9ca3af !important; color: #e5e7eb !important; cursor: not-allowed !important; border-color: #9ca3af !important; }
        .dark-mode:root .action-button:disabled { background-color: #4b5563 !important; color: #9ca3af !important; border-color: #4b5563 !important;}


        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); justify-content: center; align-items: center; z-index: 1000; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { background-color: var(--modal-content-bg); padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px var(--shadow-color); width: 100%; max-width: 420px; text-align: center; color: var(--text-color-secondary); }
        .modal-content h2 { color: var(--text-color-primary); margin-top: 0; margin-bottom: 20px; }
        .modal-content ul { list-style: disc; padding-left: 1.5rem; text-align: left; margin-bottom: 1rem;}
        .modal-content ul li { margin-bottom: 0.25rem; }
        .shop-item, .selection-item, .quest-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 12px; border: 1px solid var(--game-area-border); border-radius: 8px; margin-bottom: 12px; background-color: var(--quest-item-bg); }
        .shop-item span, .selection-item span, .quest-item span { margin-bottom: 8px; }
        .shop-item button, .selection-item button { width: auto; padding: 8px 16px; }
        #shopMessage { margin-top: 10px; font-size: 0.9rem; min-height: 1.2em; }

        #wormGameArea, #flightGameArea { width: 100%; border: 2px solid var(--game-area-border); border-radius: 8px; position: relative; overflow: hidden; margin-top: 1rem; background-color: var(--room-wall-color); }
        #wormGameArea { height: 250px; }
        #flightGameArea { height: 200px; cursor: pointer; }
        .worm { width: 30px; height: 12px; position: absolute; cursor: pointer; display: flex; }
        .worm-segment { height: 100%; background-color: var(--worm-color); border: 1px solid var(--worm-segment-border); box-sizing: border-box; }
        .worm-segment:first-child { width: 35%; border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .worm-segment:nth-child(2) { width: 30%; }
        .worm-segment:last-child { width: 35%; border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        #wormGameTimer, #wormGameScore, #flightGameScore { font-size: 1.125rem; font-weight: 600; color: var(--text-color-primary); margin-top: 0.75rem; }
        #wormGameMessage, #flightGameMessage { font-size: 0.875rem; color: var(--text-color-status); min-height: 1.25rem; margin-top: 0.5rem; }
        .flight-pet-container { 
            width: 40px; height: 40px; position: absolute; left: 20px; transition: top 0.1s linear; 
        }
        .flight-pet-container svg { width: 100%; height: 100%; display: block; }
        .flight-obstacle { width: 20px; background-color: var(--flight-game-obstacle-color); position: absolute; right: -20px; }

        #notificationMessage { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 1rem; border-radius: 8px; background-color: var(--card-bg-color); color: var(--text-color-primary); box-shadow: 0 2px 10px var(--shadow-color); z-index: 2000; display: none; transition: opacity 0.3s ease, transform 0.3s ease; }
        #notificationMessage.show { display: block; opacity: 1; transform: translateX(-50%) translateY(0); }
        #notificationMessage.hide { opacity: 0; transform: translateX(-50%) translateY(20px); }

        .quest-item { background-color: var(--quest-item-bg); border: 1px solid var(--quest-item-border); }
        .quest-title { font-weight: 600; color: var(--text-color-primary); }
        .quest-description { font-size: 0.875rem; margin: 4px 0; }
        .quest-reward { font-size: 0.8rem; color: var(--text-color-accent); }
        .quest-progress-bar { width: 80%; height: 8px; background-color: var(--quest-progress-bg); border-radius: 4px; margin-top: 6px; overflow: hidden; }
        .quest-progress-fill { height: 100%; background-color: var(--quest-progress-fill); border-radius: 4px; transition: width 0.3s ease; }
        .quest-item button { margin-top: 8px; }

        .color-picker-container { display: flex; gap: 10px; margin: 10px 0; justify-content: center; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid var(--game-area-border); }
        
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; max-height: 300px; overflow-y: auto; padding: 0.5rem; border: 1px solid var(--game-area-border); border-radius: 8px; margin-top: 1rem;}
        .gallery-pet-card { background-color: var(--room-wall-color); border-radius: 8px; padding: 0.5rem; text-align: center; }
        .gallery-pet-svg-container { width: 60px; height: 60px; margin: 0 auto 0.5rem; position: relative; }
        .gallery-pet-svg-container svg { width: 100%; height: 100%; }
        .gallery-pet-name { font-size: 0.75rem; font-weight: 500; color: var(--text-color-primary); }
        .gallery-pet-owner { font-size: 0.65rem; color: var(--text-color-secondary); }


        @media (max-width: 480px) {
            .game-area { margin-top: 100px; padding: 1rem; }
            .pet-room { max-width: 100%; height: 200px; }
            .pet-character-container { width: 100px; height: 100px; bottom: 25px; }
            .bed-display { width: 130px; height: 70px; bottom: 5px; }
            .top-bar { padding: 0.5rem 0.75rem; }
            .main-actions-grid { grid-template-columns: 1fr; } 
            .action-button.full-width { grid-column: span 1; } 
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <div id="petCoinsDisplay" class="pet-coins-display">ü™ô 0</div>
            <button id="switchPetButton" class="icon-button" title="Haustier wechseln">üêæ</button>
        </div>
        <div class="top-bar-right">
            <button id="questsButton" class="icon-button" title="Quests">üìú</button>
            <button id="customizePetButton" class="icon-button" title="Haustier anpassen">üé®</button>
            <button id="galleryButton" class="icon-button" title="Haustier Galerie">üñºÔ∏è</button>
            <button id="themeToggleButton" class="icon-button" aria-label="Theme umschalten">üåô</button>
        </div>
    </div>

    <main class="game-area">
        <div id="firebaseErrorMessage" class="firebase-error-message" style="display: none;">
            <!-- Error message will be inserted here by JS -->
        </div>
        <div class="game-content-wrapper"> <!-- New wrapper for game content -->
            <div class="room-container hidden-on-error">
                <div class="sky-background" id="skyBackground"></div> 
                <div class="stars-container" id="starsContainer"></div>
                <div class="fishbowl-container" id="fishbowlContainer" style="display: none;">
                     <svg class="fishbowl-svg" viewBox="0 0 100 80">
                         <ellipse class="fishbowl-water" cx="50" cy="50" rx="45" ry="28"/>
                         <ellipse class="fishbowl-glass" cx="50" cy="50" rx="45" ry="28"/>
                         <rect x="30" y="22" width="40" height="5" fill="var(--room-window-frame-color)" opacity="0.3" />
                    </svg>
                </div>
                <div class="pet-room active" id="bedroom">
                    <div class="bed-display" id="bedDisplayContainer"></div>
                </div>
                <div class="pet-room" id="livingroom">
                    <div class="livingroom-plant">
                        <svg viewBox="0 0 50 70">
                            <rect x="15" y="50" width="20" height="20" rx="3" fill="var(--livingroom-plant-pot-color)"/>
                            <path d="M25 50 Q20 30 15 20 Q25 25 25 10 Q25 25 35 20 Q30 30 25 50" fill="var(--livingroom-plant-leaf-color)"/>
                            <path d="M25 50 Q30 30 35 20 Q25 25 25 10 Q25 25 15 20 Q20 30 25 50" fill="var(--livingroom-plant-leaf-color)" transform="scale(0.8 1) translate(6 0)"/>
                        </svg>
                    </div>
                </div>
                <div class="pet-character-container" id="petCharacterDisplay"></div>
            </div>
            
            <div class="room-navigation hidden-on-error">
                <button class="nav-button" id="navBedroomButton">Schlafzimmer</button>
                <button class="nav-button" id="navLivingroomButton">Wohnzimmer</button>
            </div>

            <div class="pet-info hidden-on-error">
                <h1 class="pet-title" id="petTitle">Lade Haustier...</h1>
                <p class="pet-type-text" id="petTypeText"></p>
                <p class="pet-age-text" id="petAgeText">Alter: 0 Tage</p>
                <p class="pet-personality-text" id="petPersonalityText">Pers√∂nlichkeit: Normal</p>
            </div>

            <p class="pet-status-text hidden-on-error" id="petStatusText">...</p>
            <div class="active-effects hidden-on-error" id="activeEffectsText"></div>
            
            <div class="stats-grid hidden-on-error">
                <div class="stat-item">
                    <div class="status-label-group">
                        <span class="status-label">Energie</span>
                        <span class="status-value-text" id="energyValueText">-%</span>
                    </div>
                    <div class="status-bar"><div class="status-bar-fill" id="energyBar" style="width: 70%;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="status-label-group">
                        <span class="status-label">S√§ttigung</span>
                        <span class="status-value-text" id="hungerValueText">-%</span>
                    </div>
                    <div class="status-bar"><div class="status-bar-fill" id="hungerBar" style="width: 50%;"></div></div>
                </div>
                <div class="stat-item">
                    <div class="status-label-group">
                        <span class="status-label">Laune</span>
                        <span class="status-value-text" id="moodValueText">-%</span>
                    </div>
                    <div class="status-bar "><div class="status-bar-fill" id="moodBar" style="width: 80%;"></div></div>
                </div>
            </div>

            <div class="main-actions-grid hidden-on-error">
                <button class="action-button" id="feedButton">üçº <span class="ml-1">F√ºttern</span></button>
                <button class="action-button" id="petButton">üíñ <span class="ml-1">Streicheln</span></button>
                <button class="action-button" id="sleepButton">üåô <span class="ml-1">Schlafen</span></button>
                <button class="action-button" id="openShopButton">üõçÔ∏è <span class="ml-1">Shop</span></button>
                <button class="action-button full-width" id="openWormGameButton">üêõ <span class="ml-1">Wurmjagd</span></button>
                <button class="action-button full-width" id="openFlightGameButton">üïäÔ∏è <span class="ml-1">Hindernisflug</span></button>
            </div>
        </div> <!-- End of game-content-wrapper -->
         <p class="text-xs text-center mt-4" id="userIdDisplay">User ID: -</p>
    </main>
    
    <div id="notificationMessage"></div>

    <div id="updatePopupModal" class="modal-overlay">
        <div class="modal-content">
            <h2>‚ú® Update-News! ‚ú®</h2>
            <p class="text-left mb-4">Hallo Tierfreund! Es gibt tolle Neuerungen in Pet's Life:</p>
            <ul class="text-sm">
                <li><strong>Minispiel-Fixes:</strong> Wurmjagd und Hindernisflug sollten jetzt besser funktionieren!</li>
                <li><strong>Neue Tierarten:</strong> Entdecke Katzen, Hunde, Drachen, Fische und Roboter!</li>
                <li>Firebase Integration, Haustier-Anpassung, T√§gliche Quests, Tag/Nacht-Zyklus.</li>
            </ul>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Viel Spa√ü!</p>
            <button id="closeUpdatePopupButton" class="action-button">Verstanden!</button>
        </div>
    </div>

    <div id="petSelectionModal" class="modal-overlay">
        <div class="modal-content">
            <h2>W√§hle dein erstes Haustier!</h2>
            <div id="petSelectionContainer"></div>
            <input type="text" id="newPetNameInput" placeholder="Name deines Haustiers" class="mt-4 p-2 border rounded w-full text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700">
            <button id="confirmPetSelectionButton" class="action-button mt-2">Best√§tigen</button>
        </div>
    </div>
    
    <div id="switchPetModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Haustier wechseln</h2>
            <div id="petListContainer" class="max-h-60 overflow-y-auto"></div>
            <button id="createNewPetSwitchModalButton" class="action-button mt-4">Neues Haustier erstellen</button>
            <button id="closeSwitchPetModalButton" class="action-button secondary mt-2">Schlie√üen</button>
        </div>
    </div>

    <div id="shopModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Willkommen im Shop!</h2>
            <div class="shop-item">
                <span>Schutztrank (1 Std.)<br><small>Verhindert Statusabfall</small></span>
                <button id="buyProtectionPotionButton" class="action-button">Kaufen (50 ü™ô)</button>
            </div>
            <div class="shop-item mt-3">
                <span>Super-Beere<br><small>+50 S√§ttigung, +10 Energie, +5 Laune</small></span>
                <button id="buySuperBerryButton" class="action-button">Kaufen (25 ü™ô)</button>
            </div>
            <div class="shop-item mt-3">
                <span>Kuscheliges Nest<br><small>Besserer Schlaf: +15 Energie Bonus</small></span>
                <button id="buyComfyNestButton" class="action-button">Kaufen (75 ü™ô)</button>
            </div>
            <div class="shop-item mt-3">
                <span>Roter Hut<br><small>Ein schicker Hut f√ºr dein Tier!</small></span>
                <button id="buyRedHatButton" class="action-button">Kaufen (30 ü™ô)</button>
            </div>
             <div class="shop-item mt-3">
                <span>Farbticket<br><small>√Ñndere die Hauptfarbe deines Tiers!</small></span>
                <button id="buyColorTicketButton" class="action-button">Kaufen (40 ü™ô)</button>
            </div>
            <div id="shopMessage" class="mt-2 text-sm min-h-[1.2em]"></div>
            <button id="closeShopButton" class="action-button secondary mt-4">Schlie√üen</button>
        </div>
    </div>

    <div id="customizePetModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Haustier anpassen</h2>
            <p>W√§hle eine neue Hauptfarbe:</p>
            <div id="colorPickerContainer" class="color-picker-container"></div>
            <p class="mt-4">W√§hle Accessoires:</p>
            <div id="accessorySelectionContainer"></div>
            <div id="customizeMessage" class="mt-2 text-sm min-h-[1.2em]"></div>
            <button id="saveCustomizationButton" class="action-button mt-4">Speichern</button>
            <button id="closeCustomizePetModalButton" class="action-button secondary mt-2">Schlie√üen</button>
        </div>
    </div>

    <div id="questsModal" class="modal-overlay">
        <div class="modal-content">
            <h2>T√§gliche Quests</h2>
            <div id="questListContainer"></div>
            <p id="questGeneralMessage" class="text-sm mt-3"></p>
            <button id="closeQuestsModalButton" class="action-button secondary mt-4">Schlie√üen</button>
        </div>
    </div>
    
    <div id="galleryModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Haustier Galerie</h2>
            <p class="text-sm mb-2">Hier siehst du Haustiere von anderen Spielern!</p>
            <div id="galleryGridContainer" class="gallery-grid"></div>
             <button id="showMyPetInGalleryButton" class="action-button mt-3">Mein Tier zeigen (kostet 5 ü™ô)</button>
            <p id="galleryMessage" class="text-sm mt-2"></p>
            <button id="closeGalleryModalButton" class="action-button secondary mt-4">Schlie√üen</button>
        </div>
    </div>

    <div id="wormGameModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Wurmjagd!</h2>
            <p>Klicke so viele W√ºrmer wie m√∂glich in 30 Sekunden!</p>
            <div id="wormGameArea"></div>
            <div id="wormGameTimer">Zeit: 30s</div>
            <div id="wormGameScore">Punkte: 0</div>
            <div id="wormGameMessage" class="mt-2 text-sm min-h-[1.2em]"></div>
            <button id="startWormGameButton" class="action-button mt-4">Spiel starten</button>
            <button id="closeWormGameButton" class="action-button secondary mt-4">Beenden</button>
        </div>
    </div>
    <div id="flightGameModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Hindernisflug!</h2>
            <p>Klicke/Tippe, um zu flattern und Hindernissen auszuweichen!</p>
            <div id="flightGameArea">
                <div class="flight-pet-container" id="flightGamePetContainer">
                 </div>
            </div>
            <div id="flightGameScore">Punkte: 0</div>
            <div id="flightGameMessage" class="mt-2 text-sm min-h-[1.2em]"></div>
            <button id="startFlightGameButton" class="action-button mt-4">Spiel starten</button>
            <button id="closeFlightGameButton" class="action-button secondary mt-4">Beenden</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, runTransaction, writeBatch, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config & Global App Vars ---
        // WICHTIG: Die Variablen __firebase_config und __app_id M√úSSEN global verf√ºgbar sein,
        // BEVOR dieses Skript ausgef√ºhrt wird. 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Eigene App-ID f√ºr Firestore-Pfade
        
        let db, auth, userId, currentPetId;
        let unsubscribePetStats = null;
        let unsubscribeQuests = null;
        let unsubscribeGallery = null;

        // --- Konstanten & Konfiguration ---
        const GAME_VERSION = "1.7-firebase-improvements"; 
        const MAX_STAT = 100;
        const MIN_STAT = 0;
        const MS_PER_HOUR = 1000 * 60 * 60;
        const MS_PER_DAY = MS_PER_HOUR * 24;

        const SATIATION_DECREASE_PER_HOUR = 8;
        const ENERGY_DECREASE_PER_HOUR_AWAKE = 6;
        const MOOD_DECREASE_PER_HOUR_ALONE = 5;
        const SATIATION_DECREASE_DURING_SLEEP = 3; 

        const SATIATION_GAIN_FROM_FEEDING = 30;
        const ENERGY_COST_OF_FEEDING = 3;
        const MOOD_GAIN_FROM_FEEDING = 8;
        const MOOD_GAIN_FROM_PETTING = 25;
        const ENERGY_COST_OF_PETTING = 2;
        const ENERGY_GAIN_FROM_SLEEP_STANDARD = 50;
        const ENERGY_GAIN_FROM_SLEEP_COMFY = 65;
        const MOOD_GAIN_FROM_SLEEP = 5;

        const LOW_STAT_THRESHOLD = 25;
        const GOOD_CARE_AVG_STAT_THRESHOLD = 65;

        const AVAILABLE_PET_TYPES = {
            owl: { 
                name: "Eule", 
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="60" rx="30" ry="35"/><circle class="pet-svg-eye-white owl-eye-white" cx="35" cy="50" r="12" fill="white"/><circle class="pet-svg-eye-pupil owl-eye-pupil" cx="35" cy="50" r="5" fill="black"/><circle class="pet-svg-eye-white owl-eye-white" cx="65" cy="50" r="12" fill="white"/><circle class="pet-svg-eye-pupil owl-eye-pupil" cx="65" cy="50" r="5" fill="black"/><polygon class="pet-svg-beak owl-beak" points="48,60 52,60 50,65"/><ellipse class="pet-svg-foot owl-foot" cx="40" cy="90" rx="8" ry="4" transform="rotate(-10 40 90)"/><ellipse class="pet-svg-foot owl-foot" cx="60" cy="90" rx="8" ry="4" transform="rotate(10 60 90)"/><path class="pet-svg-feature owl-ear" d="M30 35 Q35 20 40 35" stroke-width="3" fill="none"/><path class="pet-svg-feature owl-ear" d="M70 35 Q65 20 60 35" stroke-width="3" fill="none"/><path class="pet-svg-wing owl-wing" d="M20 60 Q15 70 25 80 C 30 75 30 65 20 60" /><path class="pet-svg-wing owl-wing" d="M80 60 Q85 70 75 80 C 70 75 70 65 80 60" /></svg>`,
                growthStages: {
                    baby: { name: "Babyeule", nextStage: 'juvenile', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.8 },
                    juvenile: { name: "Junge Eule", nextStage: 'adult', activeHoursNeeded: 24, careHoursNeeded: 18, svgScale: 1.0 },
                    adult: { name: "Erwachsene Eule", nextStage: null, activeHoursNeeded: 72, careHoursNeeded: 50, svgScale: 1.2 }
                },
                defaultColors: { primary: "#A0522D", secondary: "orange", feature: "#783f21" }
            },
            bird: {
                name: "Vogel",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="60" rx="25" ry="20"/><circle class="pet-svg-eye-white bird-eye-white" cx="65" cy="55" r="7" fill="white"/><circle class="pet-svg-eye-pupil bird-eye-pupil" cx="68" cy="55" r="3" fill="black"/><polygon class="pet-svg-beak bird-beak" points="75,58 85,55 75,52"/><path class="pet-svg-wing bird-wing" d="M40 50 Q20 60 40 70 C 50 65 50 55 40 50" /><ellipse class="pet-svg-foot bird-foot" cx="45" cy="80" rx="5" ry="3"/><ellipse class="pet-svg-foot bird-foot" cx="55" cy="80" rx="5" ry="3"/></svg>`,
                growthStages: { 
                    baby: { name: "K√ºken", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.9 },
                    adult: { name: "Vogel", nextStage: null, activeHoursNeeded: 48, careHoursNeeded: 30, svgScale: 1.1 }
                },
                defaultColors: { primary: "#4682B4", secondary: "orange", feature: "#6495ED"}
            },
            cat: {
                name: "Katze",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="70" rx="30" ry="20"/><circle cx="50" cy="45" r="20" class="pet-svg-body"/><path class="pet-svg-feature cat-ear" d="M35 30 Q40 15 45 30 Z" /><path class="pet-svg-feature cat-ear" d="M65 30 Q60 15 55 30 Z" /><circle class="pet-svg-eye-white cat-eye-white" cx="40" cy="45" r="6" fill="white"/><circle class="pet-svg-eye-pupil cat-eye-pupil" cx="40" cy="45" r="2" fill="black"/><circle class="pet-svg-eye-white cat-eye-white" cx="60" cy="45" r="6" fill="white"/><circle class="pet-svg-eye-pupil cat-eye-pupil" cx="60" cy="45" r="2" fill="black"/><polygon class="pet-svg-beak cat-nose" points="48,52 52,52 50,55" /><path d="M20 70 Q10 60 20 90" class="pet-svg-feature cat-tail" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`,
                growthStages: {
                    baby: { name: "Mieze", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.85 },
                    adult: { name: "Katze", nextStage: null, activeHoursNeeded: 50, careHoursNeeded: 35, svgScale: 1.0 }
                },
                defaultColors: { primary: "#8D6E63", secondary: "#FFB74D", feature: "#5D4037" } 
            },
            dog: {
                name: "Hund",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="70" rx="35" ry="22"/><ellipse cx="50" cy="45" r="22" class="pet-svg-body"/><path class="pet-svg-feature dog-ear" d="M25 45 Q20 60 35 55 Z" /><path class="pet-svg-feature dog-ear" d="M75 45 Q80 60 65 55 Z" /><circle class="pet-svg-eye-white dog-eye-white" cx="40" cy="45" r="5" fill="white"/><circle class="pet-svg-eye-pupil dog-eye-pupil" cx="40" cy="45" r="2" fill="black"/><circle class="pet-svg-eye-white dog-eye-white" cx="60" cy="45" r="5" fill="white"/><circle class="pet-svg-eye-pupil dog-eye-pupil" cx="60" cy="45" r="2" fill="black"/><ellipse cx="50" cy="55" rx="6" ry="3" class="pet-svg-beak dog-nose"/><path d="M80 70 Q95 65 85 85" class="pet-svg-feature dog-tail" stroke-width="5" fill="none" stroke-linecap="round"/></svg>`,
                growthStages: {
                    baby: { name: "Welpe", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.9 },
                    adult: { name: "Hund", nextStage: null, activeHoursNeeded: 60, careHoursNeeded: 40, svgScale: 1.1 }
                },
                defaultColors: { primary: "#D2B48C", secondary: "#A0522D", feature: "#8B4513" } 
            },
            dragon: {
                name: "Drache",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="70" rx="30" ry="25"/><path class="pet-svg-body" d="M40 40 Q50 20 60 40 Q70 50 60 60 L40 60 Q30 50 40 40 Z" /><path class="pet-svg-wing dragon-wing" d="M20 60 Q0 40 30 50 L40 70 Z" /><path class="pet-svg-wing dragon-wing" d="M80 60 Q100 40 70 50 L60 70 Z" /><circle class="pet-svg-eye-white dragon-eye-white" cx="45" cy="50" r="4" fill="yellow"/><circle class="pet-svg-eye-pupil dragon-eye-pupil" cx="45" cy="50" r="1.5" fill="black"/><polygon class="pet-svg-beak dragon-snout" points="50,58 55,62 45,62" /><path class="pet-svg-feature dragon-horn" d="M48 35 Q50 25 52 35" stroke-width="2" fill="none"/><path class="pet-svg-feature dragon-tail" d="M70 80 Q90 70 80 95" stroke-width="4" fill="none" stroke-linecap="round"/></svg>`,
                growthStages: {
                    baby: { name: "Schl√ºpfling", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.75 },
                    adult: { name: "Drache", nextStage: null, activeHoursNeeded: 100, careHoursNeeded: 70, svgScale: 1.3 }
                },
                defaultColors: { primary: "#2E8B57", secondary: "#FF8C00", feature: "#8B0000" } 
            },
            fish: {
                name: "Fisch",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse class="pet-svg-body" cx="50" cy="50" rx="30" ry="15"/><path class="pet-svg-feature fish-tail" d="M75 50 Q90 40 90 60 L75 50 Z" /><path class="pet-svg-feature fish-fin" d="M50 35 Q40 25 60 25 L50 35 Z" /><circle class="pet-svg-eye-white fish-eye-white" cx="40" cy="48" r="5" fill="white"/><circle class="pet-svg-eye-pupil fish-eye-pupil" cx="40" cy="48" r="2" fill="black"/></svg>`,
                growthStages: {
                    baby: { name: "Fischlein", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.6 },
                    adult: { name: "Fisch", nextStage: null, activeHoursNeeded: 30, careHoursNeeded: 20, svgScale: 0.8 }
                },
                defaultColors: { primary: "#FF6347", secondary: "#FFFF00", feature: "#FFA500" }, 
                specialPlacement: "fishbowl" 
            },
            robot: {
                name: "Roboter",
                baseSvg: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect class="pet-svg-body" x="30" y="40" width="40" height="40" rx="5"/><rect class="pet-svg-body" x="40" y="25" width="20" height="15" rx="3"/><rect class="pet-svg-feature robot-antenna" x="48" y="15" width="4" height="10" /><circle class="pet-svg-eye-white robot-eye-light" cx="50" cy="55" r="8" /><path class="pet-svg-arm robot-arm" d="M20 50 L30 50 L30 60 L20 60 Z" /><path class="pet-svg-arm robot-arm" d="M70 50 L80 50 L80 60 L70 60 Z" /></svg>`,
                growthStages: {
                    baby: { name: "Proto-Bot", nextStage: 'adult', activeHoursNeeded: 0, careHoursNeeded: 0, svgScale: 0.9 },
                    adult: { name: "Robo-Freund", nextStage: null, activeHoursNeeded: 80, careHoursNeeded: 60, svgScale: 1.1 }
                },
                defaultColors: { primary: "#B0C4DE", secondary: "#FFD700", feature: "#778899" } 
            }
        };
        const AVAILABLE_ACCESSORIES = {
            red_hat: { name: "Roter Hut", cost: 30, category: "head", 
                svg: `<path class="accessory-svg-item" d="M35 30 Q50 20 65 30 L60 35 L40 35 Z" fill="var(--accessory-hat-color)" stroke="#000" stroke-width="0.5"/>` 
            }
        };
        const AVAILABLE_COLORS = [
            { name: "Braun", value: "#A0522D" }, { name: "Blau", value: "#4682B4" }, { name: "Gr√ºn", value: "#2E8B57" },
            { name: "Gelb", value: "#facc15" }, { name: "Grau", value: "#B0C4DE" }, { name: "Pink", value: "#ec4899" },
            { name: "Rot", value: "#FF6347" }, { name: "Orange", value: "#FF8C00" } 
        ];
        const COLOR_TICKET_COST = 40;


        const PROTECTION_POTION_DURATION_MS = 1 * MS_PER_HOUR;
        const PROTECTION_POTION_COST = 50;
        const SUPER_BERRY_COST = 25;
        const SUPER_BERRY_SATIATION = 50;
        const SUPER_BERRY_ENERGY = 10;
        const SUPER_BERRY_MOOD = 5;
        const COMFY_NEST_COST = 75;

        const WORM_GAME_DURATION_S = 30;
        const WORM_APPEAR_INTERVAL_MS = 1200;
        const WORM_LIFESPAN_MS = 2500;

        const PERSONALITIES = {
            normal: { name: "Normal", moodEffect: 1.0, energyEffect: 1.0, hungerEffect: 1.0, specialAbilityText: "" },
            verspielt: { name: "Verspielt", moodEffect: 1.2, energyEffect: 0.9, hungerEffect: 1.0, specialAbilityText: "Liebt Spiele besonders!", gameCoinBonus: 2 },
            ruhig: { name: "Ruhig", moodEffect: 0.8, energyEffect: 1.1, hungerEffect: 1.0, specialAbilityText: "Verbraucht weniger Energie." },
            schlau: { name: "Schlau", moodEffect: 1.0, energyEffect: 1.0, hungerEffect: 0.9, specialAbilityText: "Findet manchmal extra ü™ô.", passiveCoinChance: 0.1, passiveCoinAmount: 5 }
        };
        const PERSONALITY_KEYS = Object.keys(PERSONALITIES);

        const FLIGHT_GAME_GRAVITY = 1.5; 
        const FLIGHT_GAME_FLAP_STRENGTH = 28; 
        const FLIGHT_GAME_OBSTACLE_SPEED = 2.5; 
        const FLIGHT_GAME_OBSTACLE_GAP = 110; 
        const FLIGHT_GAME_OBSTACLE_SPAWN_INTERVAL_MS = 2200; 

        const BED_SVGS = {
            standardBed: `<svg viewBox="0 0 100 50"><rect x="10" y="20" width="80" height="25" rx="5" fill="var(--bed-wood-color)"/><rect x="15" y="10" width="70" height="15" fill="var(--bed-standard-blanket-color)" rx="3"/><ellipse cx="30" cy="12" rx="10" ry="4" fill="#f0f0f0"/><ellipse cx="70" cy="12" rx="10" ry="4" fill="#f0f0f0"/></svg>`,
            comfyNest: `<svg viewBox="0 0 100 60"><path d="M10 50 Q5 30 15 20 C 25 5 75 5 85 20 Q95 30 90 50 Z" fill="var(--bed-wood-color)" stroke="#5C3A1E" stroke-width="2"/><ellipse cx="50" cy="35" rx="30" ry="15" fill="var(--bed-comfy-blanket-color)"/><ellipse cx="35" cy="30" rx="8" ry="5" fill="#f0f0f0" transform="rotate(-15 35 30)"/><ellipse cx="65" cy="30" rx="8" ry="5" fill="#f0f0f0" transform="rotate(15 65 30)"/></svg>`
        };
        
        const QUEST_DEFINITIONS = {
            feedPet: { id: "feedPet", title: "Satt & Gl√ºcklich", description: "F√ºttere dein Haustier 2 Mal.", targetCount: 2, currentCount: 0, rewardCoins: 20, actionType: "feed" },
            playWormGame: { id: "playWormGame", title: "Wurmj√§ger", description: "Spiele 1 Mal Wurmjagd.", targetCount: 1, currentCount: 0, rewardCoins: 15, actionType: "game_worm" },
            petPet: { id: "petPet", title: "Kuschelzeit", description: "Streichle dein Haustier 3 Mal.", targetCount: 3, currentCount: 0, rewardCoins: 10, actionType: "pet" },
            playFlightGame: { id: "playFlightGame", title: "Himmelsst√ºrmer", description: "Spiele 1 Mal Hindernisflug.", targetCount: 1, currentCount: 0, rewardCoins: 15, actionType: "game_flight" },
        };


        let petStats = null; 
        let userProfile = { 
            petCoins: 100,
            themePreference: 'light',
            lastSeenVersion: "0",
            ownedPets: [], 
            activePetId: null,
            lastQuestReset: null,
            inventory: { 
                colorTickets: 0,
            }
        };
        let dailyQuests = {}; 

        let themeToggleButton, petCoinsDisplay, energyBar, hungerBar, moodBar, energyValueText, hungerValueText, moodValueText,
            petTitle, petTypeText, petAgeText, petPersonalityText, petStatusText, activeEffectsText, notificationMessageDiv, 
            feedButton, petButton, sleepButton, openShopButton, shopModal, closeShopButton,
            buyProtectionPotionButton, buySuperBerryButton, buyComfyNestButton, buyRedHatButton, buyColorTicketButton, shopMessage, 
            openWormGameButton, wormGameModal, closeWormGameButton, startWormGameButton, wormGameArea, 
            wormGameTimerDisplay, wormGameScoreDisplay, wormGameMessage,
            openFlightGameButton, flightGameModal, closeFlightGameButton, startFlightGameButton, flightGameArea,
            flightGamePetContainer, flightGameScoreDisplay, flightGameMessage, 
            bedDisplayContainer, petCharacterDisplay, bedroomDiv, livingroomDiv, navBedroomButton, navLivingroomButton,
            updatePopupModal, closeUpdatePopupButton,
            petSelectionModal, petSelectionContainer, confirmPetSelectionButton, newPetNameInput,
            switchPetButton, switchPetModal, petListContainer, createNewPetSwitchModalButton, closeSwitchPetModalButton,
            customizePetButton, customizePetModal, colorPickerContainer, accessorySelectionContainer, customizeMessage, saveCustomizationButton, closeCustomizePetModalButton,
            questsButton, questsModal, questListContainer, questGeneralMessage, closeQuestsModalButton,
            galleryButton, galleryModal, galleryGridContainer, showMyPetInGalleryButton, galleryMessage, closeGalleryModalButton,
            userIdDisplay, skyBackground, starsContainer, fishbowlContainer,
            firebaseErrorMessageDiv, gameContentWrapper;  // Added new DOM elements
             
        let allModals = [];
        let wormGameIntervalId = null, wormSpawnIntervalId = null, wormGameScore = 0, wormGameTimeLeft = WORM_GAME_DURATION_S;
        let flightGameLoopId = null, flightGameObstacleSpawnId = null, flightGamePetY = 100, flightGamePetVelocityY = 0, flightGameObstacles = [], flightGameScoreNum = 0, flightGameActive = false;


        window.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM geladen. Initialisiere Spiel...");
            initializeDOMElements(); // Initialize all DOM elements first
            
            if (!firebaseConfig) {
                console.error("Firebase Konfiguration nicht gefunden!");
                if(firebaseErrorMessageDiv && gameContentWrapper) {
                    firebaseErrorMessageDiv.textContent = "Fehler: Firebase ist nicht korrekt konfiguriert. Das Spiel kann nicht geladen werden. Bitte stelle sicher, dass die Firebase-Konfigurationsvariablen (__firebase_config und __app_id) in der Umgebung korrekt gesetzt sind.";
                    firebaseErrorMessageDiv.style.display = 'block';
                    gameContentWrapper.style.display = 'none'; // Hide main game content
                }
                disableGameControls(true); // Disable all controls
                return; // Stop further execution
            }
            
            // If firebaseConfig is present, proceed with setup
            setupEventListeners(); // Setup event listeners only if Firebase config is okay

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Benutzer ist angemeldet:", user.uid);
                        userId = user.uid;
                        if(userIdDisplay) userIdDisplay.textContent = `User ID: ${userId}`;
                        if(firebaseErrorMessageDiv) firebaseErrorMessageDiv.style.display = 'none'; // Hide error if auth proceeds
                        if(gameContentWrapper) gameContentWrapper.style.display = 'block'; // Show game content
                        await loadUserProfile(); 
                    } else {
                        console.log("Benutzer nicht angemeldet. Versuche anonyme Anmeldung oder Custom Token.");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                console.log("Erfolgreich mit Custom Token angemeldet.");
                            } catch (error) {
                                console.error("Fehler bei Custom Token Anmeldung, versuche anonym:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                            console.log("Erfolgreich anonym angemeldet.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialisierungsfehler:", error);
                if(firebaseErrorMessageDiv && gameContentWrapper) {
                    firebaseErrorMessageDiv.textContent = "Fehler bei der Firebase-Initialisierung. Bitte √ºberpr√ºfe die Konsole f√ºr Details.";
                    firebaseErrorMessageDiv.style.display = 'block';
                    gameContentWrapper.style.display = 'none';
                }
                disableGameControls(true);
            }
        });

        function disableGameControls(disableAll = false) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (disableAll || btn.id !== 'themeToggleButton') { 
                    btn.disabled = true;
                }
            });
             if (disableAll && themeToggleButton) themeToggleButton.disabled = true;
        }

        function enableGameControls() {
             const buttons = document.querySelectorAll('button');
             buttons.forEach(btn => {
                if(btn.id !== 'startWormGameButton' && btn.id !== 'startFlightGameButton') {
                   btn.disabled = false;
                }
             });
             if(startWormGameButton) startWormGameButton.disabled = false;
             if(startFlightGameButton) startFlightGameButton.disabled = false;
        }

        async function loadUserProfile() {
            if (!userId) return;
            console.log(`Lade Nutzerprofil f√ºr User ID: ${userId}`);
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);
            
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    const loadedProfile = docSnap.data();
                    userProfile = {
                        ...userProfile, 
                        ...loadedProfile, 
                        inventory: { 
                            ...(userProfile.inventory || {}),
                            ...(loadedProfile.inventory || {})
                        },
                        // Wichtig: lastQuestReset als String behalten, wie es aus Firestore kommt oder null/undefined
                        lastQuestReset: loadedProfile.lastQuestReset || null 
                    };
                    console.log("Nutzerprofil geladen:", userProfile);

                    if (userProfile.lastSeenVersion !== GAME_VERSION && updatePopupModal) {
                        closeAllModals();
                        updatePopupModal.style.display = 'flex';
                    }
                    applyTheme(userProfile.themePreference || 'light');
                    updatePetCoinsDisplay();

                    if (userProfile.activePetId) {
                        currentPetId = userProfile.activePetId;
                        await loadPetStats(currentPetId);
                    } else if (userProfile.ownedPets && userProfile.ownedPets.length > 0) {
                        currentPetId = userProfile.ownedPets[0]; 
                        userProfile.activePetId = currentPetId;
                        await setDoc(userProfileRef, { activePetId: currentPetId }, { merge: true });
                        await loadPetStats(currentPetId);
                    } else {
                        console.log("Kein Haustier gefunden. Zeige Auswahl an.");
                        closeAllModals();
                        if(petSelectionModal) petSelectionModal.style.display = 'flex';
                        populatePetSelection();
                    }
                } else {
                    console.log("Kein Nutzerprofil gefunden. Erstelle neues Profil.");
                    userProfile = {
                        petCoins: 100,
                        themePreference: 'light',
                        lastSeenVersion: "0", 
                        ownedPets: [],
                        activePetId: null,
                        createdAt: serverTimestamp(), // Firestore Server Zeitstempel
                        lastLogin: serverTimestamp(), // Firestore Server Zeitstempel
                        lastQuestReset: null, // Wird beim ersten Quest-Check gesetzt
                        inventory: { colorTickets: 1 } 
                    };
                    await setDoc(userProfileRef, userProfile); // Hier werden Timestamps korrekt als serverTimestamp() geschrieben
                    console.log("Neues Nutzerprofil erstellt. Zeige Haustierauswahl.");
                    closeAllModals();
                    if(petSelectionModal) petSelectionModal.style.display = 'flex';
                    populatePetSelection();
                }
                await checkAndResetQuests(); 
                enableGameControls();

            } catch (error) {
                console.error("Fehler beim Laden/Erstellen des Nutzerprofils:", error);
                showNotification("Profil Fehler", "Konnte Nutzerprofil nicht laden.", true);
                if(firebaseErrorMessageDiv && gameContentWrapper) {
                    firebaseErrorMessageDiv.textContent = "Fehler beim Laden des Nutzerprofils.";
                    firebaseErrorMessageDiv.style.display = 'block';
                    gameContentWrapper.style.display = 'none';
                }
                disableGameControls();
            }
        }
        
        async function saveUserProfile() {
            if (!userId || !userProfile) return; 
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);
            try {
                // Erstelle ein zu speicherndes Objekt, um Timestamps nicht f√§lschlicherweise zu konvertieren,
                // wenn sie bereits Timestamps sind oder null bleiben sollen (wie lastQuestReset).
                const profileToSave = { ...userProfile };
                // Nur wenn lastLogin ein Client-Timestamp (Number) ist, konvertieren.
                // Wenn es schon ein Firestore Timestamp ist oder neu gesetzt wird, bleibt es so.
                if (typeof profileToSave.lastLogin === 'number') {
                    profileToSave.lastLogin = Timestamp.fromDate(new Date(profileToSave.lastLogin));
                } else if (!profileToSave.lastLogin) { // Falls es noch nie gesetzt wurde
                    profileToSave.lastLogin = serverTimestamp();
                }
                // createdAt sollte idealerweise nur einmal beim Erstellen gesetzt werden
                // und dann nicht mehr ver√§ndert werden.

                await setDoc(userProfileRef, profileToSave, { merge: true });
                console.log("Nutzerprofil gespeichert.");
            } catch (error) {
                console.error("Fehler beim Speichern des Nutzerprofils:", error);
                showNotification("Speicherfehler", "Nutzerprofil konnte nicht gespeichert werden.", true);
            }
        }

        async function loadPetStats(petId) {
            if (!userId || !petId) return;
            console.log(`Lade Haustierdaten f√ºr Pet ID: ${petId}`);
            currentPetId = petId; 

            if (unsubscribePetStats) unsubscribePetStats(); 

            const petDocRef = doc(db, `artifacts/${appId}/users/${userId}/pets/${petId}`);
            unsubscribePetStats = onSnapshot(petDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedPetStats = docSnap.data();
                    petStats = { // Default Struktur, um sicherzustellen, dass alle Felder vorhanden sind
                        name: "Pet",
                        petType: "owl", 
                        energy: MAX_STAT,
                        hunger: MAX_STAT,
                        mood: MAX_STAT,
                        // Zeitstempel werden jetzt als Millisekunden im Client-Code gehalten
                        // nach der Konvertierung aus Firestore Timestamp Objekten
                        creationTime: Date.now(), 
                        lastUpdateEnergy: Date.now(),
                        lastUpdateHunger: Date.now(),
                        lastUpdateMood: Date.now(),
                        growthStage: 'baby',
                        accumulatedActiveHours: 0,
                        accumulatedCareHours: 0,
                        lastGrowthUpdateTime: Date.now(),
                        personality: 'normal',
                        isSleeping: false,
                        currentRoom: 'bedroom',
                        inventory: {
                            protectionPotion: { active: false, expiresAt: 0 }, // expiresAt als Millisekunden
                            activeBed: 'standardBed',
                            ownedBeds: ['standardBed'],
                            accessories: { head: null, body: null, feet: null }, 
                            ownedAccessories: []
                        },
                        colorScheme: AVAILABLE_PET_TYPES.owl.defaultColors, 
                        notifiedLowEnergy: false, 
                        notifiedLowHunger: false,
                        notifiedLowMood: false,
                        ...loadedPetStats 
                    };
                    
                    // Konvertiere Firestore Timestamps zu Millisekunden f√ºr Client-Logik
                    ['creationTime', 'lastUpdateEnergy', 'lastUpdateHunger', 'lastUpdateMood', 'lastGrowthUpdateTime'].forEach(key => {
                        if (petStats[key] && petStats[key].toDate) { 
                            petStats[key] = petStats[key].toDate().getTime();
                        } else if (typeof petStats[key] !== 'number') { // Fallback, falls es kein Timestamp und keine Zahl ist
                            petStats[key] = Date.now();
                        }
                    });
                    if (petStats.inventory && petStats.inventory.protectionPotion && petStats.inventory.protectionPotion.expiresAt && petStats.inventory.protectionPotion.expiresAt.toDate) {
                        petStats.inventory.protectionPotion.expiresAt = petStats.inventory.protectionPotion.expiresAt.toDate().getTime();
                    } else if (petStats.inventory && petStats.inventory.protectionPotion && typeof petStats.inventory.protectionPotion.expiresAt !== 'number') {
                        petStats.inventory.protectionPotion.expiresAt = 0;
                    }
                    
                    // Sicherstellen, dass verschachtelte Objekte initialisiert sind
                    petStats.inventory = petStats.inventory || {};
                    petStats.inventory.protectionPotion = petStats.inventory.protectionPotion || { active: false, expiresAt: 0 };
                    petStats.inventory.ownedBeds = petStats.inventory.ownedBeds || ['standardBed'];
                    petStats.inventory.accessories = petStats.inventory.accessories || { head: null, body: null, feet: null };
                    petStats.inventory.ownedAccessories = petStats.inventory.ownedAccessories || [];
                    petStats.colorScheme = petStats.colorScheme || (AVAILABLE_PET_TYPES[petStats.petType] ? AVAILABLE_PET_TYPES[petStats.petType].defaultColors : AVAILABLE_PET_TYPES.owl.defaultColors);


                    console.log("Haustierdaten geladen/aktualisiert:", petStats);
                    recalculateStatsSinceLastUpdate(); 
                    updateGrowthMetricsAndCheck(true); 
                    updateAllDisplays(); 
                } else {
                    console.warn(`Haustier mit ID ${petId} nicht gefunden.`);
                    if (userProfile.ownedPets.includes(petId)) {
                        userProfile.ownedPets = userProfile.ownedPets.filter(id => id !== petId);
                        userProfile.activePetId = userProfile.ownedPets.length > 0 ? userProfile.ownedPets[0] : null;
                        saveUserProfile(); 
                        loadUserProfile(); 
                    } else {
                        console.log("Kein g√ºltiges aktives Haustier. Zeige Auswahl.");
                        closeAllModals();
                        if(petSelectionModal) petSelectionModal.style.display = 'flex';
                        populatePetSelection();
                    }
                }
            }, (error) => {
                console.error("Fehler beim Abrufen der Haustierdaten (onSnapshot):", error);
                showNotification("Datenfehler", "Konnte Haustierdaten nicht live laden.", true);
            });
        }

        async function savePetStats() {
            if (!userId || !currentPetId || !petStats) return;
            
            const petDocRef = doc(db, `artifacts/${appId}/users/${userId}/pets/${currentPetId}`);
            try {
                // Erstelle eine Kopie zum Speichern, um das lokale petStats-Objekt nicht zu ver√§ndern.
                const statsToSave = { ...petStats };

                // Konvertiere Client-Zeitstempel (Millisekunden) zur√ºck zu Firestore Timestamps
                ['creationTime', 'lastUpdateEnergy', 'lastUpdateHunger', 'lastUpdateMood', 'lastGrowthUpdateTime'].forEach(key => {
                    if (statsToSave[key] && typeof statsToSave[key] === 'number') {
                        statsToSave[key] = Timestamp.fromDate(new Date(statsToSave[key]));
                    }
                });
                if (statsToSave.inventory && statsToSave.inventory.protectionPotion && typeof statsToSave.inventory.protectionPotion.expiresAt === 'number') {
                    statsToSave.inventory.protectionPotion.expiresAt = Timestamp.fromDate(new Date(statsToSave.inventory.protectionPotion.expiresAt));
                }

                await setDoc(petDocRef, statsToSave, { merge: true });
                console.log("Haustierdaten gespeichert f√ºr Pet ID:", currentPetId);
            } catch (error) {
                console.error("Fehler beim Speichern der Haustierdaten:", error);
                showNotification("Speicherfehler", "Haustierdaten konnten nicht gespeichert werden.", true);
            }
        }
        
        function initializeDOMElements() {
            themeToggleButton = document.getElementById('themeToggleButton');
            petCoinsDisplay = document.getElementById('petCoinsDisplay');
            energyBar = document.getElementById('energyBar');
            hungerBar = document.getElementById('hungerBar');
            moodBar = document.getElementById('moodBar');
            energyValueText = document.getElementById('energyValueText');
            hungerValueText = document.getElementById('hungerValueText');
            moodValueText = document.getElementById('moodValueText');
            petTitle = document.getElementById('petTitle');
            petTypeText = document.getElementById('petTypeText');
            petAgeText = document.getElementById('petAgeText');
            petPersonalityText = document.getElementById('petPersonalityText');
            petStatusText = document.getElementById('petStatusText');
            activeEffectsText = document.getElementById('activeEffectsText');
            notificationMessageDiv = document.getElementById('notificationMessage');
            feedButton = document.getElementById('feedButton');
            petButton = document.getElementById('petButton');
            sleepButton = document.getElementById('sleepButton');
            openShopButton = document.getElementById('openShopButton');
            shopModal = document.getElementById('shopModal');
            closeShopButton = document.getElementById('closeShopButton');
            buyProtectionPotionButton = document.getElementById('buyProtectionPotionButton');
            buySuperBerryButton = document.getElementById('buySuperBerryButton');
            buyComfyNestButton = document.getElementById('buyComfyNestButton');
            buyRedHatButton = document.getElementById('buyRedHatButton');
            buyColorTicketButton = document.getElementById('buyColorTicketButton');
            shopMessage = document.getElementById('shopMessage');
            openWormGameButton = document.getElementById('openWormGameButton');
            wormGameModal = document.getElementById('wormGameModal'); 
            closeWormGameButton = document.getElementById('closeWormGameButton');
            startWormGameButton = document.getElementById('startWormGameButton');
            wormGameArea = document.getElementById('wormGameArea');
            wormGameTimerDisplay = document.getElementById('wormGameTimer');
            wormGameScoreDisplay = document.getElementById('wormGameScore');
            wormGameMessage = document.getElementById('wormGameMessage');
            openFlightGameButton = document.getElementById('openFlightGameButton');
            flightGameModal = document.getElementById('flightGameModal'); 
            closeFlightGameButton = document.getElementById('closeFlightGameButton');
            startFlightGameButton = document.getElementById('startFlightGameButton');
            flightGameArea = document.getElementById('flightGameArea');
            flightGamePetContainer = document.getElementById('flightGamePetContainer'); 
            flightGameScoreDisplay = document.getElementById('flightGameScore');
            flightGameMessage = document.getElementById('flightGameMessage');
            bedDisplayContainer = document.getElementById('bedDisplayContainer');
            petCharacterDisplay = document.getElementById('petCharacterDisplay');
            bedroomDiv = document.getElementById('bedroom');
            livingroomDiv = document.getElementById('livingroom');
            navBedroomButton = document.getElementById('navBedroomButton');
            navLivingroomButton = document.getElementById('navLivingroomButton');
            updatePopupModal = document.getElementById('updatePopupModal');
            closeUpdatePopupButton = document.getElementById('closeUpdatePopupButton');
            petSelectionModal = document.getElementById('petSelectionModal');
            petSelectionContainer = document.getElementById('petSelectionContainer');
            confirmPetSelectionButton = document.getElementById('confirmPetSelectionButton');
            newPetNameInput = document.getElementById('newPetNameInput');
            switchPetButton = document.getElementById('switchPetButton');
            switchPetModal = document.getElementById('switchPetModal');
            petListContainer = document.getElementById('petListContainer');
            createNewPetSwitchModalButton = document.getElementById('createNewPetSwitchModalButton');
            closeSwitchPetModalButton = document.getElementById('closeSwitchPetModalButton');
            customizePetButton = document.getElementById('customizePetButton');
            customizePetModal = document.getElementById('customizePetModal');
            colorPickerContainer = document.getElementById('colorPickerContainer');
            accessorySelectionContainer = document.getElementById('accessorySelectionContainer');
            customizeMessage = document.getElementById('customizeMessage');
            saveCustomizationButton = document.getElementById('saveCustomizationButton');
            closeCustomizePetModalButton = document.getElementById('closeCustomizePetModalButton');
            questsButton = document.getElementById('questsButton');
            questsModal = document.getElementById('questsModal');
            questListContainer = document.getElementById('questListContainer');
            questGeneralMessage = document.getElementById('questGeneralMessage');
            closeQuestsModalButton = document.getElementById('closeQuestsModalButton');
            galleryButton = document.getElementById('galleryButton');
            galleryModal = document.getElementById('galleryModal');
            galleryGridContainer = document.getElementById('galleryGridContainer');
            showMyPetInGalleryButton = document.getElementById('showMyPetInGalleryButton');
            galleryMessage = document.getElementById('galleryMessage');
            closeGalleryModalButton = document.getElementById('closeGalleryModalButton');
            userIdDisplay = document.getElementById('userIdDisplay');
            skyBackground = document.getElementById('skyBackground');
            starsContainer = document.getElementById('starsContainer');
            fishbowlContainer = document.getElementById('fishbowlContainer');
            firebaseErrorMessageDiv = document.getElementById('firebaseErrorMessage');
            gameContentWrapper = document.querySelector('.game-content-wrapper');


            allModals = [shopModal, wormGameModal, flightGameModal, updatePopupModal, petSelectionModal, switchPetModal, customizePetModal, questsModal, galleryModal];
        }

        function setupEventListeners() {
            if(themeToggleButton) themeToggleButton.addEventListener('click', () => {
                if (!userProfile) return; 
                const newTheme = document.documentElement.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(newTheme);
                userProfile.themePreference = newTheme;
                saveUserProfile();
            });
            if(navBedroomButton) navBedroomButton.addEventListener('click', () => switchToRoom('bedroom'));
            if(navLivingroomButton) navLivingroomButton.addEventListener('click', () => switchToRoom('livingroom'));
            if(feedButton) feedButton.addEventListener('click', handleFeed);
            if(petButton) petButton.addEventListener('click', handlePet);
            if(sleepButton) sleepButton.addEventListener('click', handleSleep);
            
            if(openShopButton) openShopButton.addEventListener('click', handleOpenShop);
            if(closeShopButton) closeShopButton.addEventListener('click', () => {if(shopModal) shopModal.style.display = 'none'});
            if(buyProtectionPotionButton) buyProtectionPotionButton.addEventListener('click', handleBuyProtectionPotion);
            if(buySuperBerryButton) buySuperBerryButton.addEventListener('click', handleBuySuperBerry);
            if(buyComfyNestButton) buyComfyNestButton.addEventListener('click', handleBuyComfyNest);
            if(buyRedHatButton) buyRedHatButton.addEventListener('click', () => handleBuyAccessory('red_hat'));
            if(buyColorTicketButton) buyColorTicketButton.addEventListener('click', handleBuyColorTicket);

            if(openWormGameButton) openWormGameButton.addEventListener('click', handleOpenWormGame);
            if(closeWormGameButton) closeWormGameButton.addEventListener('click', () => { endWormGame(false); if(wormGameModal) wormGameModal.style.display = 'none'; });
            if(startWormGameButton) startWormGameButton.addEventListener('click', handleStartWormGame);
            if(openFlightGameButton) openFlightGameButton.addEventListener('click', handleOpenFlightGame);
            if(closeFlightGameButton) closeFlightGameButton.addEventListener('click', () => { endFlightGame(false); if(flightGameModal) flightGameModal.style.display = 'none'; });
            if(startFlightGameButton) startFlightGameButton.addEventListener('click', handleStartFlightGame);
            if(flightGameArea) flightGameArea.addEventListener('click', handleFlightGameFlap);
            
            if(closeUpdatePopupButton) closeUpdatePopupButton.addEventListener('click', handleCloseUpdatePopup);
            if(confirmPetSelectionButton) confirmPetSelectionButton.addEventListener('click', handleConfirmPetSelection);
            if(switchPetButton) switchPetButton.addEventListener('click', handleOpenSwitchPetModal);
            if(closeSwitchPetModalButton) closeSwitchPetModalButton.addEventListener('click', () => {if(switchPetModal) switchPetModal.style.display = 'none'});
            if(createNewPetSwitchModalButton) createNewPetSwitchModalButton.addEventListener('click', () => {
                if(switchPetModal) switchPetModal.style.display = 'none';
                if(petSelectionModal) petSelectionModal.style.display = 'flex';
                populatePetSelection();
            });
            if(customizePetButton) customizePetButton.addEventListener('click', handleOpenCustomizePetModal);
            if(closeCustomizePetModalButton) closeCustomizePetModalButton.addEventListener('click', () => {if(customizePetModal) customizePetModal.style.display = 'none'});
            if(saveCustomizationButton) saveCustomizationButton.addEventListener('click', handleSaveCustomization);
            if(questsButton) questsButton.addEventListener('click', handleOpenQuestsModal);
            if(closeQuestsModalButton) closeQuestsModalButton.addEventListener('click', () => {if(questsModal) questsModal.style.display = 'none'});
            if(galleryButton) galleryButton.addEventListener('click', handleOpenGalleryModal);
            if(closeGalleryModalButton) closeGalleryModalButton.addEventListener('click', () => {if(galleryModal) galleryModal.style.display = 'none'});
            if(showMyPetInGalleryButton) showMyPetInGalleryButton.addEventListener('click', handleShowMyPetInGallery);

            allModals.forEach(modal => {
                if (modal) {
                    modal.addEventListener('click', (event) => {
                        if (event.target === modal) { 
                            modal.style.display = 'none';
                            if (modal === flightGameModal && flightGameActive) endFlightGame(false);
                            if (modal === wormGameModal && wormGameTimeLeft > 0 && wormGameTimeLeft < WORM_GAME_DURATION_S) endWormGame(false); 
                        }
                    });
                }
            });
        }
        
        function updateAllDisplays() {
            if (!petStats || !userProfile) return; 
            updatePetNameAndAge();
            updatePersonalityDisplay();
            updateStatusDisplay(); 
            updateActiveEffectsDisplay();
            updateRoomVisuals(); 
            applyGrowthVisuals(); 
            renderPetCharacter(); 
            updateDayNightCycle();
            updatePetCoinsDisplay(); 
        }

        function closeAllModals() {
            allModals.forEach(modal => {
                if (modal) modal.style.display = 'none';
            });
        }
        function formatTime(milliseconds) {
            if (milliseconds <= 0) return "0s";
            let seconds = Math.floor((milliseconds / 1000) % 60);
            let minutes = Math.floor((milliseconds / (1000 * 60)) % 60);
            let hours = Math.floor((milliseconds / (1000 * 60 * 60)) % 24);
            let parts = [];
            if (hours > 0) parts.push(hours + "h");
            if (minutes > 0) parts.push(minutes + "m");
            if (seconds > 0 || parts.length === 0) parts.push(seconds + "s");
            return parts.join(" ");
        }
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                if(themeToggleButton) themeToggleButton.textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.classList.remove('dark-mode');
                if(themeToggleButton) themeToggleButton.textContent = 'üåô';
            }
            if (petStats) {
                 applyGrowthVisuals(); 
                 renderPetCharacter();
            }
        }
        
        function populatePetSelection() {
            if (!petSelectionContainer) return;
            petSelectionContainer.innerHTML = '';
            Object.keys(AVAILABLE_PET_TYPES).forEach(typeKey => {
                const petType = AVAILABLE_PET_TYPES[typeKey];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'selection-item p-4 border rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
                
                let previewSvg = petType.baseSvg;
                previewSvg = previewSvg.replace(/class="pet-svg-body"/g, `class="pet-svg-body" fill="${petType.defaultColors.primary}"`);
                previewSvg = previewSvg.replace(/class="pet-svg-beak"/g, `class="pet-svg-beak" fill="${petType.defaultColors.secondary}"`);
                previewSvg = previewSvg.replace(/class="pet-svg-foot"/g, `class="pet-svg-foot" fill="${petType.defaultColors.secondary}"`);
                previewSvg = previewSvg.replace(/class="pet-svg-wing"/g, `class="pet-svg-wing" fill="${petType.defaultColors.primary}" stroke="${petType.defaultColors.feature || petType.defaultColors.primary}" stroke-width="1"`);
                previewSvg = previewSvg.replace(/class="pet-svg-feature"/g, `class="pet-svg-feature" stroke="${petType.defaultColors.feature || petType.defaultColors.primary}" fill="${petType.defaultColors.feature || petType.defaultColors.primary}"`);


                itemDiv.innerHTML = `
                    <div class="w-20 h-20 mx-auto my-2">${previewSvg}</div>
                    <span class="text-lg font-semibold">${petType.name}</span>
                `;
                itemDiv.addEventListener('click', () => {
                    document.querySelectorAll('#petSelectionContainer .selection-item').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                    itemDiv.classList.add('ring-2', 'ring-blue-500');
                    itemDiv.dataset.selectedType = typeKey; 
                });
                petSelectionContainer.appendChild(itemDiv);
            });
        }

        async function handleConfirmPetSelection() {
            const selectedItem = petSelectionContainer.querySelector('.selection-item.ring-2');
            const petName = newPetNameInput.value.trim();

            if (!selectedItem) {
                showNotification("Auswahl fehlt", "Bitte w√§hle einen Haustiertyp.", true);
                return;
            }
            if (!petName || petName.length < 3 || petName.length > 15) {
                showNotification("Ung√ºltiger Name", "Der Name muss 3-15 Zeichen lang sein.", true);
                return;
            }

            const petTypeKey = selectedItem.dataset.selectedType;
            const petTypeData = AVAILABLE_PET_TYPES[petTypeKey];
            
            // Datenobjekt f√ºr Firestore mit serverTimestamp()
            const newPetDataForFirestore = {
                name: petName,
                petType: petTypeKey,
                energy: MAX_STAT,
                hunger: MAX_STAT,
                mood: MAX_STAT,
                creationTime: serverTimestamp(),
                lastUpdateEnergy: serverTimestamp(),
                lastUpdateHunger: serverTimestamp(),
                lastUpdateMood: serverTimestamp(),
                growthStage: 'baby', 
                accumulatedActiveHours: 0,
                accumulatedCareHours: 0,
                lastGrowthUpdateTime: serverTimestamp(),
                personality: PERSONALITY_KEYS[Math.floor(Math.random() * PERSONALITY_KEYS.length)],
                isSleeping: false,
                currentRoom: 'bedroom',
                inventory: {
                    protectionPotion: { active: false, expiresAt: Timestamp.fromDate(new Date(0)) }, // Initialwert f√ºr Timestamp
                    activeBed: 'standardBed',
                    ownedBeds: ['standardBed'],
                    accessories: { head: null, body: null, feet: null }, 
                    ownedAccessories: []
                },
                colorScheme: { ...petTypeData.defaultColors },
                notifiedLowEnergy: false, 
                notifiedLowHunger: false,
                notifiedLowMood: false
            };

            try {
                const newPetRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/pets`), newPetDataForFirestore);
                currentPetId = newPetRef.id;
                userProfile.ownedPets.push(currentPetId);
                userProfile.activePetId = currentPetId;
                
                await saveUserProfile(); 
                
                if(petSelectionModal) petSelectionModal.style.display = 'none';
                if(newPetNameInput) newPetNameInput.value = ''; 
                await loadPetStats(currentPetId); 
                showNotification("Willkommen!", `Dein neues Haustier ${petName} ist eingezogen!`);
            } catch (error) {
                console.error("Fehler beim Erstellen des neuen Haustiers:", error);
                showNotification("Fehler", "Konnte Haustier nicht erstellen.", true);
            }
        }
        
        async function handleOpenSwitchPetModal() {
            if (!petListContainer || !switchPetModal) return;
            petListContainer.innerHTML = 'Lade Haustiere...';
            switchPetModal.style.display = 'flex';

            const petsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/pets`);
            try {
                const querySnapshot = await getDocs(petsCollectionRef);
                petListContainer.innerHTML = ''; 
                if (querySnapshot.empty) {
                    petListContainer.innerHTML = '<p>Du besitzt noch keine weiteren Haustiere.</p>';
                } else {
                    querySnapshot.forEach(docSnap => {
                        const petData = docSnap.data();
                        const petId = docSnap.id;
                        const typeInfo = AVAILABLE_PET_TYPES[petData.petType] || {name: "Unbekanntes Tier"};
                        const growthInfo = typeInfo.growthStages ? (typeInfo.growthStages[petData.growthStage] || {name: ""}) : {name: ""};


                        const petDiv = document.createElement('div');
                        petDiv.className = 'selection-item p-3 flex justify-between items-center';
                        petDiv.innerHTML = `
                            <div>
                                <span class="font-semibold">${petData.name}</span>
                                <small class="block text-xs">${typeInfo.name} (${growthInfo.name})</small>
                            </div>
                            ${petId === currentPetId 
                                ? '<span class="text-sm text-green-500">Aktiv</span>' 
                                : '<button class="action-button text-xs py-1 px-2">W√§hlen</button>'}
                        `;
                        if (petId !== currentPetId) {
                            const button = petDiv.querySelector('button');
                            if (button) { 
                                button.addEventListener('click', async () => {
                                    userProfile.activePetId = petId;
                                    await saveUserProfile();
                                    if(switchPetModal) switchPetModal.style.display = 'none';
                                    await loadPetStats(petId); 
                                });
                            }
                        }
                        petListContainer.appendChild(petDiv);
                    });
                }
            } catch (error) {
                console.error("Fehler beim Laden der Haustierliste:", error);
                petListContainer.innerHTML = '<p>Fehler beim Laden der Haustiere.</p>';
                 showNotification("Fehler", "Konnte Haustierliste nicht laden.", true);
            }
        }


        function switchToRoom(roomName, instant = false) {
            if (!petStats) return; 
            wakeUpOwl();
            petStats.currentRoom = roomName;

            [bedroomDiv, livingroomDiv].forEach(room => {
                if(room) room.classList.remove('active');
            });
            
            const activeRoomDiv = document.getElementById(roomName);
            if (activeRoomDiv) {
                activeRoomDiv.classList.add('active');
                if(petCharacterDisplay) activeRoomDiv.appendChild(petCharacterDisplay); 
                if (roomName === 'bedroom') {
                    if(bedDisplayContainer) {
                        if (!activeRoomDiv.contains(bedDisplayContainer)) activeRoomDiv.appendChild(bedDisplayContainer);
                        bedDisplayContainer.style.display = 'block';
                    }
                    if(fishbowlContainer) fishbowlContainer.style.display = 'none'; 
                } else if (roomName === 'livingroom') {
                    if(bedDisplayContainer) bedDisplayContainer.style.display = 'none';
                    if (petStats.petType === 'fish' && fishbowlContainer) {
                        if (!activeRoomDiv.contains(fishbowlContainer)) activeRoomDiv.appendChild(fishbowlContainer);
                        fishbowlContainer.style.display = 'block';
                    } else if (fishbowlContainer) {
                        fishbowlContainer.style.display = 'none';
                    }
                } else { 
                     if(bedDisplayContainer) bedDisplayContainer.style.display = 'none';
                     if(fishbowlContainer) fishbowlContainer.style.display = 'none';
                }
            }

            if(navBedroomButton) navBedroomButton.classList.toggle('active-room-nav', roomName === 'bedroom');
            if(navLivingroomButton) navLivingroomButton.classList.toggle('active-room-nav', roomName === 'livingroom');
            
            updateRoomVisuals(); 
            savePetStats();
        }
        
        function recalculateStatsSinceLastUpdate() {
            if (!petStats) return;
            const now = Date.now();
            let potionActive = petStats.inventory.protectionPotion.active && now < petStats.inventory.protectionPotion.expiresAt;
            const personalityMods = PERSONALITIES[petStats.personality];

            if (!potionActive) {
                if (!petStats.isSleeping) { 
                    let energyDecreaseRate = ENERGY_DECREASE_PER_HOUR_AWAKE * (personalityMods.energyEffect || 1.0);
                    let timePassedEnergyHours = (now - (petStats.lastUpdateEnergy || now)) / MS_PER_HOUR;
                    petStats.energy = Math.max(MIN_STAT, petStats.energy - (timePassedEnergyHours * energyDecreaseRate));
                }
                
                let hungerDecreaseRate;
                if (petStats.isSleeping) {
                    hungerDecreaseRate = SATIATION_DECREASE_DURING_SLEEP * (personalityMods.hungerEffect || 1.0);
                } else {
                    hungerDecreaseRate = SATIATION_DECREASE_PER_HOUR * (personalityMods.hungerEffect || 1.0);
                }
                let timePassedHungerHours = (now - (petStats.lastUpdateHunger || now)) / MS_PER_HOUR;
                petStats.hunger = Math.max(MIN_STAT, petStats.hunger - (timePassedHungerHours * hungerDecreaseRate));

                let moodDecreaseRate = MOOD_DECREASE_PER_HOUR_ALONE * (1 / (personalityMods.moodEffect || 1.0));
                let timePassedMoodHours = (now - (petStats.lastUpdateMood || now)) / MS_PER_HOUR;
                petStats.mood = Math.max(MIN_STAT, petStats.mood - (timePassedMoodHours * moodDecreaseRate));
            } else {
                console.log("Schutztrank aktiv, Statusabnahme pausiert.");
            }
            petStats.lastUpdateEnergy = now;
            petStats.lastUpdateHunger = now;
            petStats.lastUpdateMood = now;

            if (userProfile && petStats.personality === 'schlau' && Math.random() < (PERSONALITIES.schlau.passiveCoinChance / (60 * 60 / 30) ) ) { 
                const coinsFound = PERSONALITIES.schlau.passiveCoinAmount;
                userProfile.petCoins += coinsFound;
                updatePetCoinsDisplay();
                saveUserProfile();
                showNotification("Entdeckung!", `Deine schlaue ${petStats.name} hat ${coinsFound} ü™ô gefunden!`);
            }
            
            updateActiveEffectsDisplay(); 
        }
        
        function updateGrowthMetricsAndCheck(isInitialLoad = false) {
            if (!petStats) return;
            const now = Date.now();
            const timeSinceLastGrowthUpdateHours = (now - (petStats.lastGrowthUpdateTime || now)) / MS_PER_HOUR;
            const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl;


            if (timeSinceLastGrowthUpdateHours > 0) {
                petStats.accumulatedActiveHours += timeSinceLastGrowthUpdateHours;
                const avgStats = (petStats.energy + petStats.hunger + petStats.mood) / 3;
                if (avgStats >= GOOD_CARE_AVG_STAT_THRESHOLD) {
                    petStats.accumulatedCareHours += timeSinceLastGrowthUpdateHours;
                }
                petStats.lastGrowthUpdateTime = now;
            }

            const currentStageKey = petStats.growthStage;
            const currentStageData = petTypeConfig.growthStages[currentStageKey];
            
            if (currentStageData && currentStageData.nextStage) {
                const nextStageKey = currentStageData.nextStage;
                const nextStageData = petTypeConfig.growthStages[nextStageKey];
                if (petStats.accumulatedActiveHours >= nextStageData.activeHoursNeeded &&
                    petStats.accumulatedCareHours >= nextStageData.careHoursNeeded) {
                    petStats.growthStage = nextStageKey;
                    if (!isInitialLoad) {
                        showNotification(`${petStats.name} ist gewachsen!`, `Es ist jetzt ${petTypeConfig.growthStages[petStats.growthStage].name}!`);
                    }
                }
            }
        }
        
        function updatePetNameAndAge() {
            if (!petStats) return;
            const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl; 
            const growthStageConfig = petTypeConfig.growthStages[petStats.growthStage] || petTypeConfig.growthStages.baby; 
            const stageName = growthStageConfig.name;
            
            if(petTitle) petTitle.textContent = `${petStats.name} (${stageName})`;
            if(petTypeText) petTypeText.textContent = `Art: ${petTypeConfig.name}`;
            if(petAgeText) {
                const ageInDays = Math.floor((Date.now() - (petStats.creationTime || Date.now())) / MS_PER_DAY);
                petAgeText.textContent = `Alter: ${ageInDays} Tag${ageInDays === 1 ? '' : 'e'}`;
            }
        }
        
        function applyGrowthVisuals() {
            if (!petStats || !petCharacterDisplay) return;
            const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl;
            const stageConfig = petTypeConfig.growthStages[petStats.growthStage] || petTypeConfig.growthStages.baby;
            
            petCharacterDisplay.style.transform = `translateX(-50%) scale(${stageConfig.svgScale})`;
        }

        function renderPetCharacter() {
            if (!petStats || !petCharacterDisplay) return;
            const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl;
            let baseSvgHtml = petTypeConfig.baseSvg;

            const currentColorScheme = petStats.colorScheme || petTypeConfig.defaultColors;

            baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-body"/g, `class="pet-svg-body" fill="${currentColorScheme.primary}"`);
            baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-beak"/g, `class="pet-svg-beak" fill="${currentColorScheme.secondary}"`);
            baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-foot"/g, `class="pet-svg-foot" fill="${currentColorScheme.secondary}"`);
            baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-wing"/g, `class="pet-svg-wing" fill="${currentColorScheme.primary}" stroke="${currentColorScheme.feature || currentColorScheme.primary}" stroke-width="1"`);
            baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-feature"/g, `class="pet-svg-feature" stroke="${currentColorScheme.feature || currentColorScheme.primary}" fill="${currentColorScheme.feature || currentColorScheme.primary}"`);
            
            if (petStats.petType === 'cat' || petStats.petType === 'dog') {
                 baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-feature (cat-ear|dog-ear|cat-tail|dog-tail)"/g, `class="pet-svg-feature $1" fill="${currentColorScheme.primary}" stroke="${currentColorScheme.feature}"`);
                 baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-beak (cat-nose|dog-nose)"/g, `class="pet-svg-beak $1" fill="${currentColorScheme.secondary}"`);
            }
             if (petStats.petType === 'robot') {
                baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-eye-white robot-eye-light"/g, `class="pet-svg-eye-white robot-eye-light" fill="${currentColorScheme.secondary}"`);
                baseSvgHtml = baseSvgHtml.replace(/class="pet-svg-arm robot-arm"/g, `class="pet-svg-arm robot-arm" fill="${currentColorScheme.primary}" stroke="${currentColorScheme.feature}" stroke-width="1"`);
            }


            let accessoriesHtml = "";
            if (petStats.inventory && petStats.inventory.accessories) {
                Object.keys(petStats.inventory.accessories).forEach(category => {
                    const accessoryId = petStats.inventory.accessories[category];
                    if (accessoryId && AVAILABLE_ACCESSORIES[accessoryId]) {
                        accessoriesHtml += `<div class="pet-accessory-svg" data-accessory-id="${accessoryId}">
                                                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                                    ${AVAILABLE_ACCESSORIES[accessoryId].svg}
                                                </svg>
                                            </div>`;
                    }
                });
            }
            petCharacterDisplay.innerHTML = `<div class="pet-character-svg">${baseSvgHtml}</div>` + accessoriesHtml;

            if (petStats.petType === 'fish' && petStats.currentRoom === 'livingroom') {
                if(fishbowlContainer) fishbowlContainer.style.display = 'block';
                petCharacterDisplay.classList.add('swimming');
            } else {
                if(fishbowlContainer) fishbowlContainer.style.display = 'none';
                petCharacterDisplay.classList.remove('swimming');
            }
        }


        function updateStatusDisplay() {
            if (!petStats) return;
            const displayEnergy = Math.round(petStats.energy);
            const displayHunger = Math.round(petStats.hunger);
            const displayMood = Math.round(petStats.mood);

            if(energyBar) { energyBar.style.width = displayEnergy + '%'; energyBar.textContent = displayEnergy + '%'; }
            if(energyValueText) energyValueText.textContent = displayEnergy + '%';
            if(hungerBar) { hungerBar.style.width = displayHunger + '%'; hungerBar.textContent = displayHunger + '%'; }
            if(hungerValueText) hungerValueText.textContent = displayHunger + '%';
            if(moodBar) { moodBar.style.width = displayMood + '%'; moodBar.textContent = displayMood + '%'; }
            if(moodValueText) moodValueText.textContent = displayMood + '%';

            updatePetVisualsAndText(displayEnergy, displayHunger, displayMood);
            checkAndNotifyLowStats(displayEnergy, displayHunger, displayMood); 
        }
        
        function updatePetVisualsAndText(energy, hunger, mood) {
            if(!petStatusText || !petStats) return;
            const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl;
            const currentStageData = petTypeConfig.growthStages[petStats.growthStage] || petTypeConfig.growthStages.baby;
            const currentStageName = currentStageData.name;
            const petDisplayName = petStats.name;

            if (petStats.isSleeping) {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) schl√§ft tief und fest... Zzzz...`;
            } else if (energy < LOW_STAT_THRESHOLD + 10) {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) ist sehr m√ºde und g√§hnt.`;
            } else if (hunger < LOW_STAT_THRESHOLD + 10) {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) knurrt leise. Es hat Hunger!`;
            } else if (mood < LOW_STAT_THRESHOLD + 10) {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) schaut traurig und seufzt.`;
            } else if (mood > 85 && energy > 70) {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) h√ºpft fr√∂hlich und zwitschert!`;
            } else {
                petStatusText.textContent = `${petDisplayName} (${currentStageName}) ist zufrieden und schaut dich an.`;
            }
        }
        function updatePetCoinsDisplay() {
            if(petCoinsDisplay && userProfile) petCoinsDisplay.textContent = `ü™ô ${userProfile.petCoins}`;
        }
        function updateActiveEffectsDisplay() {
            if (!petStats || !activeEffectsText) return;
            let effectMsg = "";
            if (petStats.inventory.protectionPotion.active) {
                const timeLeft = petStats.inventory.protectionPotion.expiresAt - Date.now();
                if (timeLeft > 0) {
                    effectMsg = `Schutz aktiv: ${formatTime(timeLeft)}`;
                } else {
                    petStats.inventory.protectionPotion.active = false; 
                    effectMsg = "Schutztrank ist abgelaufen.";
                }
            }
            activeEffectsText.textContent = effectMsg;
        }
        function updatePersonalityDisplay() {
            if (!petStats || !petPersonalityText) return;
            const personalityData = PERSONALITIES[petStats.personality];
            petPersonalityText.textContent = `Pers√∂nlichkeit: ${personalityData.name}`;
        }
        function updateRoomVisuals() {
            if (!petStats || !bedDisplayContainer || !petCharacterDisplay) return;
            bedDisplayContainer.innerHTML = BED_SVGS[petStats.inventory.activeBed] || BED_SVGS.standardBed;
            
            if (petStats.isSleeping && petStats.currentRoom === 'bedroom') {
                petCharacterDisplay.classList.add('sleeping');
            } else {
                petCharacterDisplay.classList.remove('sleeping');
                if(petStats.isSleeping && petStats.currentRoom !== 'bedroom') { 
                    petStats.isSleeping = false; 
                }
            }
        }
        function wakeUpOwl() { 
            if (petStats && petStats.isSleeping) {
                petStats.isSleeping = false;
                updateRoomVisuals();
            }
        }

        async function handleFeed() {
            if (!petStats) return;
            wakeUpOwl();
            recalculateStatsSinceLastUpdate(); 
            updateGrowthMetricsAndCheck();
            petStats.hunger = Math.min(MAX_STAT, petStats.hunger + SATIATION_GAIN_FROM_FEEDING);
            petStats.lastUpdateHunger = Date.now();
            petStats.energy = Math.max(MIN_STAT, petStats.energy - ENERGY_COST_OF_FEEDING);
            petStats.lastUpdateEnergy = Date.now(); 
            petStats.mood = Math.min(MAX_STAT, petStats.mood + (MOOD_GAIN_FROM_FEEDING * (PERSONALITIES[petStats.personality].moodEffect || 1.0) ));
            petStats.lastUpdateMood = Date.now(); 
            updateStatusDisplay();
            await trackQuestProgress("feed");
            savePetStats();
        }
        async function handlePet() {
            if (!petStats) return;
            wakeUpOwl();
            recalculateStatsSinceLastUpdate(); 
            updateGrowthMetricsAndCheck();
            petStats.mood = Math.min(MAX_STAT, petStats.mood + (MOOD_GAIN_FROM_PETTING * (PERSONALITIES[petStats.personality].moodEffect || 1.0) ));
            petStats.lastUpdateMood = Date.now();
            petStats.energy = Math.max(MIN_STAT, petStats.energy - ENERGY_COST_OF_PETTING);
            petStats.lastUpdateEnergy = Date.now();
            updateStatusDisplay();
            await trackQuestProgress("pet");
            savePetStats();
        }
        function handleSleep() {
            if (!petStats) return;
            if (petStats.petType === 'fish') { 
                showNotification("Fische schlafen anders!", `${petStats.name} braucht kein Bett.`);
                return;
            }
            if (petStats.currentRoom !== 'bedroom') {
                showNotification("Schlafenszeit!", "Dein Haustier kann nur im Schlafzimmer schlafen.");
                return;
            }
            if (!petStats.isSleeping) { 
                recalculateStatsSinceLastUpdate();
            }
            updateGrowthMetricsAndCheck();
            
            let energyGain = ENERGY_GAIN_FROM_SLEEP_STANDARD;
            if (petStats.inventory.activeBed === 'comfyNest') {
                energyGain = ENERGY_GAIN_FROM_SLEEP_COMFY;
            }

            petStats.energy = Math.min(MAX_STAT, petStats.energy + energyGain);
            petStats.lastUpdateEnergy = Date.now();
            petStats.mood = Math.min(MAX_STAT, petStats.mood + MOOD_GAIN_FROM_SLEEP);
            petStats.lastUpdateMood = Date.now();
            
            petStats.isSleeping = true;
            updateRoomVisuals(); 
            updateStatusDisplay(); 
            savePetStats();
        }
        function handleOpenShop() {
            if (!petStats) return;
            wakeUpOwl(); 
            closeAllModals(); 
            if(shopModal) shopModal.style.display = 'flex'; 
            if(shopMessage) shopMessage.textContent = ''; 
        }
        function handleBuyProtectionPotion() {
            if (!petStats || !userProfile) return;
            if (petStats.inventory.protectionPotion.active && petStats.inventory.protectionPotion.expiresAt > Date.now()) {
                if(shopMessage) { shopMessage.textContent = "Ein Schutztrank ist bereits aktiv!"; shopMessage.style.color = "orange"; }
                return;
            }
            if (userProfile.petCoins >= PROTECTION_POTION_COST) {
                userProfile.petCoins -= PROTECTION_POTION_COST;
                petStats.inventory.protectionPotion.active = true;
                petStats.inventory.protectionPotion.expiresAt = Date.now() + PROTECTION_POTION_DURATION_MS;
                updatePetCoinsDisplay();
                updateActiveEffectsDisplay();
                if(shopMessage) { shopMessage.textContent = "Schutztrank gekauft und aktiviert!"; shopMessage.style.color = "green"; }
                saveUserProfile();
                savePetStats();
            } else {
                if(shopMessage) { shopMessage.textContent = "Nicht genug PetCoins!"; shopMessage.style.color = "red"; }
            }
        }
        function handleBuySuperBerry() {
            if (!petStats || !userProfile) return;
            if (userProfile.petCoins >= SUPER_BERRY_COST) {
                userProfile.petCoins -= SUPER_BERRY_COST;
                petStats.hunger = Math.min(MAX_STAT, petStats.hunger + SUPER_BERRY_SATIATION);
                petStats.energy = Math.min(MAX_STAT, petStats.energy + SUPER_BERRY_ENERGY);
                petStats.mood = Math.min(MAX_STAT, petStats.mood + SUPER_BERRY_MOOD);
                
                updatePetCoinsDisplay();
                updateStatusDisplay();
                if(shopMessage) { shopMessage.textContent = "Super-Beere verf√ºttert!"; shopMessage.style.color = "green"; }
                saveUserProfile();
                savePetStats();
            } else {
                if(shopMessage) { shopMessage.textContent = "Nicht genug PetCoins f√ºr die Super-Beere!"; shopMessage.style.color = "red"; }
            }
        }
        function handleBuyComfyNest() {
            if (!petStats || !userProfile) return;
            if (petStats.petType === 'fish') {
                 if(shopMessage) { shopMessage.textContent = "Fische brauchen keine Nester!"; shopMessage.style.color = "orange"; }
                return;
            }
            wakeUpOwl();
            if (petStats.inventory.ownedBeds.includes('comfyNest')) {
                petStats.inventory.activeBed = 'comfyNest';
                if(shopMessage) { shopMessage.textContent = "Kuscheliges Nest ist jetzt dein aktives Bett!"; shopMessage.style.color = "blue"; }
                updateRoomVisuals();
                savePetStats();
            } else if (userProfile.petCoins >= COMFY_NEST_COST) {
                userProfile.petCoins -= COMFY_NEST_COST;
                petStats.inventory.ownedBeds.push('comfyNest');
                petStats.inventory.activeBed = 'comfyNest';
                updatePetCoinsDisplay();
                updateRoomVisuals();
                if(shopMessage) { shopMessage.textContent = "Kuscheliges Nest gekauft und ausgew√§hlt!"; shopMessage.style.color = "green"; }
                saveUserProfile();
                savePetStats();
            } else {
                if(shopMessage) { shopMessage.textContent = "Nicht genug PetCoins f√ºr das Kuschelige Nest!"; shopMessage.style.color = "red"; }
            }
        }
        
        function handleBuyAccessory(accessoryId) {
            if (!petStats || !AVAILABLE_ACCESSORIES[accessoryId] || !userProfile) return;
            const accessory = AVAILABLE_ACCESSORIES[accessoryId];

            if (petStats.inventory.ownedAccessories.includes(accessoryId)) {
                 if(shopMessage) { shopMessage.textContent = `Du besitzt ${accessory.name} bereits!`; shopMessage.style.color = "blue"; }
                 return;
            }

            if (userProfile.petCoins >= accessory.cost) {
                userProfile.petCoins -= accessory.cost;
                petStats.inventory.ownedAccessories.push(accessoryId);
                updatePetCoinsDisplay();
                if(shopMessage) { shopMessage.textContent = `${accessory.name} gekauft!`; shopMessage.style.color = "green"; }
                saveUserProfile();
                savePetStats();
            } else {
                if(shopMessage) { shopMessage.textContent = `Nicht genug PetCoins f√ºr ${accessory.name}!`; shopMessage.style.color = "red"; }
            }
        }
        
        function handleBuyColorTicket() {
            if (!userProfile) return;
            if (userProfile.petCoins >= COLOR_TICKET_COST) {
                userProfile.petCoins -= COLOR_TICKET_COST;
                userProfile.inventory.colorTickets = (userProfile.inventory.colorTickets || 0) + 1;
                updatePetCoinsDisplay();
                 if(shopMessage) { shopMessage.textContent = `Farbticket gekauft! Du hast jetzt ${userProfile.inventory.colorTickets}.`; shopMessage.style.color = "green"; }
                saveUserProfile();
            } else {
                if(shopMessage) { shopMessage.textContent = `Nicht genug PetCoins f√ºr ein Farbticket!`; shopMessage.style.color = "red"; }
            }
        }


        function handleOpenCustomizePetModal() {
            if (!petStats || !customizePetModal || !colorPickerContainer || !accessorySelectionContainer || !customizeMessage) return;
            closeAllModals();
            customizePetModal.style.display = 'flex';
            customizeMessage.textContent = '';

            colorPickerContainer.innerHTML = '';
            AVAILABLE_COLORS.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color.value;
                swatch.title = color.name;
                swatch.dataset.colorValue = color.value;
                if (petStats.colorScheme.primary === color.value) {
                    swatch.style.borderColor = 'var(--text-color-accent)'; 
                    swatch.style.borderWidth = '3px';
                }
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('#colorPickerContainer .color-swatch').forEach(s => {
                         s.style.borderColor = 'var(--game-area-border)';
                         s.style.borderWidth = '2px';
                    });
                    swatch.style.borderColor = 'var(--text-color-accent)';
                    swatch.style.borderWidth = '3px';
                });
                colorPickerContainer.appendChild(swatch);
            });
            
            accessorySelectionContainer.innerHTML = '';
            const categories = { head: "Kopf", body: "K√∂rper" }; 
            Object.keys(categories).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h4 class="text-sm font-semibold mt-3 mb-1">${categories[category]}:</h4>`;
                const select = document.createElement('select');
                select.dataset.category = category;
                select.className = "p-2 border rounded w-full bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200";
                
                const noneOption = document.createElement('option');
                noneOption.value = "null"; 
                noneOption.textContent = "Nichts";
                select.appendChild(noneOption);

                petStats.inventory.ownedAccessories.forEach(accId => {
                    if (AVAILABLE_ACCESSORIES[accId] && AVAILABLE_ACCESSORIES[accId].category === category) {
                        const option = document.createElement('option');
                        option.value = accId;
                        option.textContent = AVAILABLE_ACCESSORIES[accId].name;
                        select.appendChild(option);
                    }
                });
                select.value = petStats.inventory.accessories[category] || "null";
                categoryDiv.appendChild(select);
                accessorySelectionContainer.appendChild(categoryDiv);
            });
        }

        function handleSaveCustomization() {
            if (!petStats || !userProfile || !customizeMessage) return;

            const selectedColorSwatch = colorPickerContainer.querySelector('.color-swatch[style*="var(--text-color-accent)"]');
            let newPrimaryColor = petStats.colorScheme.primary;
            let colorChanged = false;

            if (selectedColorSwatch) {
                newPrimaryColor = selectedColorSwatch.dataset.colorValue;
            }
            
            if (newPrimaryColor !== petStats.colorScheme.primary) {
                 if (!userProfile.inventory.colorTickets || userProfile.inventory.colorTickets < 1) {
                    customizeMessage.textContent = "Du brauchst ein Farbticket, um die Farbe zu √§ndern!";
                    customizeMessage.style.color = "red";
                    return; 
                }
                userProfile.inventory.colorTickets--;
                petStats.colorScheme.primary = newPrimaryColor;
                const petTypeDefaultColors = AVAILABLE_PET_TYPES[petStats.petType]?.defaultColors;
                if (petTypeDefaultColors) { 
                    petStats.colorScheme.secondary = petTypeDefaultColors.secondary;
                    petStats.colorScheme.feature = petTypeDefaultColors.feature; 
                }
                saveUserProfile(); 
                colorChanged = true;
            }

            let accessoriesChanged = false;
            accessorySelectionContainer.querySelectorAll('select').forEach(select => {
                const category = select.dataset.category;
                const newAccessory = select.value === "null" ? null : select.value;
                if (petStats.inventory.accessories[category] !== newAccessory) {
                    petStats.inventory.accessories[category] = newAccessory;
                    accessoriesChanged = true;
                }
            });

            if (colorChanged || accessoriesChanged) {
                renderPetCharacter();
                savePetStats();
                customizeMessage.textContent = "Anpassungen gespeichert!";
                customizeMessage.style.color = "green";
            } else {
                customizeMessage.textContent = "Keine √Ñnderungen vorgenommen.";
                customizeMessage.style.color = "orange";
            }


            setTimeout(() => {
                if (customizePetModal && customizePetModal.style.display === 'flex') customizeMessage.textContent = '';
            }, 3000);
        }


        function handleOpenWormGame() { 
            if (!petStats || !wormGameModal || !startWormGameButton || !wormGameArea || !wormGameTimerDisplay || !wormGameScoreDisplay || !wormGameMessage) {
                console.error("Worm game DOM elements missing"); return;
            }
            wakeUpOwl(); 
            closeAllModals(); 
            wormGameModal.style.display = 'flex'; 
            wormGameMessage.textContent = '';
            wormGameScoreDisplay.textContent = "Punkte: 0";
            wormGameTimeLeft = WORM_GAME_DURATION_S; 
            wormGameTimerDisplay.textContent = `Zeit: ${wormGameTimeLeft}s`;
            startWormGameButton.disabled = false;
            wormGameArea.innerHTML = ''; 
            wormGameScore = 0;
            if(wormGameIntervalId) clearInterval(wormGameIntervalId);
            if(wormSpawnIntervalId) clearInterval(wormSpawnIntervalId);
        }
        function handleStartWormGame() { 
            if (!startWormGameButton || !wormGameArea || !wormGameTimerDisplay || !wormGameScoreDisplay || !wormGameMessage) {
                 console.error("Worm game start DOM elements missing"); return;
            }
            wormGameScore = 0;
            wormGameTimeLeft = WORM_GAME_DURATION_S;
            wormGameScoreDisplay.textContent = "Punkte: 0";
            wormGameTimerDisplay.textContent = `Zeit: ${wormGameTimeLeft}s`;
            wormGameMessage.textContent = '';
            startWormGameButton.disabled = true;
            wormGameArea.innerHTML = ''; 

            wormGameIntervalId = setInterval(() => {
                wormGameTimeLeft--;
                if(wormGameTimerDisplay) wormGameTimerDisplay.textContent = `Zeit: ${wormGameTimeLeft}s`;
                if (wormGameTimeLeft <= 0) {
                    endWormGame(true);
                }
            }, 1000);
            wormSpawnIntervalId = setInterval(spawnWorm, WORM_APPEAR_INTERVAL_MS);
            spawnWorm(); 
        }
        function spawnWorm() {  
            if (wormGameTimeLeft <= 0 || !wormGameArea) return;
            const worm = document.createElement('div');
            worm.classList.add('worm');
            for (let i = 0; i < 3; i++) {
                const segment = document.createElement('div');
                segment.classList.add('worm-segment');
                worm.appendChild(segment);
            }
            if (wormGameArea.clientHeight > 12 && wormGameArea.clientWidth > 30) {
                worm.style.top = Math.random() * (wormGameArea.clientHeight - 12) + 'px';
                worm.style.left = Math.random() * (wormGameArea.clientWidth - 30) + 'px';
            } else { 
                worm.style.top = '50px';
                worm.style.left = '50px';
            }
            wormGameArea.appendChild(worm);
            
            worm.addEventListener('click', () => {
                if (wormGameTimeLeft <=0) return; 
                wormGameScore++;
                if(wormGameScoreDisplay) wormGameScoreDisplay.textContent = `Punkte: ${wormGameScore}`;
                worm.remove();
            });
            setTimeout(() => { if (worm.parentNode) worm.remove(); }, WORM_LIFESPAN_MS);
        }
        async function endWormGame(giveReward) {  
            clearInterval(wormGameIntervalId);
            wormGameIntervalId = null;
            clearInterval(wormSpawnIntervalId);
            wormSpawnIntervalId = null;

            if(startWormGameButton) startWormGameButton.disabled = false;
            if(wormGameArea) wormGameArea.innerHTML = ''; 

            if (giveReward && petStats && userProfile) {
                let coinsEarned = Math.floor(wormGameScore / 2);
                let moodBoost = Math.min(20, wormGameScore);
                const personalityMods = PERSONALITIES[petStats.personality];

                if (petStats.personality === 'verspielt' && personalityMods.gameCoinBonus) {
                    coinsEarned += personalityMods.gameCoinBonus;
                }
                moodBoost = Math.round(moodBoost * (personalityMods.moodEffect || 1.0));
                
                userProfile.petCoins += coinsEarned;
                petStats.mood = Math.min(MAX_STAT, petStats.mood + moodBoost);
                
                if(wormGameMessage) wormGameMessage.textContent = `Spiel beendet! Du hast ${coinsEarned} ü™ô und ${moodBoost} Laune gewonnen!`;
                if (petStats.personality === 'verspielt' && personalityMods.gameCoinBonus && wormGameMessage) {
                    wormGameMessage.textContent += ` (+${personalityMods.gameCoinBonus} Bonus-ü™ô f√ºr Verspieltheit!)`;
                }
                updatePetCoinsDisplay();
                updateStatusDisplay();
                await trackQuestProgress("game_worm");
                saveUserProfile();
                savePetStats();
            } else {
                if(wormGameMessage) wormGameMessage.textContent = `Spiel abgebrochen.`;
            }
             wormGameTimeLeft = 0; 
        }
        
        function handleOpenFlightGame() { 
            if (!petStats || !flightGameModal || !startFlightGameButton || !flightGamePetContainer || !flightGameArea || !flightGameScoreDisplay || !flightGameMessage) {
                 console.error("Flight game DOM elements missing"); return;
            }
            wakeUpOwl(); 
            closeAllModals(); 
            flightGameModal.style.display = 'flex'; 
            flightGameMessage.textContent = '';
            flightGameScoreNum = 0; 
            flightGameScoreDisplay.textContent = "Punkte: 0";
            startFlightGameButton.disabled = false;
            
            flightGamePetY = flightGameArea.clientHeight > 0 ? flightGameArea.clientHeight / 2 - flightGamePetContainer.clientHeight / 2 : 100; 
            flightGamePetContainer.style.top = flightGamePetY + 'px';
            flightGamePetVelocityY = 0;

            flightGameObstacles.forEach(obs => {if (obs.element.parentNode) obs.element.remove()});
            flightGameObstacles = [];

            if (flightGamePetContainer && petStats) {
                const petTypeConfig = AVAILABLE_PET_TYPES[petStats.petType] || AVAILABLE_PET_TYPES.owl;
                let gamePetSvg = petTypeConfig.baseSvg;
                const currentColorScheme = petStats.colorScheme || petTypeConfig.defaultColors;
                gamePetSvg = gamePetSvg.replace(/class="pet-svg-body"/g, `class="pet-svg-body" fill="${currentColorScheme.primary}"`);
                flightGamePetContainer.innerHTML = gamePetSvg;
            }
             if(flightGameLoopId) cancelAnimationFrame(flightGameLoopId);
             if(flightGameObstacleSpawnId) clearInterval(flightGameObstacleSpawnId);
             flightGameActive = false;
        }
        function handleStartFlightGame() { 
            if (!startFlightGameButton || !flightGamePetContainer || !flightGameArea || !flightGameScoreDisplay || !flightGameMessage) {
                console.error("Flight game start DOM elements missing"); return;
            }
            flightGameScoreNum = 0;
            flightGameScoreDisplay.textContent = "Punkte: 0";
            flightGameMessage.textContent = '';
            startFlightGameButton.disabled = true;
            flightGameActive = true;
            
            flightGamePetY = flightGameArea.clientHeight > 0 ? flightGameArea.clientHeight / 2 - flightGamePetContainer.clientHeight / 2 : 100;
            flightGamePetContainer.style.top = flightGamePetY + 'px';
            flightGamePetVelocityY = 0;

            flightGameObstacles.forEach(obs => { if(obs.element.parentNode) obs.element.remove(); });
            flightGameObstacles = [];

            flightGameLoopId = requestAnimationFrame(flightGameLoop);
            flightGameObstacleSpawnId = setInterval(spawnFlightObstacle, FLIGHT_GAME_OBSTACLE_SPAWN_INTERVAL_MS);
            spawnFlightObstacle(); 
        }
        function handleFlightGameFlap() { 
             if (flightGameActive) {
                flightGamePetVelocityY = -FLIGHT_GAME_FLAP_STRENGTH;
            }
        }
        function spawnFlightObstacle() { 
            if (!flightGameActive || !flightGameArea) return;
            const areaHeight = flightGameArea.clientHeight;
            if (areaHeight <= 0) return; 

            const gapPosition = Math.random() * (areaHeight - FLIGHT_GAME_OBSTACLE_GAP - 60) + 30; 

            const topObstacle = document.createElement('div');
            topObstacle.classList.add('flight-obstacle');
            topObstacle.style.height = gapPosition + 'px';
            topObstacle.style.top = '0px';
            topObstacle.style.right = '-20px'; 
            flightGameArea.appendChild(topObstacle);
            flightGameObstacles.push({ element: topObstacle, x: flightGameArea.clientWidth, type: 'top', passed: false });

            const bottomObstacle = document.createElement('div');
            bottomObstacle.classList.add('flight-obstacle');
            bottomObstacle.style.height = (areaHeight - gapPosition - FLIGHT_GAME_OBSTACLE_GAP) + 'px';
            bottomObstacle.style.top = (gapPosition + FLIGHT_GAME_OBSTACLE_GAP) + 'px';
            bottomObstacle.style.right = '-20px'; 
            flightGameArea.appendChild(bottomObstacle);
            flightGameObstacles.push({ element: bottomObstacle, x: flightGameArea.clientWidth, type: 'bottom', passed: false });
        }
        function flightGameLoop() { 
            if (!flightGameActive || !flightGamePetContainer || !flightGameArea) return;

            flightGamePetVelocityY += FLIGHT_GAME_GRAVITY;
            flightGamePetY += flightGamePetVelocityY * 0.1; 

            if (flightGamePetY < 0) { flightGamePetY = 0; flightGamePetVelocityY = 0; }
            if (flightGamePetContainer.clientHeight > 0 && flightGamePetY + flightGamePetContainer.clientHeight > flightGameArea.clientHeight) {
                flightGamePetY = flightGameArea.clientHeight - flightGamePetContainer.clientHeight;
                flightGamePetVelocityY = 0;
                endFlightGame(true); 
                return;
            }
            flightGamePetContainer.style.top = flightGamePetY + 'px';

            for (let i = flightGameObstacles.length - 1; i >= 0; i--) {
                const obs = flightGameObstacles[i];
                obs.x -= FLIGHT_GAME_OBSTACLE_SPEED;
                obs.element.style.left = obs.x + 'px'; 

                const petRect = flightGamePetContainer.getBoundingClientRect();
                const obsRect = obs.element.getBoundingClientRect();
                
                if (petRect.width === 0 && petRect.height === 0) continue; // Skip collision if pet not rendered

                if (petRect.right > obsRect.left && petRect.left < obsRect.right &&
                    petRect.bottom > obsRect.top && petRect.top < obsRect.bottom) {
                    endFlightGame(true); 
                    return;
                }

                if (obs.type === 'top' && !obs.passed && obs.x + obs.element.clientWidth < petRect.left) {
                    obs.passed = true; 
                    flightGameScoreNum++;
                    if(flightGameScoreDisplay) flightGameScoreDisplay.textContent = `Punkte: ${flightGameScoreNum}`;
                }
                
                if (obs.x + obs.element.clientWidth < 0) {
                    obs.element.remove();
                    flightGameObstacles.splice(i, 1);
                }
            }
            flightGameLoopId = requestAnimationFrame(flightGameLoop);
        }
        async function endFlightGame(collided) { 
            flightGameActive = false;
            if (flightGameLoopId) cancelAnimationFrame(flightGameLoopId);
            flightGameLoopId = null;
            if (flightGameObstacleSpawnId) clearInterval(flightGameObstacleSpawnId);
            flightGameObstacleSpawnId = null;

            if(startFlightGameButton) startFlightGameButton.disabled = false;

            if (collided) {
                if(flightGameMessage) flightGameMessage.textContent = `Kollision! Endpunktzahl: ${flightGameScoreNum}.`;
            } else {
                if(flightGameMessage) flightGameMessage.textContent = `Spiel beendet. Punktzahl: ${flightGameScoreNum}.`;
            }
            
            if (petStats && userProfile) {
                const coinsEarned = flightGameScoreNum; 
                const moodBoost = Math.min(15, Math.floor(flightGameScoreNum / 2));
                const energyCost = Math.min(10, Math.floor(flightGameScoreNum / 3)); 

                userProfile.petCoins += coinsEarned;
                petStats.mood = Math.min(MAX_STAT, petStats.mood + moodBoost);
                petStats.energy = Math.max(MIN_STAT, petStats.energy - energyCost);

                if ((coinsEarned > 0 || moodBoost > 0 || energyCost > 0) && flightGameMessage) {
                    flightGameMessage.textContent += ` Du erh√§ltst ${coinsEarned} ü™ô, ${moodBoost} Laune. Es kostete ${energyCost} Energie.`;
                }
                updatePetCoinsDisplay();
                updateStatusDisplay();
                await trackQuestProgress("game_flight"); 
                saveUserProfile();
                savePetStats();
            }
        }
        
        function handleCloseUpdatePopup() {
            if(updatePopupModal) updatePopupModal.style.display = 'none';
            if (userProfile) { 
                userProfile.lastSeenVersion = GAME_VERSION;
                saveUserProfile();
            }
        }

        setInterval(() => {
            if (petStats && userId && currentPetId) { 
                recalculateStatsSinceLastUpdate();
                updateGrowthMetricsAndCheck();
                updateStatusDisplay(); 
                savePetStats(); 
            }
        }, 30000); 

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Dieser Browser unterst√ºtzt keine Desktop-Benachrichtigungen");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Benachrichtigungs-Erlaubnis erteilt.");
                    }
                });
            }
        }
        
        function showNotification(title, body, isError = false) {
            if(notificationMessageDiv) {
                notificationMessageDiv.textContent = `${title}: ${body}`;
                notificationMessageDiv.style.backgroundColor = isError ? 'var(--status-bar-hunger-fill)' : 'var(--status-bar-energy-fill)';
                notificationMessageDiv.style.color = 'white';
                notificationMessageDiv.classList.remove('hide');
                notificationMessageDiv.classList.add('show');
                setTimeout(() => {
                    notificationMessageDiv.classList.remove('show');
                    notificationMessageDiv.classList.add('hide');
                }, 4000);
            }

            if (Notification.permission === "granted") {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                     navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, {
                            body: body,
                            icon: "https://quixoticode.github.io/data/pl/favicon-96x96.png" 
                        });
                    });
                } else {
                    new Notification(title, { body: body, icon: "https://quixoticode.github.io/data/pl/favicon-96x96.png" });
                }
            }
        }

        function checkAndNotifyLowStats(energy, hunger, mood) {
            if (!petStats) return;
            if (energy > LOW_STAT_THRESHOLD + 10) petStats.notifiedLowEnergy = false;
            if (hunger > LOW_STAT_THRESHOLD + 10) petStats.notifiedLowHunger = false;
            if (mood > LOW_STAT_THRESHOLD + 10) petStats.notifiedLowMood = false;

            if (energy < LOW_STAT_THRESHOLD && !petStats.notifiedLowEnergy) {
                showNotification(`${petStats.name} ist m√ºde!`, "Die Energie ist sehr niedrig.");
                petStats.notifiedLowEnergy = true;
            }
            if (hunger < LOW_STAT_THRESHOLD && !petStats.notifiedLowHunger) {
                showNotification(`${petStats.name} hat Hunger!`, "Die S√§ttigung ist sehr niedrig.");
                petStats.notifiedLowHunger = true;
            }
            if (mood < LOW_STAT_THRESHOLD && !petStats.notifiedLowMood) {
                showNotification(`${petStats.name} ist traurig!`, "Die Laune ist sehr niedrig.");
                petStats.notifiedLowMood = true;
            }
        }
        
        async function checkAndResetQuests() {
            if (!userId || !userProfile) return; 
            const today = new Date().toISOString().split('T')[0]; 
            
            // Pr√ºfe, ob userProfile.lastQuestReset existiert und ein String ist
            if (userProfile.lastQuestReset && typeof userProfile.lastQuestReset === 'string' && userProfile.lastQuestReset === today && dailyQuests && Object.keys(dailyQuests).length > 0) {
                console.log("Quests f√ºr heute bereits geladen/initialisiert.");
                displayQuests();
                return;
            }

            const questDataRef = doc(db, `artifacts/${appId}/users/${userId}/quests/${today}`);

            try {
                const docSnap = await getDoc(questDataRef);
                if (docSnap.exists()) {
                    dailyQuests = docSnap.data().quests || initializeNewQuests();
                    console.log("Heutige Quests geladen:", dailyQuests);
                } else {
                    console.log("Keine Quests f√ºr heute gefunden, initialisiere neue.");
                    dailyQuests = initializeNewQuests();
                    await setDoc(questDataRef, { quests: dailyQuests, date: today });
                }
                userProfile.lastQuestReset = today; 
                await saveUserProfile(); 
                displayQuests(); 
            } catch (error) {
                console.error("Fehler beim Pr√ºfen/Zur√ºcksetzen der Quests:", error);
                 showNotification("Quest Fehler", "Konnte t√§gliche Quests nicht laden.", true);
            }
        }

        function initializeNewQuests() {
            const newQuests = {};
            const availableQuestKeys = Object.keys(QUEST_DEFINITIONS);
            const shuffledKeys = availableQuestKeys.sort(() => 0.5 - Math.random());
            const selectedKeys = shuffledKeys.slice(0, Math.min(3, availableQuestKeys.length)); 

            selectedKeys.forEach(key => {
                newQuests[key] = { ...QUEST_DEFINITIONS[key], currentCount: 0, completed: false, claimed: false };
            });
            return newQuests;
        }
        
        function displayQuests() {
            if (!questListContainer || !dailyQuests) return; 
            questListContainer.innerHTML = '';
            if (Object.keys(dailyQuests).length === 0) {
                questListContainer.innerHTML = '<p>Heute gibt es keine Quests. Komm morgen wieder!</p>';
                return;
            }

            for (const questId in dailyQuests) {
                const quest = dailyQuests[questId];
                const questDiv = document.createElement('div');
                questDiv.className = 'quest-item';
                const progressPercent = Math.min(100, (quest.currentCount / quest.targetCount) * 100);
                
                questDiv.innerHTML = `
                    <span class="quest-title">${quest.title}</span>
                    <p class="quest-description">${quest.description}</p>
                    <div class="quest-progress-bar">
                        <div class="quest-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <span class="text-xs">${quest.currentCount} / ${quest.targetCount}</span>
                    <p class="quest-reward">Belohnung: ${quest.rewardCoins} ü™ô</p>
                    <button class="action-button claim-quest-button text-sm py-1 px-3" data-quest-id="${questId}" ${quest.completed && !quest.claimed ? '' : 'disabled'}>
                        ${quest.claimed ? 'Abgeholt' : (quest.completed ? 'Abholen' : 'In Arbeit')}
                    </button>
                `;
                questListContainer.appendChild(questDiv);
            }
            document.querySelectorAll('.claim-quest-button').forEach(button => {
                button.addEventListener('click', handleClaimQuestReward);
            });
        }

        async function trackQuestProgress(actionType, amount = 1) {
            if (!userId || !dailyQuests || !userProfile) return; 
            let questUpdated = false;
            for (const questId in dailyQuests) {
                const quest = dailyQuests[questId];
                if (quest.actionType === actionType && !quest.completed) {
                    quest.currentCount += amount;
                    if (quest.currentCount >= quest.targetCount) {
                        quest.currentCount = quest.targetCount; 
                        quest.completed = true;
                        showNotification("Quest abgeschlossen!", `Du hast "${quest.title}" abgeschlossen!`);
                    }
                    questUpdated = true;
                }
            }
            if (questUpdated) {
                const today = userProfile.lastQuestReset || new Date().toISOString().split('T')[0]; 
                const questDataRef = doc(db, `artifacts/${appId}/users/${userId}/quests/${today}`);
                try {
                    await setDoc(questDataRef, { quests: dailyQuests, date: today }, { merge: true });
                    console.log("Quest-Fortschritt gespeichert.");
                    displayQuests(); 
                } catch (error) {
                    console.error("Fehler beim Speichern des Quest-Fortschritts:", error);
                     showNotification("Speicherfehler", "Quest-Fortschritt konnte nicht gespeichert werden.", true);
                }
            }
        }
        
        async function handleClaimQuestReward(event) {
            const questId = event.target.dataset.questId;
            if (!dailyQuests[questId] || !dailyQuests[questId].completed || dailyQuests[questId].claimed || !userProfile) {
                return;
            }
            
            const quest = dailyQuests[questId];
            userProfile.petCoins += quest.rewardCoins;
            quest.claimed = true;
            
            updatePetCoinsDisplay();
            showNotification("Belohnung erhalten!", `Du hast ${quest.rewardCoins} ü™ô f√ºr "${quest.title}" erhalten!`);
            
            const today = userProfile.lastQuestReset || new Date().toISOString().split('T')[0];
            const questDataRef = doc(db, `artifacts/${appId}/users/${userId}/quests/${today}`);
            try {
                await setDoc(questDataRef, { quests: dailyQuests, date: today }, { merge: true });
                await saveUserProfile(); 
                displayQuests(); 
            } catch (error) {
                console.error("Fehler beim Speichern des Quest-Abschlusses:", error);
                 showNotification("Speicherfehler", "Quest-Belohnung konnte nicht gespeichert werden.", true);
            }
        }

        function handleOpenQuestsModal() {
            if(!questsModal) return;
            closeAllModals();
            questsModal.style.display = 'flex';
            displayQuests(); 
        }
        
        function updateDayNightCycle() {
            if (!skyBackground || !starsContainer || !bedroomDiv) return;
            const hour = new Date().getHours();
            const isNight = hour < 6 || hour > 19; 

            if (isNight) {
                skyBackground.style.backgroundColor = 'var(--sky-night-color)';
                if (bedroomDiv.classList.contains('active')) { 
                     starsContainer.innerHTML = ''; 
                    for (let i = 0; i < 15; i++) { 
                        const star = document.createElement('div');
                        star.className = 'star';
                        star.style.width = star.style.height = (Math.random() * 2 + 1) + 'px';
                        star.style.left = Math.random() * 100 + '%';
                        star.style.top = Math.random() * 100 + '%';
                        star.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(star);
                    }
                }
                bedroomDiv.style.setProperty('--room-window-glass-color', 'var(--room-window-glass-night-color)');
            } else {
                skyBackground.style.backgroundColor = 'var(--sky-day-color)';
                starsContainer.innerHTML = ''; 
                bedroomDiv.style.setProperty('--room-window-glass-color', 'var(--room-window-glass-color)');
            }
        }
        setInterval(updateDayNightCycle, 60000); 

        async function handleOpenGalleryModal() {
            if(!galleryModal) return;
            closeAllModals();
            galleryModal.style.display = 'flex';
            if(galleryMessage) galleryMessage.textContent = '';
            loadGalleryPets();
        }

        async function loadGalleryPets() {
            if (!galleryGridContainer) return;
            galleryGridContainer.innerHTML = '<p>Lade Galerie...</p>';
            const galleryRef = collection(db, `artifacts/${appId}/public/data/galleryPets`);
            const q = query(galleryRef); // Sp√§ter ggf. mit orderBy und limit

            try {
                const querySnapshot = await getDocs(q);
                galleryGridContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    galleryGridContainer.innerHTML = '<p>Die Galerie ist noch leer. Zeige dein Haustier!</p>';
                } else {
                    querySnapshot.forEach(docSnap => {
                        const petData = docSnap.data();
                        const petTypeConfig = AVAILABLE_PET_TYPES[petData.petType] || AVAILABLE_PET_TYPES.owl;
                        const growthStageConfig = petTypeConfig.growthStages[petData.growthStage] || petTypeConfig.growthStages.baby;
                        let baseSvg = petTypeConfig.baseSvg;
                        
                        const displayColorScheme = petData.colorScheme || petTypeConfig.defaultColors;

                        baseSvg = baseSvg.replace(/class="pet-svg-body"/g, `class="pet-svg-body" fill="${displayColorScheme.primary}"`);
                        baseSvg = baseSvg.replace(/class="pet-svg-beak"/g, `class="pet-svg-beak" fill="${displayColorScheme.secondary}"`);
                        baseSvg = baseSvg.replace(/class="pet-svg-foot"/g, `class="pet-svg-foot" fill="${displayColorScheme.secondary}"`);
                        baseSvg = baseSvg.replace(/class="pet-svg-wing"/g, `class="pet-svg-wing" fill="${displayColorScheme.primary}" stroke="${displayColorScheme.feature || displayColorScheme.primary}" stroke-width="1"`);
                        baseSvg = baseSvg.replace(/class="pet-svg-feature"/g, `class="pet-svg-feature" stroke="${displayColorScheme.feature || displayColorScheme.primary}" fill="${displayColorScheme.feature || displayColorScheme.primary}"`);
                         if (petData.petType === 'cat' || petData.petType === 'dog') {
                             baseSvg = baseSvg.replace(/class="pet-svg-feature (cat-ear|dog-ear|cat-tail|dog-tail)"/g, `class="pet-svg-feature $1" fill="${displayColorScheme.primary}" stroke="${displayColorScheme.feature}"`);
                             baseSvg = baseSvg.replace(/class="pet-svg-beak (cat-nose|dog-nose)"/g, `class="pet-svg-beak $1" fill="${displayColorScheme.secondary}"`);
                        }
                         if (petData.petType === 'robot') {
                            baseSvg = baseSvg.replace(/class="pet-svg-eye-white robot-eye-light"/g, `class="pet-svg-eye-white robot-eye-light" fill="${displayColorScheme.secondary}"`);
                            baseSvg = baseSvg.replace(/class="pet-svg-arm robot-arm"/g, `class="pet-svg-arm robot-arm" fill="${displayColorScheme.primary}" stroke="${displayColorScheme.feature}" stroke-width="1"`);
                        }


                        let accessoriesHtml = "";
                        if (petData.accessories) {
                             Object.values(petData.accessories).forEach(accId => {
                                if (accId && AVAILABLE_ACCESSORIES[accId]) {
                                    accessoriesHtml += `<div class="pet-accessory-svg" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;">
                                                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                                                ${AVAILABLE_ACCESSORIES[accId].svg}
                                                            </svg>
                                                        </div>`;
                                }
                            });
                        }
                        
                        const card = document.createElement('div');
                        card.className = 'gallery-pet-card';
                        card.innerHTML = `
                            <div class="gallery-pet-svg-container" style="transform: scale(${growthStageConfig.svgScale || 1});">
                                <div style="position:absolute; top:0; left:0; width:100%; height:100%;">${baseSvg}</div>
                                ${accessoriesHtml}
                            </div>
                            <p class="gallery-pet-name">${petData.name}</p>
                            <p class="gallery-pet-owner">Besitzer: ${petData.ownerId ? petData.ownerId.substring(0,6)+'...' : 'Anonym'}</p>
                        `;
                        galleryGridContainer.appendChild(card);
                    });
                }
            } catch (error) {
                console.error("Fehler beim Laden der Galerie:", error);
                galleryGridContainer.innerHTML = '<p>Fehler beim Laden der Galerie.</p>';
                showNotification("Fehler", "Konnte Galerie nicht laden.", true);
            }
        }
        
        async function handleShowMyPetInGallery() {
            if (!petStats || !userId || !userProfile || !galleryMessage) {
                if(galleryMessage) {
                    galleryMessage.textContent = "Du musst angemeldet sein und ein aktives Haustier haben.";
                    galleryMessage.style.color = "red";
                }
                return;
            }
            const cost = 5;
            if (userProfile.petCoins < cost) {
                galleryMessage.textContent = `Du brauchst ${cost} ü™ô um dein Tier zu zeigen.`;
                galleryMessage.style.color = "red";
                return;
            }

            userProfile.petCoins -= cost;
            updatePetCoinsDisplay();
            await saveUserProfile();

            const petDataForGallery = {
                name: petStats.name,
                petType: petStats.petType,
                growthStage: petStats.growthStage,
                colorScheme: petStats.colorScheme,
                accessories: petStats.inventory.accessories,
                ownerId: userId, 
                showcasedAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/galleryPets`), petDataForGallery);
                galleryMessage.textContent = `${petStats.name} wird jetzt in der Galerie gezeigt!`;
                galleryMessage.style.color = "green";
                loadGalleryPets(); 
            } catch (error) {
                console.error("Fehler beim Hinzuf√ºgen zur Galerie:", error);
                galleryMessage.textContent = "Fehler beim Zeigen des Haustiers.";
                galleryMessage.style.color = "red";
                userProfile.petCoins += cost; // Refund
                updatePetCoinsDisplay();
                saveUserProfile();
                 showNotification("Fehler", "Konnte Haustier nicht zur Galerie hinzuf√ºgen.", true);
            }
        }
        requestNotificationPermission(); 
    </script>
</body>
</html>
