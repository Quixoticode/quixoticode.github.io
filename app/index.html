<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QHub v2.2 - Dein persönlicher Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    
    <link rel="icon" type="image/svg+xml" href="https://quixoticode.github.io/data/qhub/favicon.svg" />
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAgICJuYW1lIjogIlFIdWIgVjIuMSIsICJzaG9ydF9uYW1lIjogIlFIdWIiLCAiZGVzY3JpcHRpb24iOiAiRGVpbiBwZXJzw7ZubGljaGVyIEh1YiBtaXQgUHJlbWl1bS1GdW5rdGlvbmVuIiwgImljb25zIjogW3sic3JjIjogImh0dHBzOi8vcXVpeG90aWNvZGUuZ2l0aHViLmlvL2RhdGEvcWh1Yi9hbmRyb2lkLWNocm9tZS0xOTJ4MTkyLnBuZyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIn0sIHsic3JjIjogImh0dHBzOi8vcXVpeG90aWNvZGUuZ2l0aHViLmlvL2RhdGEvcWh1Yi9hbmRyb2lkLWNocm9tZS01MTJ4NTEyLnBuZyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIn1dLA0KICAgICJzdGFydF91cmwiOiAiLi8iLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsICJ0aGVtZV9jb2xvciI6ICIjNGY0NmU1Ig0KfQ==">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="QHub">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" id="themeColorMeta" content="#4f46e5">

    <style>
        :root {
            --font-family-sans: 'Inter', sans-serif;
            --q-primary: #4f46e5; --q-primary-hover: #4338ca; --q-primary-text: #ffffff;
            --q-background: #f1f5f9; --q-surface: #ffffff;
            --q-on-surface: #1e293b; --q-on-surface-variant: #64748b; --q-outline: #cbd5e1;
            --q-highlight: #e0e7ff; --q-highlight-text: #3730a3; --q-danger: #dc2626;
            --q-premium: #f59e0b; --q-on-premium: #ffffff;
            --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-full: 9999px;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --activity-bar-width: 60px; --sidebar-width: 280px;
            --header-height: 64px; --transition-speed: 0.3s;
        }
        [data-theme="dark"] { --q-primary: #6366f1; --q-primary-hover: #4f46e5; --q-background: #0f172a; --q-surface: #1e293b; --q-on-surface: #e2e8f0; --q-on-surface-variant: #94a3b8; --q-outline: #334155; --q-highlight: #312e81; --q-highlight-text: #c7d2fe; --q-premium: #fcd34d; --q-on-premium: #1e293b; }
        [data-theme="forest"] { --q-primary: #166534; --q-primary-hover: #14532d; --q-background: #f0fdf4; --q-surface: #ffffff; --q-on-surface: #1e293b; --q-highlight: #dcfce7; --q-highlight-text: #14532d; }
        [data-theme="ocean"] { --q-primary: #0369a1; --q-primary-hover: #075985; --q-background: #f0f9ff; --q-surface: #ffffff; --q-on-surface: #1e293b; --q-highlight: #e0f2fe; --q-highlight-text: #075985; }
        [data-theme="sunset"] { --q-primary: #e11d48; --q-primary-hover: #be123c; --q-background: #fff1f2; --q-surface: #ffffff; --q-on-surface: #1e293b; --q-highlight: #ffe4e6; --q-highlight-text: #9f1239; }
        [data-theme="mint"] { --q-primary: #059669; --q-primary-hover: #047857; --q-background: #f0fdfa; --q-surface: #ffffff; --q-on-surface: #1e293b; --q-highlight: #ccfbf1; --q-highlight-text: #065f46; }
        [data-theme="slate"] { --q-primary: #7e22ce; --q-primary-hover: #6b21a8; --q-background: #f8fafc; --q-surface: #ffffff; --q-on-surface: #0f172a; --q-highlight: #f3e8ff; --q-highlight-text: #6b21a8; }
        [data-theme="candy"] { --q-primary: #db2777; --q-primary-hover: #be185d; --q-background: #fdf2f8; --q-surface: #ffffff; --q-on-surface: #1e293b; --q-highlight: #fce7f3; --q-highlight-text: #9d174d; }
        body { font-family: var(--font-family-sans); background-color: var(--q-background); color: var(--q-on-surface); overflow: hidden; }
        .q-app-container { display: flex; height: 100vh; }
        .q-activity-bar { width: var(--activity-bar-width); flex-shrink: 0; background-color: var(--q-surface); border-right: 1px solid var(--q-outline); display: flex; flex-direction: column; align-items: center; padding: 1rem 0; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); gap: 0.5rem; z-index: 1100; }
        .activity-btn { position: relative; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); color: var(--q-on-surface-variant); cursor: pointer; transition: all 0.2s; }
        .activity-btn:hover { background-color: var(--q-highlight); color: var(--q-highlight-text); }
        .activity-btn.active { background-color: var(--q-primary); color: var(--q-primary-text); }
        .q-sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--q-surface); border-right: 1px solid var(--q-outline); padding: 1.5rem; display: flex; flex-direction: column; z-index: 1000; transition: transform var(--transition-speed) ease; }
        .q-main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        .q-header { height: var(--header-height); flex-shrink: 0; background-color: var(--q-surface); border-bottom: 1px solid var(--q-outline); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; z-index: 900; }
        .q-content-area { flex-grow: 1; overflow-y: auto; padding: 2rem; }
        .webapp-container, .webapp-container iframe { width: 100%; height: 100%; border: none; background-color: #fff; }
        .q-card { background-color: var(--q-surface); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--q-outline); }
        .q-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 5000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; padding: 1rem; }
        .q-modal-backdrop.visible { display: flex; opacity: 1; }
        .q-modal-content { background-color: var(--q-surface); padding: 2rem; border-radius: var(--radius-lg); max-width: 500px; width: 100%; }
        @media (max-width: 768px) {
            .q-modal-backdrop.visible { overflow-y: auto; align-items: flex-start; }
            .q-modal-content { width: 95%; margin-top: 5vh; max-height: 90vh; overflow-y: auto; padding: 1.5rem; }
        }
        @media (max-width: 768px) { 
            .q-sidebar { position: fixed; left: var(--activity-bar-width); height: 100%; transform: translateX(-100%); } 
            .q-sidebar.open { transform: translateX(0); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); } 
            .q-header { padding: 0 1rem; }
            .q-content-area { padding: 1rem; }
            #mainContentArea h2.text-2xl { font-size: 1.25rem; }
        }
        .premium-badge { display: inline-flex; align-items: center; gap: 0.25rem; background-color: var(--q-premium); color: var(--q-on-premium); padding: 0.1rem 0.5rem; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .q-input { width: 100%; padding: 0.5rem 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--q-outline); background-color: var(--q-background); }
        .timeline { border-left: 2px solid var(--q-outline); margin-left: 1rem; padding-left: 1.5rem; }
        .timeline-item { position: relative; padding-bottom: 2rem; } .timeline-item:last-child { padding-bottom: 0; }
        .timeline-icon { position: absolute; left: -2.25rem; top: 0; width: 2rem; height: 2rem; background-color: var(--q-highlight); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .timeline-icon .material-icons { color: var(--q-highlight-text); font-size: 1.25rem; }
        .progress-bar-bg { background-color: var(--q-highlight); border-radius: var(--radius-full); }
        .progress-bar-fill { background-color: var(--q-primary); transition: width 0.5s ease; }
    </style>
</head>
<body>

    <div class="q-app-container">
        <div class="q-activity-bar" id="activityBar">
            <button class="activity-btn" data-view="dashboard" title="Dashboard"><span class="material-icons">dashboard</span></button>
            <button class="activity-btn" data-view="qcode" title="QCode Lernplattform"><span class="material-icons">school</span></button>
            <button class="activity-btn" data-view="qsounds" title="QSounds"><span class="material-icons">graphic_eq</span></button>
            <button class="activity-btn" data-view="status" title="Statuspage"><span class="material-icons">error</span></button>
            <div class="mt-auto"><button class="activity-btn" id="settingsBtn" title="Einstellungen"><span class="material-icons">settings</span></button></div>
        </div>
        <aside class="q-sidebar hidden" id="qHubSidebar"></aside>
        <div class="q-main-content">
            <header class="q-header">
                <button id="mobileMenuBtn" class="md:hidden p-2"><span class="material-icons">menu</span></button>
                <div id="headerTitle" class="text-xl font-bold"></div>
                <div class="relative w-full max-w-md hidden" id="searchContainer">
                     <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="globalSearchInput" placeholder="Suchen..." class="w-full pl-10 pr-4 py-2 rounded-full border" style="background-color: var(--q-background); border-color: var(--q-outline);">
                </div>
            </header>
            <div class="q-content-area" id="mainContentArea"></div>
        </div>
    </div>

    <div id="settingsModal" class="q-modal-backdrop"></div>
    <div id="changelogModal" class="q-modal-backdrop"></div>
    <div id="toastContainer" class="fixed bottom-5 right-5 z-[6000] space-y-2"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // GEÄNDERT: Version auf 2.2.0 für das Push-Update erhöht
        const APP_PREFIX = 'qhub_v2.2_';
        const SETTINGS_KEY = APP_PREFIX + 'settings';
        const USER_DATA_KEY = APP_PREFIX + 'user_data';
        const APP_VERSION = "2.2.0";

        // --- ANFANG: PUSH NOTIFICATION LOGIK ---

        // WICHTIG: Ersetze diese URL durch die deines echten Servers!
        const PUSH_SERVER_URL = 'https://https.quixoticode.de:3000';

        /**
         * Initialisiert den gesamten Push-Benachrichtigungsprozess.
         */
        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                showToast('Push-Benachrichtigungen werden von diesem Browser nicht unterstützt.', 'error');
                return;
            }

            try {
                // 1. Service Worker registrieren
                const registration = await navigator.serviceWorker.register('./sw.js');
                console.log('Service Worker für Push registriert.');

                // 2. Warten bis der SW aktiv ist
                await navigator.serviceWorker.ready;
                console.log('Service Worker ist aktiv.');
                
                // 3. Nach der Berechtigung fragen
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showToast('Berechtigung für Benachrichtigungen wurde nicht erteilt.', 'info');
                    return;
                }
                
                // 4. Den Public Key vom Server abrufen
                const response = await fetch(`${PUSH_SERVER_URL}/vapidPublicKey`);
                if (!response.ok) throw new Error('VAPID Key konnte nicht vom Server geladen werden.');
                const publicVapidKey = await response.text();

                // 5. Den Nutzer für Push-Nachrichten "abonnieren"
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
                });
                console.log('Push-Abonnement erfolgreich erstellt:', subscription);
                
                // 6. Das Abonnement an den Server senden
                await sendSubscriptionToServer(subscription);
                showToast('Benachrichtigungen erfolgreich aktiviert!', 'success');
                
            } catch (error) {
                console.error('Fehler während der Push-Initialisierung:', error);
                showToast(error.message || 'Aktivierung der Benachrichtigungen fehlgeschlagen.', 'error');
            }
        }

        /**
         * Sendet das Abonnement-Objekt an den Backend-Server.
         * @param {PushSubscription} subscription
         */
        async function sendSubscriptionToServer(subscription) {
            try {
                const response = await fetch(`${PUSH_SERVER_URL}/subscribe`, {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Server hat nicht erfolgreich geantwortet.');
                console.log('Abonnement erfolgreich an den Server gesendet.');
            } catch (error) {
                console.error('Fehler beim Senden des Abonnements an den Server:', error);
                // Hier könntest du dem Nutzer auch Feedback geben
            }
        }

        /**
         * Konvertiert einen Base64-String in ein Uint8Array,
         * was für den applicationServerKey benötigt wird.
         */
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // --- ENDE: PUSH NOTIFICATION LOGIK ---


        const initialUserData = {
            version: APP_VERSION,
            announcements: [
                { id: "news-1", title: "Willkommen zu QHub 2.1!", content: "Entdecke das neue Premium-System und die App-Integrationen.", date: "2025-06-20", premium: false },
                { id: "news-2", title: "Exklusiver Einblick in v2.2", content: "Als Premium-Nutzer siehst du hier exklusive Details zum nächsten großen Update, das einen Notizblock mit Markdown-Unterstützung bringen wird.", date: "2025-06-20", premium: true },
            ],
            roadmap: [
                { id: "rm-1", title: 'v2.3: Admin-Update', description: 'Update des Benutzersystems', status: 'in-progress', progress: 5 },
                { id: "rm-2", title: 'v2.4: Kalender-Widget', description: 'Ein einfacher Kalender zur Terminübersicht direkt auf dem Dashboard.', status: 'planned', progress: 0 },
            ],
            changelog: [
                { version: "2.2.0", date: "2025-06-21", changes: ["Push-Benachrichtigungen für Updates und Ankündigungen hinzugefügt.", "Neuer Button in den Einstellungen zur Aktivierung der Benachrichtigungen.", "Allgemeine Leistungsverbesserungen."] },
                { version: "2.1.2", date: "2025-06-20", changes: ["Behebt ein Problem, bei dem der Einstellungs-Button auf mobilen Geräten nicht klickbar war.", "Layout an den sicheren Anzeigebereich (Safe Area) von mobilen Geräten angepasst."] },
                { version: "2.1.1", date: "2025-06-20", changes: ["Verbesserte Mobilansicht für Header und Inhaltsbereiche.", "Optimierte Darstellung der Einstellungs- & Changelog-Modals auf kleinen Bildschirmen."] },
            ],
        };
        
        const defaultSettings = {
            version: APP_VERSION,
            userName: "Gast",
            userAvatar: `https://placehold.co/96x96/e0e7ff/3730a3?text=Guest`,
            theme: "light",
            activeView: "dashboard",
            premium: { active: false, type: null, user: null },
            dashboard: {
                sectionOrder: ["announcements", "roadmap", "changelog"],
                layout: "1",
            },
            lastSeenVersion: "0.0.0"
        };

        let settings = {};
        let userData = {};
        const dom = { activityBar: document.getElementById('activityBar'), mainContentArea: document.getElementById('mainContentArea'), headerTitle: document.getElementById('headerTitle'), searchContainer: document.getElementById('searchContainer'), qHubSidebar: document.getElementById('qHubSidebar'), mobileMenuBtn: document.getElementById('mobileMenuBtn'), };

        function init() {
            loadState();
            applyTheme();
            renderView(settings.activeView, true);
            setupEventListeners();
            checkChangelog();
        }
        init();

        function loadState() {
            const storedSettings = localStorage.getItem(SETTINGS_KEY);
            settings = storedSettings ? { ...defaultSettings, ...JSON.parse(storedSettings) } : { ...defaultSettings };
            const storedData = localStorage.getItem(USER_DATA_KEY);
            userData = storedData ? JSON.parse(storedData) : { ...initialUserData };
        }
        function saveSettings() {
            settings.version = APP_VERSION;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function renderView(viewId, isInitialLoad = false) {
            if (!isInitialLoad && settings.activeView === viewId) return;
            dom.activityBar.querySelectorAll('.activity-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewId));
            dom.qHubSidebar.classList.remove('open');
            dom.qHubSidebar.classList.add('hidden');
            dom.searchContainer.classList.add('hidden');
            dom.mobileMenuBtn.classList.add('hidden');
            settings.activeView = viewId;
            
            switch(viewId) {
                case 'dashboard':
                    dom.headerTitle.textContent = "Dashboard";
                    dom.searchContainer.classList.remove('hidden');
                    dom.mobileMenuBtn.classList.remove('hidden');
                    dom.qHubSidebar.classList.remove('hidden');
                    renderDashboardSidebar();
                    renderDashboardContent();
                    break;
                case 'qcode':
                    dom.headerTitle.textContent = "QCode Lernplattform";
                    dom.mainContentArea.innerHTML = `<div class="webapp-container"><iframe src="https://quixoticode.github.io/app/QCode/"></iframe></div>`;
                    break;
                case 'qsounds':
                    dom.headerTitle.textContent = "QSounds";
                    dom.mainContentArea.innerHTML = `<div class="webapp-container"><iframe src="https://quixoticode.github.io/app/QSounds/"></iframe></div>`;
                    break;
                case 'status':
                    dom.headerTitle.textContent = "StatusPage";
                    dom.mainContentArea.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-4"><div class="q-card max-w-md"><span class="material-icons text-6xl text-gray-400 mb-4">link_off</span><h2 class="text-xl font-bold mb-2">Die Status-Seite kann nicht eingebettet werden.</h2><p class="text-gray-600 dark:text-gray-300 mb-6">Aus Sicherheitsgründen blockiert der Server die Anzeige in iFrames. Du kannst die Seite stattdessen direkt aufrufen.</p><a href="https://status.quixoticode.de/status/network" target="_blank" class="inline-block px-6 py-3 rounded-lg text-white font-semibold transition" style="background-color: var(--q-primary); color: var(--q-primary-text);">Status-Seite öffnen</a></div></div>`;
                    break;
            }
            saveSettings();
        }

        function applyTheme() { document.documentElement.setAttribute('data-theme', settings.theme); }
        
        function renderDashboardSidebar() {
             dom.qHubSidebar.innerHTML = `<div class="flex items-center gap-3 mb-8"><span class="material-icons text-3xl" style="color: var(--q-primary);">hub</span><h1 class="text-2xl font-bold">QHub</h1></div><div class="p-4 rounded-lg mb-6 text-center" style="background-color: var(--q-highlight);"><img src="${settings.userAvatar}" class="w-16 h-16 rounded-full mx-auto mb-2 border-2 border-white shadow-md cursor-pointer" id="avatarImg"><div class="flex items-center justify-center gap-2 mt-2"><h2 class="font-bold text-lg" style="color: var(--q-highlight-text);">${settings.userName}</h2>${settings.premium.active ? `<div class="premium-badge" title="Premium-Status: ${settings.premium.type}"><span class="material-icons text-xs">star</span></div>` : ''}</div></div><nav class="flex-grow"><h3 class="px-3 text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Sektionen</h3>${settings.dashboard.sectionOrder.map(id => `<a href="#section-${id}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 capitalize">${id}</a>`).join('')}</nav>`;
        }

        function renderDashboardContent() {
            dom.mainContentArea.innerHTML = `<div id="sectionsContainer" class="space-y-8"></div>`;
            const sectionsContainer = document.getElementById('sectionsContainer');
            const layoutClasses = { '1': 'grid-cols-1', '2': 'md:grid-cols-2', '3': 'lg:grid-cols-3' };
            sectionsContainer.className = `grid gap-6 ${layoutClasses[settings.dashboard.layout] || 'grid-cols-1 md:grid-cols-2'}`;
            const sectionMap = {
                announcements: { title: 'Ankündigungen', icon: 'campaign', renderer: renderAnnouncementsContent },
                roadmap: { title: 'Roadmap', icon: 'signpost', renderer: renderRoadmapContent },
                changelog: { title: 'Changelog', icon: 'history', renderer: renderChangelogContent },
            };
            sectionsContainer.innerHTML = settings.dashboard.sectionOrder.map(id => sectionMap[id] ? createSectionHTML(id, sectionMap[id].title, sectionMap[id].icon, sectionMap[id].renderer) : '').join('');
        }
        
        function createSectionHTML(id, title, icon, contentRenderer) {
            return `<section id="section-${id}" data-section-id="${id}"><div class="flex items-center justify-between mb-4 p-2 rounded-lg"><h2 class="text-2xl font-bold flex items-center gap-3"><span class="material-icons text-3xl" style="color: var(--q-primary);">${icon}</span>${title}</h2></div><div>${contentRenderer()}</div></section>`;
        }

        function renderAnnouncementsContent() {
            const items = (userData.announcements || []).filter(item => !item.premium || (item.premium && settings.premium.active));
            return `<div class="space-y-4">${items.map(item => `<div class="q-card"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-lg">${item.title}</h3>${item.premium ? `<div class="premium-badge"><span class="material-icons text-xs">star</span> Premium</div>` : ''}</div><p class="text-gray-600 mt-1">${item.content}</p><p class="text-xs text-gray-400 mt-4">${new Date(item.date).toLocaleDateString('de-DE')}</p></div>`).join('') || '<div class="q-card text-gray-500">Keine Ankündigungen vorhanden.</div>'}</div>`;
        }

        function renderRoadmapContent() {
            const iconMap = { 'in-progress': 'construction', 'planned': 'flag', 'completed': 'check_circle' };
            return `<div class="q-card"><div class="timeline">${(userData.roadmap || []).map(item => `<div class="timeline-item"><div class="timeline-icon"><span class="material-icons">${iconMap[item.status] || 'info'}</span></div><h4 class="font-bold text-lg">${item.title}</h4><p class="text-gray-600 mt-1">${item.description}</p>${item.status !== 'completed' ? `<div class="mt-2"><div class="flex justify-between text-sm mb-1"><span>Fortschritt</span><span>${item.progress}%</span></div><div class="w-full progress-bar-bg h-2 rounded-full overflow-hidden"><div class="h-2 progress-bar-fill" style="width: ${item.progress}%;"></div></div></div>` : ''}</div>`).join('') || '<div class="text-gray-500">Keine Roadmap-Einträge vorhanden.</div>'}</div></div>`;
        }
        
        function renderChangelogContent() {
             return `<div class="q-card space-y-6">${(userData.changelog || []).map(item => `<div><h4 class="font-bold text-lg">Version ${item.version} <span class="text-sm font-normal text-gray-500">- ${new Date(item.date).toLocaleDateString('de-DE')}</span></h4><ul class="list-disc list-inside mt-2 text-sm text-gray-600 space-y-1">${(item.changes || []).map(change => `<li>${change}</li>`).join('')}</ul></div>`).join('') || '<div class="text-gray-500">Kein Changelog vorhanden.</div>'}</div>`;
        }
        
        function setupEventListeners() {
            dom.activityBar.addEventListener('click', e => {
                const btn = e.target.closest('.activity-btn[data-view]');
                if (btn) renderView(btn.dataset.view);
            });
            document.getElementById('settingsBtn').addEventListener('click', renderAndShowSettingsModal);
            dom.mobileMenuBtn.addEventListener('click', () => dom.qHubSidebar.classList.toggle('open'));
        }
        
        function renderAndShowSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const themeOptions = ['light', 'dark', 'forest', 'ocean', 'sunset', 'mint', 'slate', 'candy'];
            modal.innerHTML = `
                <div class="q-modal-content">
                    <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Einstellungen</h2><button id="closeSettingsModal" class="p-2 rounded-full hover:bg-gray-200">&times;</button></div>
                    <div class="mt-6 border-t border-gray-200 pt-6 space-y-6">
                        <!-- Premium Sektion -->
                        <div><label class="font-semibold block mb-2">Premium-Status</label>${settings.premium.active ? `<div class="p-4 rounded-md bg-green-100 text-green-800 text-center">Premium ist aktiv! (Typ: ${settings.premium.type})</div>` : `<div class="space-y-4 p-4 border rounded-md"><h4 class="font-medium">Premium aktivieren</h4><div><label class="text-sm">Benutzername</label><input id="premiumUser" type="text" class="q-input mt-1" placeholder="Optional"></div><div><label class="text-sm">Passwort / Einmal-Code</label><input id="premiumCode" type="password" class="q-input mt-1"></div><button id="activatePremiumBtn" class="w-full p-2 text-center bg-blue-600 text-white rounded-md hover:bg-blue-700">Aktivieren</button><p class="text-xs text-gray-500 mt-2">Um einen Benutzer-Account zu erhalten, sende eine E-Mail an: <b class="font-mono">quixoticode@proton.me</b></p></div>`}</div>
                        <!-- Theme Sektion -->
                        <div><label class="font-semibold block mb-2">Theme</label><select id="themeSelector" class="q-input">${themeOptions.map(t => `<option value="${t}" class="capitalize">${t}</option>`).join('')}</select></div>
                        
                        <!-- HINZUGEFÜGT: Benachrichtigungs-Sektion -->
                        <div>
                            <label class="font-semibold block mb-2">Benachrichtigungen</label>
                            <div class="flex gap-4">
                                <button id="activatePushBtn" class="w-full p-2 text-center border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center gap-2">
                                    <span class="material-icons">notifications_active</span>
                                    <span>Push-Benachrichtigungen aktivieren</span>
                                </button>
                            </div>
                        </div>

                        <!-- Daten-Management Sektion -->
                        <div><label class="font-semibold block mb-2">Daten-Management</label><div class="flex gap-4"><button id="exportBtn" class="w-full p-2 text-center border rounded-md hover:bg-gray-100">Exportieren</button></div></div>
                    </div>
                </div>`;
            
            // Event Listeners für das Modal
            modal.querySelector('#themeSelector').value = settings.theme;
            modal.querySelector('#closeSettingsModal').addEventListener('click', () => toggleModal('settingsModal', false));
            modal.querySelector('#themeSelector').addEventListener('change', (e) => { settings.theme = e.target.value; applyTheme(); saveSettings(); });
            modal.querySelector('#exportBtn')?.addEventListener('click', () => { /* Export-Logik hier */ }); 
            modal.querySelector('#activatePremiumBtn')?.addEventListener('click', handlePremiumActivation);

            // HINZUGEFÜGT: Event Listener für den Push-Button
            modal.querySelector('#activatePushBtn')?.addEventListener('click', initPushNotifications);

            toggleModal('settingsModal', true);
        }

        async function handlePremiumActivation() {
            // ... (unveränderte Funktion)
        }
        
        function checkChangelog() {
            const lastVersion = settings.lastSeenVersion;
            if (lastVersion !== APP_VERSION) {
                const modal = document.getElementById('changelogModal');
                const latestChangelog = userData.changelog[0]; 
                 modal.innerHTML = `
                 <div class="q-modal-content">
                    <h2 class="text-2xl font-bold mb-4">Willkommen zu Version ${latestChangelog.version}!</h2>
                    <div class="text-sm text-gray-500 mb-4">Was ist neu seit Version ${lastVersion || 'unbekannt'}?</div>
                    <ul class="list-disc list-inside space-y-2 my-6">${latestChangelog.changes.map(change => `<li>${change}</li>`).join('')}</ul>
                    <div class="flex justify-end"><button id="closeChangelogModal" class="px-4 py-2 bg-blue-600 text-white rounded-md">Verstanden!</button></div>
                 </div>`;
                modal.querySelector('#closeChangelogModal').addEventListener('click', () => {
                    toggleModal('changelogModal', false)
                    settings.lastSeenVersion = APP_VERSION;
                    saveSettings();
                });
                toggleModal('changelogModal', true);
            }
        }
        function toggleModal(modalId, show) { document.getElementById(modalId).classList.toggle('visible', show); }
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            toast.className = `px-4 py-2 rounded-md text-white shadow-lg transition-opacity duration-300 ${colors[type] || 'bg-gray-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    });
    </script>
</body>
</html>
