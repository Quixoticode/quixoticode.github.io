<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>QHub v2.0 - Dein persönlicher Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEU: SortableJS für Drag & Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="https://quixoticode.github.io/data/qhub/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://quixoticode.github.io/data/qhub/apple-touch-icon.png" />
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAgICJuYW1lIjogIlFIdWIgVjIuMSIsDQogICAgInNob3J0X25hbWUiOiAiUUh1YiIsDQogICAgImRlc2NyaXB0aW9uIjogIkRlaW4gcGVyc8O2bmxpY2hlciBIdWIiLA0KICAgICJpY29ucyI6IFsNCiAgICAgICAgew0KICAgICAgICAgICAgInNyYyI6ICJodHRwczovL3F1aXhvdGljb2RlLmdpdGh1Yi5pby9kYXRhL3FodWIvYW5kcm9pZC1jaHJvbWUtMTkyeDE5Mi5wbmciLA0KICAgICAgICAgICAgInNpemVzIjogIjE5MngxOTIiLA0KICAgICAgICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIg0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgICAic3JjIjogImh0dHBzOi8vcXVpeG90aWNvZGUuZ2l0aHViLmlvL2RhdGEvcWh1Yi9hbmRyb2lkLWNocm9tZS01MTJ4NTEyLnBuZyIsDQogICAgICAgICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsDQogICAgICAgICAgICAidHlwZSI6ICJpbWFnZS9wbmciDQogICAgICAgIH0NCiAgICBdLA0KICAgICJzdGFydF91cmwiOiAiL2FwcC9RSHViLyIsDQogICAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsDQogICAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsDQogICAgInRoZW1lX2NvbG9yIjogIiM0ZjQ2ZTUiDQp9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="QHub">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" id="themeColorMeta" content="#4f46e5">

    <style>
        :root {
            --font-family-sans: 'Inter', sans-serif;
            
            /* --- Light Theme (Default) --- */
            --q-primary: #4f46e5; /* Indigo 600 */
            --q-primary-hover: #4338ca; /* Indigo 700 */
            --q-primary-text: #ffffff;
            --q-secondary: #64748b; /* Slate 500 */
            --q-background: #f1f5f9; /* Slate 100 */
            --q-surface: #ffffff;
            --q-on-surface: #1e293b; /* Slate 800 */
            --q-on-surface-variant: #64748b; /* Slate 500 */
            --q-outline: #cbd5e1; /* Slate 300 */
            --q-highlight: #e0e7ff; /* Indigo 100 */
            --q-highlight-text: #3730a3; /* Indigo 800 */
            --q-danger: #dc2626; /* Red 600 */
            --q-danger-hover: #b91c1c; /* Red 700 */
            
            --radius-sm: 0.375rem; --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1.5rem; --radius-full: 9999px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --sidebar-width: 280px;
            --header-height: 64px;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --q-primary: #6366f1; --q-primary-hover: #4f46e5; --q-primary-text: #ffffff;
            --q-secondary: #94a3b8; --q-background: #0f172a; --q-surface: #1e293b; --q-on-surface: #e2e8f0;
            --q-on-surface-variant: #94a3b8; --q-outline: #334155; --q-highlight: #312e81; --q-highlight-text: #c7d2fe;
            --q-danger: #ef4444; --q-danger-hover: #dc2626;
        }
        
        [data-theme="forest"] {
            --q-primary: #166534; --q-primary-hover: #14532d; --q-background: #f0fdf4; --q-surface: #ffffff;
            --q-on-surface: #1e293b; --q-highlight: #dcfce7; --q-highlight-text: #14532d;
        }
        [data-theme="ocean"] {
            --q-primary: #0369a1; --q-primary-hover: #075985; --q-background: #f0f9ff; --q-surface: #ffffff;
            --q-on-surface: #1e293b; --q-highlight: #e0f2fe; --q-highlight-text: #075985;
        }
        /* NEU: Weitere Themes */
        [data-theme="mint"] {
            --q-primary: #047857; --q-primary-hover: #065f46; --q-background: #ecfdf5; --q-surface: #ffffff;
            --q-on-surface: #1e293b; --q-highlight: #d1fae5; --q-highlight-text: #065f46;
        }
        [data-theme="rose"] {
            --q-primary: #be123c; --q-primary-hover: #9f1239; --q-background: #fff1f2; --q-surface: #ffffff;
            --q-on-surface: #1e293b; --q-highlight: #ffe4e6; --q-highlight-text: #9f1239;
        }
        [data-theme="slate-dark"] {
             --q-primary: #7e22ce; --q-primary-hover: #6b21a8; --q-background: #1e293b; --q-surface: #334155; --q-on-surface: #e2e8f0;
            --q-on-surface-variant: #94a3b8; --q-outline: #475569; --q-highlight: #4c1d95; --q-highlight-text: #d8b4fe;
        }

        body { font-family: var(--font-family-sans); background-color: var(--q-background); color: var(--q-on-surface); transition: background-color var(--transition-speed), color var(--transition-speed); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; }
        .q-main-container { display: flex; height: 100vh; }
        .q-sidebar { width: var(--sidebar-width); background-color: var(--q-surface); border-right: 1px solid var(--q-outline); padding: 1.5rem; display: flex; flex-direction: column; transition: transform var(--transition-speed) ease, width var(--transition-speed) ease; transform: translateX(0); position: fixed; height: 100%; z-index: 1000; }
        .q-content-area { flex-grow: 1; padding: 2rem; padding-top: calc(var(--header-height) + 2rem); margin-left: var(--sidebar-width); height: 100vh; overflow-y: auto; transition: margin-left var(--transition-speed) ease; }
        @media (max-width: 768px) { .q-sidebar { transform: translateX(-100%); } .q-sidebar.open { transform: translateX(0); } .q-content-area { margin-left: 0; } }
        .q-header { position: fixed; top: 0; left: var(--sidebar-width); right: 0; height: var(--header-height); background-color: var(--q-surface); border-bottom: 1px solid var(--q-outline); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; z-index: 900; transition: left var(--transition-speed) ease; }
        @media (max-width: 768px) { .q-header { left: 0; } }
        .q-card { background-color: var(--q-surface); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--q-outline); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .q-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .q-button { display: inline-flex; align-items: center; justify-content: center; padding: 0.6rem 1.2rem; border-radius: var(--radius-md); font-weight: 500; text-decoration: none; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
        .q-button-primary { background-color: var(--q-primary); color: var(--q-primary-text); } .q-button-primary:hover { background-color: var(--q-primary-hover); }
        .q-button-secondary { background-color: transparent; color: var(--q-on-surface); border: 1px solid var(--q-outline); } .q-button-secondary:hover { background-color: var(--q-highlight); border-color: var(--q-highlight); }
        .q-button-danger { background-color: var(--q-danger); color: white; } .q-button-danger:hover { background-color: var(--q-danger-hover); }
        .q-button .material-icons { margin-right: 0.5rem; }
        .q-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 5000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .q-modal-backdrop.visible { opacity: 1; visibility: visible; }
        .q-modal-content { background-color: var(--q-surface); padding: 2rem; border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); max-width: 90%; width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .q-modal-backdrop.visible .q-modal-content { transform: scale(1); }
        
        /* NEU: Styles für neue Features */
        .text-size-sm { font-size: 0.875rem; } .text-size-md { font-size: 1rem; } .text-size-lg { font-size: 1.125rem; }
        .read-item { opacity: 0.6; } .read-item:hover { opacity: 1; }
        .favorite-btn.favorited { color: #f59e0b !important; }

        /* Sektion Einklappen */
        .section-content { max-height: 2000px; overflow: hidden; transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding 0.5s; }
        .section-content.collapsed { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; }
        .collapse-icon { transition: transform 0.3s; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }

        /* Drag & Drop */
        .sortable-ghost { opacity: 0.4; background: var(--q-highlight); }
        .sortable-chosen { cursor: grabbing; }
        .drag-handle { cursor: grab; }

        /* Skeleton Loader */
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: var(--q-highlight); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Verbesserte Suche */
        #searchResultsContainer mark { background-color: var(--q-primary); color: var(--q-primary-text); padding: 1px 2px; border-radius: 3px; }

        /* Kontextmenü */
        #contextMenu { position: fixed; z-index: 10000; width: 200px; background-color: var(--q-surface); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); padding: 0.5rem; border: 1px solid var(--q-outline); opacity: 0; visibility: hidden; transform: scale(0.95); transition: opacity 0.1s, transform 0.1s; }
        #contextMenu.visible { opacity: 1; visibility: visible; transform: scale(1); }
        .context-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; border-radius: var(--radius-sm); cursor: pointer; }
        .context-menu-item:hover { background-color: var(--q-highlight); color: var(--q-highlight-text); }
        .context-menu-divider { height: 1px; background-color: var(--q-outline); margin: 0.5rem 0; }
    </style>
</head>
<body data-font-size="md">

    <!-- Container für die gesamte App-Struktur -->
    <div class="q-main-container">

        <!-- Sidebar Navigation -->
        <aside class="q-sidebar" id="qHubSidebar">
             <!-- Logo & Titel -->
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                    <span class="material-icons text-3xl" style="color: var(--q-primary);">hub</span>
                    <h1 class="text-2xl font-bold">QHub 2.0</h1>
                </div>
            </div>
            
            <!-- Benutzerprofil-Sektion -->
            <div id="userProfile" class="p-4 rounded-lg mb-6 text-center" style="background-color: var(--q-highlight);">
                <img id="userAvatar" src="" class="w-16 h-16 rounded-full mx-auto mb-2 cursor-pointer border-2 border-white shadow-md">
                <input type="file" id="avatarUpload" class="hidden" accept="image/*">
                <h2 id="userName" class="font-bold text-lg cursor-pointer" style="color: var(--q-highlight-text);">Gast</h2>
            </div>

            <!-- App-Liste & NEUE Module -->
            <nav class="flex-grow space-y-2" id="sidebarAppList">
                <!-- Dynamisch gefüllt: Apps, Notizen, Lesezeichen etc. -->
            </nav>
            
            <!-- Einstellungs-Menü -->
            <div class="mt-auto">
                <div class="text-xs text-gray-400 mb-4">
                    QHub v<span id="appVersionDisplay">2.1</span> &copy; 2025
                </div>
                <a href="#" id="settingsBtn" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 w-full text-left">
                    <span class="material-icons">settings</span>
                    <span>Einstellungen</span>
                </a>
            </div>
        </aside>

        <!-- Haupt-Inhaltsbereich -->
        <div class="q-content-area" id="mainContentArea">
            
            <!-- Fester Header mit Suche -->
            <header class="q-header">
                <button id="mobileMenuBtn" class="md:hidden p-2">
                    <span class="material-icons">menu</span>
                </button>
                <div class="relative w-full max-w-md">
                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input type="text" id="globalSearchInput" placeholder="Suchen in allen Modulen..." class="w-full pl-10 pr-4 py-2 rounded-full border" style="background-color: var(--q-background); border-color: var(--q-outline);">
                </div>
                <!-- NEU: Verbesserter Button für globale Filter -->
                <button id="globalFilterBtn" class="q-button q-button-secondary ml-4">
                     <span class="material-icons mr-2">filter_list</span> Filter
                </button>
                <div id="searchResultsContainer" class="absolute top-full mt-2 w-full max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10 hidden"></div>
            </header>

            <!-- Dynamische Inhalts-Sektionen -->
            <main id="sectionsContainer" class="space-y-8">
                <!-- Sektionen werden hier per JS eingefügt -->
            </main>
        </div>
    </div>

    <!-- Modals -->

    <!-- Einstellungs-Modal -->
    <div id="settingsModal" class="q-modal-backdrop">
        <div class="q-modal-content">
            <h2 class="text-2xl font-bold mb-6">Einstellungen</h2>
            <div class="space-y-6">
                <!-- Theme Auswahl -->
                <div>
                    <label class="font-semibold block mb-2">Theme</label>
                    <select id="themeSelector" class="w-full p-2 border rounded-md" style="background-color: var(--q-background); border-color: var(--q-outline);">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="forest">Forest</option>
                        <option value="ocean">Ocean</option>
                        <option value="mint">Mint</option>
                        <option value="rose">Rose</option>
                        <option value="slate-dark">Slate Dark</option>
                    </select>
                </div>
                <!-- Schriftgröße -->
                <div>
                    <label class="font-semibold block mb-2">Schriftgröße</label>
                    <select id="fontSizeSelector" class="w-full p-2 border rounded-md" style="background-color: var(--q-background); border-color: var(--q-outline);">
                        <option value="sm">Klein</option>
                        <option value="md">Mittel</option>
                        <option value="lg">Groß</option>
                    </select>
                </div>
                <!-- NEU: Layout-Auswahl -->
                <div>
                    <label class="font-semibold block mb-2">Dashboard Layout</label>
                    <select id="layoutSelector" class="w-full p-2 border rounded-md" style="background-color: var(--q-background); border-color: var(--q-outline);">
                        <option value="1">1 Spalte</option>
                        <option value="2">2 Spalten</option>
                        <option value="3">3 Spalten</option>
                    </select>
                </div>
                <!-- Daten Import/Export -->
                <div>
                    <label class="font-semibold block mb-2">Daten-Management</label>
                     <div class="flex gap-4">
                        <button id="importSettingsBtn" class="q-button q-button-secondary flex-1"><span class="material-icons">upload</span>Import</button>
                        <input type="file" id="settingsImport" class="hidden" accept=".json">
                        <button id="exportSettingsBtn" class="q-button q-button-secondary flex-1"><span class="material-icons">download</span>Export</button>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="resetSystemBtn" class="q-button q-button-danger"><span class="material-icons">dangerous</span>Reset</button>
                <button id="closeSettingsModal" class="q-button q-button-primary">Schließen</button>
            </div>
        </div>
    </div>
    
    <!-- NEU: "Was ist neu?" Modal -->
    <div id="changelogModal" class="q-modal-backdrop">
        <div class="q-modal-content">
            <h2 class="text-2xl font-bold mb-4">Willkommen zu Version 2.0!</h2>
            <p class="mb-6 text-gray-600 dark:text-gray-400">Hier sind die wichtigsten Neuerungen für dich:</p>
            <ul class="list-disc list-inside space-y-2 mb-8">
                <li><strong>Anpassbares Dashboard:</strong> Ordne die Sektionen jetzt per Drag & Drop an!</li>
                <li><strong>Mehr Übersicht:</strong> Klappe Sektionen ein, die du gerade nicht brauchst.</li>
                <li><strong>Layout-Wahl:</strong> Wähle in den Einstellungen zwischen 1, 2 oder 3 Spalten.</li>
                <li><strong>Neue Themes:</strong> Entdecke die neuen Looks "Mint", "Rose" und "Slate Dark".</li>
                <li><strong>Kontextmenüs:</strong> Klicke mit rechts auf Elemente für schnelle Aktionen.</li>
                <li><strong>Verbesserte Suche:</strong> Suchtreffer werden jetzt farblich hervorgehoben.</li>
            </ul>
             <div class="mt-6 flex justify-end">
                <button id="closeChangelogModal" class="q-button q-button-primary">Verstanden!</button>
            </div>
        </div>
    </div>

    <!-- NEU: Kontextmenü-Struktur -->
    <div id="contextMenu">
        <!-- Inhalt wird dynamisch per JS gefüllt -->
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const APP_PREFIX = 'qhub_v2.1_';
        const SETTINGS_KEY = APP_PREFIX + 'settings';
        // HINWEIS: Es gibt jetzt einen einzigen Schlüssel für alle Benutzerdaten.
        const USER_DATA_KEY = APP_PREFIX + 'user_data';

        const APP_VERSION = "2.0.0";

        // --- Standard-Daten ---
        const initialUserData = {
            version: APP_VERSION,
            apps: [
                { id: "app-1", name: "Web", url: "https://quixoticode.github.io/", icon: "web" },
                { id: "app-2", name: "QSounds", url: "https://quixoticode.github.io/app/QSounds/", icon: "graphic_eq" },
            ],
            news: [
                { id: "news-1", title: "Willkommen zum neuen QHub 2.0!", content: "Entdecke Drag & Drop, neue Themes und mehr!", date: "2025-06-19", type: "Release" },
            ],
            // HINWEIS: Hier kommen später die neuen Module (todos, notes, etc.) hin.
            todos: [],
            notes: [],
            bookmarks: []
        };
        
        const defaultSettings = {
            version: APP_VERSION,
            userName: "Gast",
            userAvatar: `https://placehold.co/96x96/e0e7ff/3730a3?text=Q`,
            theme: "light",
            fontSize: "md",
            layout: "2", // NEU: Spalten-Layout
            favorites: { apps: [], news: [], todos: [], notes: [], bookmarks: [] },
            readItems: { news: [] },
            // NEU: Einstellungen für das UI
            sectionOrder: ["news", "todos", "notes"], // Definiert die Reihenfolge der Module
            collapsedSections: [], // Speichert eingeklappte Sektionen
            lastSeenVersion: "0.0.0"
        };

        // --- State Management ---
        let settings = {};
        let userData = {};

        // --- DOM Elemente ---
        const body = document.body;
        const mainContentArea = document.getElementById('mainContentArea');
        const sectionsContainer = document.getElementById('sectionsContainer');

        // --- UI Initialisierung & Event Listener ---
        function init() {
            loadSettings();
            loadData();
            applySettings();
            renderUI();
            setupEventListeners();
            
            // NEU: Changelog-Prüfung
            checkChangelog();
        }

        // --- Daten & Einstellungs-Management ---
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                settings = storedSettings ? JSON.parse(storedSettings) : { ...defaultSettings };
                settings = { ...defaultSettings, ...settings };
            } catch (e) {
                console.error("Error loading settings, resetting to default.", e);
                settings = { ...defaultSettings };
            }
        }

        function saveSettings() {
            try {
                settings.version = APP_VERSION;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (e) {
                console.error("Error saving settings.", e);
                showToast("Fehler beim Speichern der Einstellungen.", "error");
            }
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem(USER_DATA_KEY);
                userData = storedData ? JSON.parse(storedData) : { ...initialUserData };
                 if (!storedData || !userData.version || userData.version < initialUserData.version) {
                    userData = { ...initialUserData, ...userData, version: initialUserData.version };
                    saveData();
                }
            } catch (e) {
                console.error("Error loading user data, resetting to initial.", e);
                userData = { ...initialUserData };
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
            } catch (e) {
                console.error("Error saving user data.", e);
            }
        }

        function applySettings() {
            // Theme anwenden
            document.documentElement.setAttribute('data-theme', settings.theme);
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--q-primary').trim();
            document.getElementById('themeColorMeta').content = themeColor;

            // Schriftgröße anwenden
            body.dataset.fontSize = settings.fontSize;

            // NEU: Layout anwenden
            const layoutClasses = { '1': 'grid-cols-1', '2': 'md:grid-cols-2', '3': 'lg:grid-cols-3' };
            sectionsContainer.className = `space-y-8 grid gap-6 ${layoutClasses[settings.layout] || 'md:grid-cols-2'}`;
        }

        // --- Rendering ---
        function renderUI() {
            renderUserProfile();
            renderAppList();
            renderSections();
            renderSettingsModal();
            // NEU: Drag & Drop initialisieren
            initSortable();
        }

        function renderUserProfile() {
            document.getElementById('userName').textContent = settings.userName;
            document.getElementById('userAvatar').src = settings.userAvatar;
            document.getElementById('appVersionDisplay').textContent = APP_VERSION;
        }

        function renderAppList() {
             const container = document.getElementById('sidebarAppList');
             container.innerHTML = `
                <h3 class="px-3 text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Module</h3>
                <!-- Statische Links zu Hauptmodulen -->
                <a href="#news" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span class="material-icons">feed</span><span>Nachrichten</span></a>
                <!-- Hier kommen später Links zu Todos, Notes etc. -->
                <div class="mt-4">
                     <h3 class="px-3 text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2">Meine Apps</h3>
                     ${userData.apps.map(app => `
                        <a href="${app.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span class="material-icons">${app.icon}</span>
                            <span>${app.name}</span>
                        </a>
                    `).join('')}
                </div>
            `;
        }
        
        function renderSections() {
            // NEU: Skeleton Loader anzeigen
            renderSkeletons();
            
            // Verzögert die echten Inhalte rendern
            setTimeout(() => {
                const sectionMap = {
                    news: { title: 'Nachrichten', icon: 'feed', renderer: renderNewsContent },
                    // Hier werden die neuen Module registriert
                    todos: { title: 'Aufgaben', icon: 'check_box', renderer: () => '<div class="q-card">Aufgaben-Modul demnächst hier!</div>' },
                    notes: { title: 'Notizen', icon: 'description', renderer: () => '<div class="q-card">Notiz-Modul demnächst hier!</div>' }
                };
                
                // NEU: Rendert Sektionen in der gespeicherten Reihenfolge
                sectionsContainer.innerHTML = settings.sectionOrder
                    .filter(id => sectionMap[id]) // Nur bekannte Sektionen rendern
                    .map(id => createSection(id, sectionMap[id].title, sectionMap[id].icon, sectionMap[id].renderer))
                    .join('');

            }, 250); // Kurze Verzögerung für den "Ladeeffekt"
        }
        
        // NEU: Skeleton Loader
        function renderSkeletons() {
             const skeletonCard = `
                <div class="q-card">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 rounded-full skeleton"></div>
                        <div class="ml-4 flex-1">
                            <div class="w-3/4 h-4 rounded skeleton"></div>
                            <div class="w-1/2 h-3 rounded skeleton mt-2"></div>
                        </div>
                    </div>
                    <div class="w-full h-20 rounded skeleton"></div>
                </div>`;
            sectionsContainer.innerHTML = `<section>${skeletonCard.repeat(3)}</section>`.repeat(2);
        }

        function createSection(id, title, icon, contentRenderer) {
            const isCollapsed = settings.collapsedSections.includes(id);
            return `
                <section id="section-${id}" data-section-id="${id}">
                    <div class="flex items-center justify-between mb-4">
                         <h2 class="text-2xl font-bold flex items-center gap-3">
                            <span class="material-icons text-3xl drag-handle" style="color: var(--q-primary);">${icon}</span>
                            ${title}
                        </h2>
                        <!-- NEU: Einklappen-Button -->
                        <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 collapse-btn ${isCollapsed ? 'collapsed' : ''}" data-section-id="${id}">
                             <span class="material-icons collapse-icon">expand_more</span>
                        </button>
                    </div>
                    <div class="section-content ${isCollapsed ? 'collapsed' : ''}">${contentRenderer()}</div>
                </section>
            `;
        }

        function renderNewsContent() {
            const favorites = settings.favorites.news || [];
            const readItems = settings.readItems.news || [];
            return `
                <div class="space-y-6">
                    ${userData.news.map(item => `
                        <div class="q-card ${readItems.includes(item.id) ? 'read-item' : ''}" data-item-id="${item.id}" data-item-type="news">
                             <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-semibold uppercase px-2 py-1 rounded-full" style="background-color:var(--q-highlight); color:var(--q-highlight-text);">${item.type}</span>
                                 <button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 favorite-btn ${favorites.includes(item.id) ? 'favorited' : ''}" data-type="news" data-id="${item.id}">
                                    <span class="material-icons-outlined text-xl">${favorites.includes(item.id) ? 'star' : 'star_border'}</span>
                                </button>
                            </div>
                            <h3 class="font-bold text-lg mb-2">${item.title}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${item.content}</p>
                            <div class="text-xs text-gray-400">${new Date(item.date).toLocaleDateString('de-DE')}</div>
                        </div>
                    `).join('')}
                </div>`;
        }
        
        function renderSettingsModal() {
            document.getElementById('themeSelector').value = settings.theme;
            document.getElementById('fontSizeSelector').value = settings.fontSize;
            document.getElementById('layoutSelector').value = settings.layout;
        }

        // --- NEU: Drag & Drop (SortableJS) ---
        function initSortable() {
            new Sortable(sectionsContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const newOrder = Array.from(sectionsContainer.children).map(el => el.dataset.sectionId);
                    settings.sectionOrder = newOrder;
                    saveSettings();
                    showToast("Dashboard-Layout gespeichert!");
                }
            });
        }
        
        // --- Event Handlers & Logic ---
        function setupEventListeners() {
            // Globale Klicks und Rechtsklicks
            document.addEventListener('click', handleGlobalClick);
            document.addEventListener('contextmenu', handleGlobalContextMenu);

            // Modals
            document.getElementById('settingsBtn').addEventListener('click', () => toggleModal('settingsModal', true));
            document.getElementById('closeSettingsModal').addEventListener('click', () => toggleModal('settingsModal', false));
            document.getElementById('closeChangelogModal').addEventListener('click', () => toggleModal('changelogModal', false));

            // Einstellungs-Änderungen
            document.getElementById('themeSelector').addEventListener('change', handleThemeChange);
            document.getElementById('fontSizeSelector').addEventListener('change', handleFontSizeChange);
            document.getElementById('layoutSelector').addEventListener('change', handleLayoutChange);

            // User Profil & Daten
            document.getElementById('userName').addEventListener('click', handleUserNameEdit);
            document.getElementById('userAvatar').addEventListener('click', () => document.getElementById('avatarUpload').click());
            document.getElementById('avatarUpload').addEventListener('change', handleAvatarUpload);
            document.getElementById('importSettingsBtn').addEventListener('click', () => document.getElementById('settingsImport').click());
            document.getElementById('settingsImport').addEventListener('change', handleImport);
            document.getElementById('exportSettingsBtn').addEventListener('click', handleExport);
            document.getElementById('resetSystemBtn').addEventListener('click', handleReset);
            
            // Suche
            document.getElementById('globalSearchInput').addEventListener('input', handleGlobalSearch);
        }

        function handleGlobalClick(e) {
            const target = e.target;
            
            // Schließe Kontextmenü bei Klick irgendwo anders
            const contextMenu = document.getElementById('contextMenu');
            if (!contextMenu.contains(target)) {
                contextMenu.classList.remove('visible');
            }

            // Mobile Sidebar Toggle
            if (target.closest('#mobileMenuBtn')) {
                document.getElementById('qHubSidebar').classList.toggle('open');
            }

            // Sektionen einklappen
            const collapseBtn = target.closest('.collapse-btn');
            if(collapseBtn) {
                toggleSectionCollapse(collapseBtn.dataset.sectionId);
            }

            // Gelesen-Markierung (wenn eine Karte geklickt wird)
            const card = target.closest('.q-card[data-item-id]');
            if(card && !target.closest('button')) { // Nur wenn nicht ein Button geklickt wurde
                 const { itemId, itemType } = card.dataset;
                 markAsRead(itemType, itemId);
                 card.classList.add('read-item');
            }
        }

        // --- Neue & überarbeitete Handler ---
        function handleThemeChange(e) {
            settings.theme = e.target.value;
            applySettings();
            saveSettings();
        }
        function handleFontSizeChange(e) {
            settings.fontSize = e.target.value;
            applySettings();
            saveSettings();
        }
        function handleLayoutChange(e) {
            settings.layout = e.target.value;
            applySettings();
            saveSettings();
        }
        
        function toggleSectionCollapse(sectionId) {
            const sectionContent = document.querySelector(`#section-${sectionId} .section-content`);
            const collapseBtn = document.querySelector(`.collapse-btn[data-section-id="${sectionId}"]`);
            
            if (sectionContent) {
                sectionContent.classList.toggle('collapsed');
                collapseBtn.classList.toggle('collapsed');
                
                const index = settings.collapsedSections.indexOf(sectionId);
                if (index > -1) {
                    settings.collapsedSections.splice(index, 1);
                } else {
                    settings.collapsedSections.push(sectionId);
                }
                saveSettings();
            }
        }
        
        function handleGlobalSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('searchResultsContainer');
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const highlight = (text, q) => text.replace(new RegExp(q, 'gi'), (match) => `<mark>${match}</mark>`);
            
            let html = '';
            // Nachrichtensuche
            const newsResults = userData.news.filter(item => item.title.toLowerCase().includes(query) || item.content.toLowerCase().includes(query));
            if (newsResults.length > 0) {
                html += `<h4 class="p-2 text-xs font-bold text-gray-400">NACHRICHTEN</h4>`;
                html += newsResults.map(r => `<a href="#news" class="block p-2 hover:bg-gray-100 dark:hover:bg-gray-700">${highlight(r.title, query)}</a>`).join('');
            }
            // Weitere Module hier hinzufügen
            
            if (html) {
                resultsContainer.innerHTML = html;
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-center text-sm text-gray-500">Nichts gefunden.</div>';
                resultsContainer.classList.remove('hidden');
            }
        }
        
        // --- Kontextmenü ---
        function handleGlobalContextMenu(e) {
            const card = e.target.closest('.q-card[data-item-id]');
            if (!card) return;

            e.preventDefault();
            const { itemId, itemType } = card.dataset;
            const menu = document.getElementById('contextMenu');
            
            const isFavorite = settings.favorites[itemType]?.includes(itemId);
            const isRead = settings.readItems[itemType]?.includes(itemId);

            menu.innerHTML = `
                <div class="context-menu-item" data-action="toggle-favorite" data-type="${itemType}" data-id="${itemId}">
                    <span class="material-icons-outlined">${isFavorite ? 'star' : 'star_border'}</span>
                    <span>${isFavorite ? 'Favorit entfernen' : 'Favorisieren'}</span>
                </div>
                <div class="context-menu-item" data-action="toggle-read" data-type="${itemType}" data-id="${itemId}">
                     <span class="material-icons-outlined">${isRead ? 'visibility_off' : 'visibility'}</span>
                    <span>${isRead ? 'Als ungelesen markieren' : 'Als gelesen markieren'}</span>
                </div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" data-action="share" data-type="${itemType}" data-id="${itemId}">
                    <span class="material-icons-outlined">share</span>
                    <span>Teilen</span>
                </div>
            `;
            
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.classList.add('visible');
            
            menu.onclick = handleContextMenuClick;
        }
        
        function handleContextMenuClick(e) {
            const item = e.target.closest('.context-menu-item');
            if (!item) return;

            const { action, type, id } = item.dataset;

            switch(action) {
                case 'toggle-favorite':
                    toggleFavorite(type, id);
                    break;
                case 'toggle-read':
                    toggleReadState(type, id);
                    break;
                case 'share':
                    handleShare(type, id);
                    break;
            }
            document.getElementById('contextMenu').classList.remove('visible');
            renderUI(); // Neu rendern, um Änderungen anzuzeigen
        }

        // --- Aktion-Handler ---
        function toggleFavorite(type, id) {
            if (!settings.favorites[type]) settings.favorites[type] = [];
            const index = settings.favorites[type].indexOf(id);
            if (index > -1) {
                settings.favorites[type].splice(index, 1);
            } else {
                settings.favorites[type].push(id);
            }
            saveSettings();
        }

        function toggleReadState(type, id) {
            if (!settings.readItems[type]) settings.readItems[type] = [];
            const index = settings.readItems[type].indexOf(id);
            if(index > -1) {
                settings.readItems[type].splice(index, 1);
            } else {
                settings.readItems[type].push(id);
            }
            saveSettings();
        }

        function markAsRead(type, id) {
            if (!settings.readItems[type]) settings.readItems[type] = [];
            if (!settings.readItems[type].includes(id)) {
                settings.readItems[type].push(id);
                saveSettings();
            }
        }

        async function handleShare(type, id) {
            // ... (unverändert) ...
        }

        // --- User, Import/Export etc. ---
        function handleUserNameEdit() {
            const newName = prompt("Gib deinen neuen Namen ein:", settings.userName);
            if(newName && newName.trim()) {
                settings.userName = newName.trim();
                renderUserProfile();
                saveSettings();
            }
        }
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    settings.userAvatar = event.target.result;
                    renderUserProfile();
                    saveSettings();
                };
                reader.readAsDataURL(file);
            }
        }
        function handleImport(event) {
            // ... (unverändert, importiert nur settings) ...
        }
        function handleExport() {
            // ... (unverändert, exportiert nur settings) ...
        }
        function handleReset() {
             if(confirm("Bist du sicher, dass du alle Einstellungen UND Daten von QHub 2.1 zurücksetzen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!")) {
                localStorage.removeItem(SETTINGS_KEY);
                localStorage.removeItem(USER_DATA_KEY); // Wichtig: auch die Daten löschen
                window.location.reload();
            }
        }

        // --- Hilfsfunktionen ---
        function checkChangelog() {
            if (settings.lastSeenVersion !== APP_VERSION) {
                toggleModal('changelogModal', true);
                settings.lastSeenVersion = APP_VERSION;
                saveSettings();
            }
        }

        function toggleModal(modalId, show) {
            document.getElementById(modalId).classList.toggle('visible', show);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 py-2 px-5 rounded-lg shadow-lg text-white opacity-0 transition-all duration-300';
            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? 'var(--q-danger)' : '#333';
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- App starten ---
        init();
    });
    </script>
</body>
</html>
