<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>QSounds v1.4 – RSA Encrypting & Sound Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="https://quixoticode.github.io/data/qsounds/favicon.svg" />
    
    <style>
        :root {
            --font-family-sans: 'Roboto', 'Inter', 'Segoe UI', sans-serif;
            --color-primary: #5E35B1;
            --color-primary-variant: #4527A0;
            --color-secondary: #00897B;
            --color-background: #F5F5F5;
            --color-surface: #FFFFFF;
            --color-on-primary: #FFFFFF;
            --color-on-secondary: #FFFFFF;
            --color-on-background: #212121;
            --color-on-surface: #212121;
            --color-on-surface-variant: #616161;
            --color-outline: #E0E0E0;
            --color-error: #D32F2F;
            --color-success: #388E3C;
            --elevation-1: 0 2px 4px rgba(0,0,0,0.05);
            --elevation-2: 0 4px 8px rgba(0,0,0,0.07);
            --elevation-3: 0 10px 20px rgba(0,0,0,0.08);
            --border-radius-medium: 16px;
            --border-radius-large: 28px;
            --border-radius-full: 9999px;
        }

        [data-theme="dark"] {
            --color-primary: #9575CD;
            --color-primary-variant: #7E57C2;
            --color-secondary: #26A69A;
            --color-background: #121212;
            --color-surface: #1E1E1E;
            --color-on-background: #E0E0E0;
            --color-on-surface: #E0E0E0;
            --color-on-surface-variant: #9E9E9E;
            --color-outline: #424242;
            --color-error: #EF9A9A;
            --color-success: #A5D6A7;
        }

        body { font-family: var(--font-family-sans); background-color: var(--color-background); color: var(--color-on-background); transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background-color: var(--color-surface); border-radius: var(--border-radius-medium); padding: 1.5rem 2rem; box-shadow: var(--elevation-2); transition: box-shadow 0.3s ease-in-out, transform 0.3s ease; border: 1px solid var(--color-outline); }
        .choice-button { background-color: color-mix(in srgb, var(--color-primary) 8%, transparent); border: 1px solid var(--color-outline); color: var(--color-primary); border-radius: var(--border-radius-medium); padding: 1.5rem; text-align: center; transition: all 0.2s ease; cursor: pointer; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .choice-button:hover { background-color: color-mix(in srgb, var(--color-primary) 15%, transparent); border-color: var(--color-primary); transform: translateY(-3px); box-shadow: var(--elevation-1); }
        .choice-button .material-icons-outlined { font-size: 48px; }
        
        .qs-button { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; background-color: var(--color-primary); color: var(--color-on-primary); padding: 0.75rem 1.5rem; border-radius: var(--border-radius-full); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.9rem; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: var(--elevation-1); }
        .qs-button:hover:not(:disabled) { background-color: var(--color-primary-variant); box-shadow: var(--elevation-2); }
        .qs-button:disabled { background-color: color-mix(in srgb, var(--color-on-surface) 10%, transparent); color: var(--color-on-surface-variant); cursor: not-allowed; box-shadow: none; }
        .qs-button.secondary { background-color: var(--color-secondary); color: var(--color-on-secondary); }
        .qs-button.secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--color-secondary) 80%, black); }
        
        .qs-button-text { background: none; border: none; color: var(--color-primary); cursor: pointer; padding: 0.5rem 0.75rem; border-radius: var(--border-radius-full); font-weight: 500; transition: background-color 0.2s; }
        .qs-button-text:hover:not(:disabled) { background-color: color-mix(in srgb, var(--color-primary) 15%, transparent); }
        
        .qs-textarea { background-color: var(--color-surface); color: var(--color-on-surface); border: 1px solid var(--color-outline); border-radius: var(--border-radius-medium); padding: 0.9rem 1rem; width: 100%; font-size: 1rem; line-height: 1.5; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .qs-textarea:focus { border-color: var(--color-primary); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 25%, transparent); }
        
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { background-color: var(--color-surface); color: var(--color-on-surface); padding: 1rem 1.5rem; border-radius: var(--border-radius-medium); box-shadow: var(--elevation-3); display: flex; align-items: center; gap: 1rem; transform: translateX(120%); opacity: 0; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s; border-left: 5px solid; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-color: var(--color-success); } .toast.success .material-icons-outlined { color: var(--color-success); }
        .toast.error { border-color: var(--color-error); } .toast.error .material-icons-outlined { color: var(--color-error); }
        .toast.info { border-color: var(--color-primary); } .toast.info .material-icons-outlined { color: var(--color-primary); }
        
        .wizard-status-bar { background-color: color-mix(in srgb, var(--color-primary) 10%, transparent); border-radius: var(--border-radius-medium); padding: 0.75rem 1.25rem; }
        .status-item { display: flex; align-items: center; gap: 0.5rem; color: var(--color-primary); font-weight: 500; }
        
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1040; display: none; align-items: center; justify-content: center; padding: 1rem; animation: fadeInModal 0.2s ease; }
        .modal-backdrop.visible { display: flex; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--color-surface); color: var(--color-on-surface); padding: 1.75rem; border-radius: var(--border-radius-large); box-shadow: var(--elevation-3); min-width: 320px; max-width: 95%; width: 560px; transform: scale(0.95); animation: scaleInModal 0.2s ease forwards; }
        @keyframes scaleInModal { from { transform: scale(0.95); } to { transform: scale(1); } }
        
        .stored-key-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: var(--border-radius-medium); transition: background-color 0.2s; cursor: pointer; }
        .stored-key-item:hover { background-color: color-mix(in srgb, var(--color-primary) 15%, transparent); }
        .stored-key-name { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 1rem; flex-grow: 1;}
        .progress-bar { width: 100%; background-color: var(--color-outline); border-radius: var(--border-radius-full); height: 4px; overflow: hidden; margin-top: 4px; }
        .progress-bar-inner { width: 0%; height: 100%; background-color: var(--color-primary); transition: width 0.1s linear; }
        #sound-visualizer { width: 100%; height: 80px; display: block; }
    </style>
</head>
<body>
    <main class="container mx-auto p-4 md:p-8">
        <header class="app-header text-center mb-10">
            <div class="flex items-center justify-center gap-4">
                <img src="https://quixoticode.github.io/data/qsounds/favicon.svg" class="w-12 h-12" alt="QSounds Logo">
                <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 to-teal-500 dark:from-purple-400 dark:to-teal-300 text-transparent bg-clip-text">QSounds</h1>
            </div>
            <p class="text-lg mt-2" style="color: var(--color-on-surface-variant);">Der einfache Assistent für RSA-Verschlüsselung.</p>
        </header>

        <!-- STEP 0: Initial Choice -->
        <div id="step-initial-choice" class="wizard-step active">
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-center mb-6" style="color: var(--color-primary);">Was möchtest du tun?</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div id="choice-encrypt" class="choice-button">
                        <span class="material-icons-outlined">lock</span>
                        <p class="text-xl font-bold mt-2">Verschlüsseln</p>
                        <p class="text-sm mt-1" style="color: var(--color-on-surface-variant);">Eine Nachricht sicher machen</p>
                    </div>
                    <div id="choice-decrypt" class="choice-button">
                        <span class="material-icons-outlined">lock_open</span>
                        <p class="text-xl font-bold mt-2">Entschlüsseln</p>
                        <p class="text-sm mt-1" style="color: var(--color-on-surface-variant);">Eine Nachricht lesbar machen</p>
                    </div>
                    <div id="choice-manage-keys" class="choice-button">
                        <span class="material-icons-outlined">vpn_key</span>
                        <p class="text-xl font-bold mt-2">Schlüssel verwalten</p>
                        <p class="text-sm mt-1" style="color: var(--color-on-surface-variant);">Erstellen, importieren, löschen</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STEP 1: Key Management -->
        <div id="step-key-management" class="wizard-step">
            <div class="card max-w-4xl mx-auto">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                     <h2 class="text-2xl font-bold" style="color: var(--color-primary);">Schlüsselverwaltung</h2>
                     <button id="btn-back-to-start-1" class="qs-button-text">Zurück zum Start</button>
                 </div>
                 <div class="flex flex-wrap gap-4 mb-6">
                     <button id="btn-generate-new-key" class="qs-button">Neuen Schlüssel generieren</button>
                     <button id="btn-import-key-file" class="qs-button secondary">Aus Datei importieren</button>
                 </div>
                 <div id="key-management-list-container" class="space-y-2">
                     <!-- Key list injected by JS -->
                 </div>
            </div>
        </div>

        <!-- STEP 2: Main Interface (Wizard) -->
        <div id="step-main-interface" class="wizard-step">
            <div class="card max-w-4xl mx-auto">
                <div class="wizard-status-bar mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-wrap gap-x-6 gap-y-2">
                            <div class="status-item"><span class="material-icons-outlined text-xl">label</span>Aktion: <span id="status-action" class="font-normal opacity-80"></span></div>
                            <div class="status-item"><span class="material-icons-outlined text-xl">key</span>Schlüssel: <span id="status-key" class="font-normal opacity-80"></span></div>
                            <div class="status-item"><span class="material-icons-outlined text-xl">feed</span>Eingabe: <span id="status-input" class="font-normal opacity-80"></span></div>
                        </div>
                        <button id="btn-start-over" class="qs-button-text">Von vorne beginnen</button>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div id="area-key-source">
                            <h3 class="text-xl font-bold mb-4" id="key-source-title"></h3>
                            <div class="grid grid-cols-2 gap-3" id="key-source-choices"></div>
                            <div id="key-manual-input-area" class="hidden mt-4 space-y-4">
                                <textarea id="manual-public-key" class="qs-textarea font-mono text-xs" rows="6" placeholder="Öffentlichen Schlüssel hier einfügen..."></textarea>
                                <textarea id="manual-private-key" class="qs-textarea font-mono text-xs" rows="6" placeholder="Privaten Schlüssel hier einfügen..."></textarea>
                            </div>
                        </div>
                        <div id="area-input-method" class="hidden">
                            <h3 class="text-xl font-bold mb-4">Wie möchtest du deine Nachricht eingeben?</h3>
                            <div class="grid grid-cols-2 gap-3">
                                 <button id="choice-input-text" class="choice-button !p-6"><span class="material-icons-outlined !text-4xl">edit_document</span><p class="font-bold mt-1">Als Text</p></button>
                                 <button id="choice-input-sound" class="choice-button !p-6"><span class="material-icons-outlined !text-4xl">graphic_eq</span><p class="font-bold mt-1">Per Ton</p></button>
                            </div>
                        </div>
                    </div>
                    <div id="area-data-action" class="space-y-6 hidden">
                         <div>
                            <label id="data-input-label" for="data-input-textarea" class="text-xl font-bold mb-4 block"></label>
                            <textarea id="data-input-textarea" class="qs-textarea" rows="8"></textarea>
                         </div>
                         <button id="btn-process" class="qs-button w-full text-lg !py-4"></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STEP 3: Output -->
        <div id="step-output" class="wizard-step">
            <div class="card max-w-4xl mx-auto">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold" style="color: var(--color-primary);">Ergebnis</h2>
                     <button id="btn-start-over-output" class="qs-button-text">Neue Aktion starten</button>
                 </div>
                 <textarea id="output-textarea" readonly class="qs-textarea font-mono text-sm" rows="10"></textarea>
                 <div class="flex items-center flex-wrap gap-4 mt-4">
                     <button onclick="copyToClipboard('output-textarea', 'Ergebnis')" class="qs-button">Kopieren</button>
                     <button id="btn-play-output" class="qs-button flex items-center gap-1">
                        <span class="material-icons-outlined text-base">volume_up</span><span class="button-text">Abspielen</span>
                    </button>
                    <div class="progress-bar flex-grow"><div id="progressOutput" class="progress-bar-inner"></div></div>
                 </div>
            </div>
        </div>

    </main>
    
    <div id="toast-container"></div>
    <div id="modal-container"></div>


    <script>
        // --- DOM Element Cache & Wizard State ---
        const getEl = (id) => document.getElementById(id);
        const DOMElements = {
            steps: {
                initial: getEl('step-initial-choice'),
                manageKeys: getEl('step-key-management'),
                main: getEl('step-main-interface'),
                output: getEl('step-output'),
            },
            choices: {
                encrypt: getEl('choice-encrypt'),
                decrypt: getEl('choice-decrypt'),
                manageKeys: getEl('choice-manage-keys'),
                inputText: getEl('choice-input-text'),
                inputSound: getEl('choice-input-sound'),
            },
            manageKeys: {
                listContainer: getEl('key-management-list-container'),
                btnGenerateNew: getEl('btn-generate-new-key'),
                btnImport: getEl('btn-import-key-file'),
                btnBack: getEl('btn-back-to-start-1'),
            },
            main: {
                statusAction: getEl('status-action'),
                statusKey: getEl('status-key'),
                statusInput: getEl('status-input'),
                keySourceArea: getEl('area-key-source'),
                keySourceTitle: getEl('key-source-title'),
                keySourceChoices: getEl('key-source-choices'),
                keyManualInputArea: getEl('key-manual-input-area'),
                manualPublicKey: getEl('manual-public-key'),
                manualPrivateKey: getEl('manual-private-key'),
                inputMethodArea: getEl('area-input-method'),
                dataActionArea: getEl('area-data-action'),
                dataInputLabel: getEl('data-input-label'),
                dataInputTextarea: getEl('data-input-textarea'),
                btnProcess: getEl('btn-process'),
            },
            output: {
                textarea: getEl('output-textarea'),
                btnPlay: getEl('btn-play-output'),
                progress: getEl('progressOutput'),
            },
            buttons: {
                startOver: getEl('btn-start-over'),
                startOverOutput: getEl('btn-start-over-output'),
            },
            modalContainer: getEl('modal-container'),
            toastContainer: getEl('toast-container'),
        };

        let wizardState = {};
        const initialWizardState = {
            action: null, keySource: null, inputMethod: null,
            publicKey: null, privateKey: null, keyName: null, data: null,
        };

        const STORAGE_KEYS = { STORED_KEYS: `QSounds_v1_4_Wizard_storedKeys` };
        let audioState = { context: null, isPlaying: false, microphoneStream: null, isListening: false, animationFrameId: null, playbackTimeoutId: null };

        // --- Wizard Navigation & UI ---
        function navigateToStep(stepId) {
            Object.values(DOMElements.steps).forEach(step => step.classList.remove('active'));
            getEl(stepId).classList.add('active');
        }
        
        function resetWizard() {
            wizardState = { ...initialWizardState };
            navigateToStep('step-initial-choice');
        }

        function updateMainInterface() {
            DOMElements.main.statusAction.textContent = wizardState.action === 'encrypt' ? 'Verschlüsseln' : 'Entschlüsseln';
            if (!wizardState.keySource) {
                DOMElements.main.keySourceArea.classList.remove('hidden');
                DOMElements.main.inputMethodArea.classList.add('hidden');
                DOMElements.main.dataActionArea.classList.add('hidden');
                DOMElements.main.statusKey.textContent = '...';
                DOMElements.main.statusInput.textContent = '...';
                renderKeySourceChoices();
            } else {
                DOMElements.main.keySourceArea.classList.add('hidden');
                DOMElements.main.statusKey.textContent = {
                    'new': 'Neu generiert', 'saved': `Gespeichert (${wizardState.keyName})`,
                    'manual': 'Manuell eingefügt', 'import': 'Importiert'
                }[wizardState.keySource];
            }
            if (wizardState.keySource && !wizardState.inputMethod) {
                DOMElements.main.inputMethodArea.classList.remove('hidden');
                DOMElements.main.dataActionArea.classList.add('hidden');
                 DOMElements.main.statusInput.textContent = '...';
            } else { DOMElements.main.inputMethodArea.classList.add('hidden'); }
            if (wizardState.keySource && wizardState.inputMethod) {
                DOMElements.main.dataActionArea.classList.remove('hidden');
                DOMElements.main.statusInput.textContent = wizardState.inputMethod === 'text' ? 'Text' : 'Ton';
                DOMElements.main.dataInputLabel.textContent = wizardState.action === 'encrypt' ? 'Zu verschlüsselnder Text:' : 'Zu entschlüsselnder Chiffretext:';
                DOMElements.main.btnProcess.textContent = wizardState.action === 'encrypt' ? 'Jetzt verschlüsseln' : 'Jetzt entschlüsseln';
            }
        }
        
        function renderKeySourceChoices() {
            const { keySourceChoices, keySourceTitle } = DOMElements.main;
            keySourceChoices.innerHTML = '';
            const createChoice = (id, icon, text) => {
                const choice = document.createElement('button');
                choice.id = `choice-key-${id}`;
                choice.className = 'choice-button !p-6';
                choice.innerHTML = `<span class="material-icons-outlined !text-4xl">${icon}</span><p class="font-bold mt-1">${text}</p>`;
                choice.addEventListener('click', () => handleKeySourceSelection(id));
                return choice;
            };
            if (wizardState.action === 'encrypt') {
                keySourceTitle.textContent = 'Welchen öffentlichen Schlüssel verwenden?';
                keySourceChoices.appendChild(createChoice('new', 'add_circle_outline', 'Neuen erstellen'));
                keySourceChoices.appendChild(createChoice('saved', 'inventory_2', 'Gespeicherten laden'));
                keySourceChoices.appendChild(createChoice('manual', 'keyboard', 'Manuell einfügen'));
            } else {
                keySourceTitle.textContent = 'Welchen privaten Schlüssel verwenden?';
                keySourceChoices.appendChild(createChoice('saved', 'inventory_2', 'Gespeicherten laden'));
                keySourceChoices.appendChild(createChoice('manual', 'keyboard', 'Manuell einfügen'));
            }
        }
        
        async function handleKeySourceSelection(source) {
            wizardState.keySource = source;
            const { keyManualInputArea, manualPublicKey, manualPrivateKey } = DOMElements.main;
            keyManualInputArea.classList.add('hidden');
            switch(source) {
                case 'new': generateRSAKeyPair({autoContinue: true}); break;
                case 'saved': showStoredKeysModal(); break;
                case 'manual':
                    keyManualInputArea.classList.remove('hidden');
                    manualPublicKey.style.display = wizardState.action === 'encrypt' ? 'block' : 'none';
                    manualPrivateKey.style.display = wizardState.action === 'decrypt' ? 'block' : 'none';
                    const btn = document.createElement('button');
                    btn.textContent = 'Schlüssel verwenden'; btn.className = 'qs-button mt-2';
                    btn.onclick = () => {
                        wizardState.publicKey = manualPublicKey.value;
                        wizardState.privateKey = manualPrivateKey.value;
                        if ((wizardState.action === 'encrypt' && !wizardState.publicKey) || (wizardState.action === 'decrypt' && !wizardState.privateKey)) {
                            showToast('error', 'Bitte geben Sie den erforderlichen Schlüssel ein.'); return;
                        }
                        wizardState.keyName = 'Manuell';
                        updateMainInterface();
                    };
                    keyManualInputArea.querySelector('button')?.remove();
                    keyManualInputArea.appendChild(btn);
                    break;
            }
            updateMainInterface();
        }

        function renderKeyManagementView() {
            const keys = getStoredKeys();
            const { listContainer } = DOMElements.manageKeys;
            listContainer.innerHTML = '';
            if (keys.length === 0) {
                listContainer.innerHTML = '<p class="text-center p-4" style="color: var(--color-on-surface-variant);">Keine Schlüssel gespeichert. Erstelle einen neuen oder importiere eine Datei.</p>';
                return;
            }
            keys.forEach(key => {
                const item = document.createElement('div');
                item.className = 'stored-key-item !cursor-default border border-transparent hover:border-gray-200 dark:hover:border-gray-700';
                item.innerHTML = `
                    <span class="stored-key-name flex items-center gap-2"><span class="material-icons-outlined text-gray-400">key</span>${key.name}</span>
                    <div class="flex items-center gap-2">
                        <button class="qs-button-text text-sm" data-action="export" data-key-name="${key.name}">Exportieren</button>
                        <button class="qs-button-text text-sm" data-action="qr" data-key-name="${key.name}">QR-Code</button>
                        <button class="qs-button-text !text-red-500 text-sm" data-action="delete" data-key-name="${key.name}">Löschen</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            listContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const action = target.dataset.action;
                const keyName = target.dataset.keyName;
                const key = getStoredKeys().find(k => k.name === keyName);
                if (!key) return;
                switch(action) {
                    case 'export': exportKeyPair(key); break;
                    case 'qr': showQRCode(key); break;
                    case 'delete': 
                        if (confirm(`Möchtest du das Schlüsselpaar "${keyName}" wirklich löschen?`)) {
                            deleteKeyPair(keyName);
                        }
                        break;
                }
            });
        }
        
        // --- Core Logic ---
        function processData() {
            wizardState.data = DOMElements.main.dataInputTextarea.value;
            if (!wizardState.data) { showToast('error', 'Keine Daten zur Verarbeitung eingegeben.'); return; }
            let result = null;
            try {
                if (wizardState.action === 'encrypt') {
                    const encryptor = new JSEncrypt(); encryptor.setPublicKey(wizardState.publicKey);
                    result = encryptor.encrypt(wizardState.data);
                    if (!result) throw new Error("Verschlüsselung fehlgeschlagen.");
                } else {
                    const decryptor = new JSEncrypt(); decryptor.setPrivateKey(wizardState.privateKey);
                    result = decryptor.decrypt(wizardState.data);
                    if (!result) throw new Error("Entschlüsselung fehlgeschlagen.");
                }
                DOMElements.output.textarea.value = result;
                navigateToStep('step-output');
            } catch (e) { showToast('error', e.message); }
        }

        async function generateRSAKeyPair({ autoContinue = false } = {}) {
            const name = await customPrompt({title: 'Neuer Schlüssel', message: 'Wie soll dieses Schlüsselpaar heißen?', initialValue: `Schlüssel vom ${new Date().toLocaleDateString()}`});
            if (!name) { showToast('info', 'Erstellung abgebrochen.'); return; }
            if (getStoredKeys().some(k => k.name === name)) {
                showToast('error', 'Ein Schlüssel mit diesem Namen existiert bereits.'); return;
            }
            showToast('info', 'Generiere Schlüsselpaar...');
            await new Promise(res => setTimeout(res, 50));
            const crypt = new JSEncrypt({ default_key_size: 2048 });
            const keyPair = { name, publicKey: crypt.getPublicKey(), privateKey: crypt.getPrivateKey() };
            const keys = getStoredKeys();
            keys.push(keyPair);
            saveStoredKeys(keys);
            showToast('success', `Schlüsselpaar "${name}" erstellt und gespeichert!`);
            if(autoContinue) {
                wizardState = {...wizardState, ...keyPair, keyName: name };
                updateMainInterface();
            } else {
                renderKeyManagementView();
            }
        }
        
        // --- Event Listeners ---
        function initializeListeners() {
            DOMElements.choices.encrypt.addEventListener('click', () => { wizardState.action = 'encrypt'; navigateToStep('step-main-interface'); updateMainInterface(); });
            DOMElements.choices.decrypt.addEventListener('click', () => { wizardState.action = 'decrypt'; navigateToStep('step-main-interface'); updateMainInterface(); });
            DOMElements.choices.manageKeys.addEventListener('click', () => { navigateToStep('step-key-management'); renderKeyManagementView(); });
            
            DOMElements.choices.inputText.addEventListener('click', () => { wizardState.inputMethod = 'text'; updateMainInterface(); });
            DOMElements.choices.inputSound.addEventListener('click', () => showSoundListenerModal());
            
            DOMElements.manageKeys.btnBack.addEventListener('click', resetWizard);
            DOMElements.manageKeys.btnGenerateNew.addEventListener('click', () => generateRSAKeyPair({ autoContinue: false }));
            DOMElements.manageKeys.btnImport.addEventListener('click', () => importKeyPairFile({ autoContinue: false }));
            
            DOMElements.buttons.startOver.addEventListener('click', resetWizard);
            DOMElements.buttons.startOverOutput.addEventListener('click', resetWizard);
            DOMElements.main.btnProcess.addEventListener('click', processData);
            DOMElements.output.btnPlay.addEventListener('click', () => playTextAsSound(DOMElements.output.textarea.value, DOMElements.output.btnPlay, DOMElements.output.progress));
        }
        
        // --- Modals & Helper Functions ---
        function createModal(innerHTML, onOpen = () => {}, isCancellable = true) {
            const modalId = `modal-${Date.now()}`;
            const modalHTML = `<div id="${modalId}" class="modal-backdrop">
                <div class="modal-content" onclick="event.stopPropagation()">${innerHTML}</div>
            </div>`;
            DOMElements.modalContainer.innerHTML = modalHTML;
            const modal = getEl(modalId);
            modal.classList.add('visible');
            if (isCancellable) modal.addEventListener('click', closeModal);
            onOpen(modal);
        }
        function closeModal() { DOMElements.modalContainer.innerHTML = ''; if (audioState.isListening) stopListening(); }
        function showToast(type, message, duration = 3000) { /* ... same ... */ }
        function getStoredKeys() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.STORED_KEYS) || '[]'); }
        function saveStoredKeys(keys) { localStorage.setItem(STORAGE_KEYS.STORED_KEYS, JSON.stringify(keys)); }
        function deleteKeyPair(name) { /* ... same ... */ }
        function importKeyPairFile({ autoContinue = false } = {}) { /* ... same ... */ }
        function exportKeyPair(key) { /* ... same ... */ }
        function showQRCode(key) { /* ... same ... */ }
        async function customPrompt({title, message, initialValue = ''}) { /* ... same ... */ }
        function copyToClipboard(elementId, type) { /* ... same ... */ }
        function showStoredKeysModal() {
            const keys = getStoredKeys();
            if (keys.length === 0) { showToast('error', 'Keine Schlüssel gespeichert.'); return; }
            let content = `<h2 class="text-xl font-bold mb-4">Gespeicherten Schlüssel laden</h2><div class="space-y-2 max-h-60 overflow-y-auto">`;
            keys.forEach(key => { content += `<div class="stored-key-item" data-key-name="${key.name}"><span class="stored-key-name">${key.name}</span></div>`; });
            content += `</div>`;
            createModal(content, (modal) => {
                modal.querySelectorAll('.stored-key-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const key = keys.find(k => k.name === item.dataset.keyName);
                        wizardState.publicKey = key.publicKey; wizardState.privateKey = key.privateKey;
                        wizardState.keyName = key.name; closeModal(); updateMainInterface();
                    });
                });
            });
        }

        // --- Audio Functions ---
        const CHAR_TO_FREQ_MAP = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        const BASE_FREQ = 300, FREQ_STEP = 30, NOTE_DURATION = 0.07, PAUSE_DURATION = 0.035;
        function getAudioContext() {
            if (!audioState.context || audioState.context.state === 'closed') {
                audioState.context = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioState.context;
        }
        function playTextAsSound(text, playButton, progressBar) { /* ... same ... */ }
        function stopSound(playButton, progressBar) { /* ... same ... */ }
        function updatePlayButton(button, isPlaying) { /* ... same ... */ }
        
        function showSoundListenerModal() {
            const content = `
                <h2 class="text-xl font-bold mb-4">Tonerkennung</h2>
                <p id="sound-listener-status" class="text-center mb-4" style="color: var(--color-on-surface-variant);">Mikrofon wird gestartet...</p>
                <canvas id="sound-visualizer"></canvas>
                <div class="mt-4 p-4 rounded-lg bg-black/10 min-h-[6rem] font-mono text-sm break-all" id="sound-listener-result"></div>
                <div class="flex justify-between items-center mt-6">
                    <button id="sound-listener-start" class="qs-button">Start</button>
                    <div class="flex gap-2">
                        <button id="sound-listener-accept" class="qs-button secondary" disabled>Übernehmen</button>
                        <button class="qs-button-text" onclick="closeModal()">Abbrechen</button>
                    </div>
                </div>`;
            createModal(content, (modal) => {
                const startBtn = modal.querySelector('#sound-listener-start');
                const acceptBtn = modal.querySelector('#sound-listener-accept');
                const resultEl = modal.querySelector('#sound-listener-result');
                startBtn.onclick = () => { startListening(modal); };
                acceptBtn.onclick = () => {
                    DOMElements.main.dataInputTextarea.value = resultEl.textContent;
                    wizardState.inputMethod = 'text'; // Treat sound as text input after detection
                    updateMainInterface();
                    closeModal();
                };
            }, false);
        }
        async function startListening(modal) {
            if (audioState.isListening) return;
            const context = getAudioContext();
            const statusEl = modal.querySelector('#sound-listener-status');
            const acceptBtn = modal.querySelector('#sound-listener-accept');
            const startBtn = modal.querySelector('#sound-listener-start');
            try {
                audioState.microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                audioState.isListening = true;
                statusEl.textContent = 'Höre zu...';
                startBtn.textContent = 'Läuft...';
                startBtn.disabled = true;
                acceptBtn.disabled = false;
                const source = context.createMediaStreamSource(audioState.microphoneStream);
                const analyser = context.createAnalyser();
                analyser.fftSize = 4096;
                analyser.smoothingTimeConstant = 0.5;
                source.connect(analyser);
                audioState.analyser = analyser;
                analyzeSound(modal);
            } catch (err) { statusEl.textContent = 'Mikrofon-Zugriff fehlgeschlagen.'; }
        }
        function stopListening() {
            if (audioState.microphoneStream) audioState.microphoneStream.getTracks().forEach(track => track.stop());
            if (audioState.context && audioState.context.state === 'running') audioState.context.close();
            audioState.isListening = false; audioState.microphoneStream = null;
            if (audioState.animationFrameId) cancelAnimationFrame(audioState.animationFrameId);
        }
        function analyzeSound(modal) {
            if (!audioState.isListening) return;
            const analyser = audioState.analyser;
            const resultEl = modal.querySelector('#sound-listener-result');
            const canvas = modal.querySelector('#sound-visualizer');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            drawVisualizer(canvas, dataArray, bufferLength);
            let maxVal = -1, maxIndex = -1;
            for (let i = 0; i < bufferLength; i++) {
                if (dataArray[i] > maxVal && dataArray[i] > 170) { maxVal = dataArray[i]; maxIndex = i; }
            }
            if (maxIndex !== -1) {
                const freq = maxIndex * audioState.context.sampleRate / analyser.fftSize;
                const charIndex = Math.round((freq - BASE_FREQ) / FREQ_STEP);
                if (charIndex >= 0 && charIndex < CHAR_TO_FREQ_MAP.length) {
                    const char = CHAR_TO_FREQ_MAP[charIndex];
                    if (resultEl.textContent.length === 0 || resultEl.textContent.slice(-1) !== char) {
                        resultEl.textContent += char;
                    }
                }
            }
            audioState.animationFrameId = requestAnimationFrame(() => analyzeSound(modal));
        }
        function drawVisualizer(canvas, dataArray, bufferLength) {
            const ctx = canvas.getContext('2d');
            const WIDTH = canvas.width, HEIGHT = canvas.height;
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            ctx.lineWidth = 2; ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
            ctx.beginPath(); let sliceWidth = WIDTH * 1.0 / bufferLength, x = 0;
            for (let i = 0; i < bufferLength; i++) {
                let v = dataArray[i] / 128.0, y = v * HEIGHT / 2;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => { resetWizard(); initializeListeners(); });
    </script>
</body>
</html>
